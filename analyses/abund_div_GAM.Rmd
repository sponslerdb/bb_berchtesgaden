---
title: "Abundance/diversity GAM"
output: html_document
---

### Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidyverse)
library(lubridate)
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")), # rename in English
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low")))
```

### Load network and survey data
```{r}
### BB-FL visitation data
net <- read_csv("../processed_data/network.csv") %>%
  dplyr::select(site, date, bb.sp, plant.sp) # drop unused columns

### Floral survey data
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only visited plant species (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

### Identify duplicate observations; these may be errors or intentionally duplicated (see correspondence with Kalli)
survey_dups <- survey %>%
  group_by(site, date, plant.sp) %>%
  mutate(dups = n()) %>%
  filter(dups > 1)

### Shared transects
shared_transects <- inner_join(net, survey, by = c("site", "date")) %>%
  dplyr::select(site, date) %>%
  unique() 
```

### FL and BB abundance / diversity
```{r echo=FALSE, include=TRUE}
# Per-transect BB abundance
## full dataset
bb_abund_sp <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  group_by(site, date, bb.sp) %>% # 
  summarize(bb.abund = n()) %>% # get per transect bb abundance
  ungroup() %>%
  complete(site, date, bb.sp, fill = list(bb.abund = 0)) %>% # complete implicit absences
  semi_join(net, by = c("site", "date")) %>% # drop site-dates that did not exist in the data set
  left_join(site_data) %>% # add site data
  mutate(year = factor(year(date)),
         yday = yday(date),
         bb.sp = factor(bb.sp),
         management = factor(management),
         site = factor(site),
         transect = factor(transect)) %>%
  group_by(year, bb.sp) %>%
  mutate(bb.total.abund = sum(bb.abund))

## filtered to include only samples with corresponding floral survey data
bb_abund_sp.sub <- bb_abund_sp %>%
  semi_join(shared_transects)

### Per-transect floral abund: by species
fl_abund_sp <- survey %>%
  group_by(site, date, plant.sp) %>% # group by plant.sp*transect
  summarize(fl.abund = sum(flower.cover)) %>% # get plant.sp*transect total flower cover; this step really shouldn't be required, but in a few cases, there is more than one abundance entry for the same species on a given transect; not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, I could drop the dups or average them. We'll see what Kalli and Fabrice have to say.
  group_by(site, date) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund)) %>% # get the proportional flower cover for each species.
  ungroup() %>%
  full_join(dplyr::select(net, site, date, plant.sp), by = c("site", "date", "plant.sp")) %>% # add the handful of species occurring in the visitation network but missing from the survey data
  complete(site, date, plant.sp, fill = list(fl.abund = 0, prop.fl.abund = 0)) %>%
  semi_join(survey, by = c("site", "date")) %>%  # only include site-dates that actually occurred
  unique() %>%
  mutate(year = factor(year(date)))
```

### Preference analysis
```{r}
observed_visits <- net %>%
  semi_join(shared_transects) %>% # include only site*date combos where floral surveying was done
  group_by(site, date, bb.sp, plant.sp) %>% # group by bb*plant*transect
  summarize(visits = n()) %>% # total visits per bb-fl pair
  group_by(site, date, bb.sp) %>%
  mutate(prop.visits = visits/sum(visits))

# All possible bumble-plant pairings *site * date, filtered to include only those when the given bb.sp was present and the given plant.sp was *either* present *or* visited (see note below)
visitation_by_abundance <- fl_abund_sp %>%
  inner_join(bb_abund_sp.sub) %>%
  filter(bb.abund > 0) %>%
  filter(fl.abund > 0) %>% 
  left_join(observed_visits) %>%
  #filter(fl.abund > 0 | visits > 0) %>% # In about 10% of the bb.sp*plant.sp*site*year combos, the visited plant was not recorded in the floral survey data. There are a few different ways we could handle this, but I think an argument could be make that treating those plants as if they had zero abundance (even though they were evidently present gets close to the truth, since they must have been rather rare to have been missed in the surveying.)
  replace_na(list(visits = 0, prop.visits = 0))

### Get mean abundance/visitation for each plant*bb combo
visitation_by_abundance_mean <- visitation_by_abundance %>%
  mutate(year = factor(year(date))) %>%
  group_by(plant.sp, bb.sp) %>%
  summarize(prop.fl.abund.m = mean(prop.fl.abund),
            prop.visits.wm = weighted.mean(prop.visits, bb.abund))

# Visualize
ggplot(filter(visitation_by_abundance_mean, prop.visits.wm > 0), 
       aes(log(prop.fl.abund.m + 0.01), log(prop.visits.wm))) +
  geom_point(alpha = 0.5, aes(color = bb.sp)) +
  geom_smooth(method = "lm")

ggplot(filter(visitation_by_abundance_mean), 
       aes(prop.fl.abund.m, prop.visits.wm)) +
  geom_point(alpha = 0.5, aes(color = bb.sp)) +
  geom_smooth(method = "lm")

### Okay, here's what we're going to do. Preference has a strong bimodal pattern, with lots of plant species totally ignored while the ones that are foraged upon are visited in proportion to their abundance. We can't model that latter pattern well if we retain all the totally ignored plant species. So, let's model the visited plants separately from the unvisited ones.

### Call linear model on the subset of the floral species that were visited at least once
# log on log regression is common for proportional datam (log ratio regression)
pref.lm <- lm(log(prop.visits.wm) ~ log(prop.fl.abund.m + 0.01), 
              data = filter(visitation_by_abundance_mean, prop.visits.wm > 0))
summary(pref.lm)
plot(pref.lm)

### Extract residuals
pref.lm.resid <- residuals(pref.lm) %>%
  data.frame() %>%
  as_tibble() %>%
  rename(preference = 1)

#################################
### Build preference data set ###
#################################

# Start with the mean prop.fl.abund and weighted mean prop.visits
preference <- visitation_by_abundance_mean %>%  
  ungroup() %>%

# Remove bb*fl*year combos that had 0 visits
  filter(prop.visits.wm > 0) %>% 
  
# With the zeroes removed, what's left can be joined 1:1 with the 
# residuals of the model above, i.e. the raw preference data
  bind_cols(pref.lm.resid) %>% 
  
# Exponentiate the residuals to back-transform the data and ensure 
# that preference is > 0 for all visited plant species.
  mutate(preference = exp(preference)) %>% 
  
# Now we need to add back all the bb*fl*year combos that had 0 visits
# Then we have NAs for preference and floral abundance columns
  full_join(unique(dplyr::select(visitation_by_abundance_mean, bb.sp, plant.sp))) %>%
  
# Replace the NAs of the preference column with 0s; 
  replace_na(list(preference = 0)) %>%

# Drop the columns used to calculate preference so that they don't confuse us when we add site-date level abundance data
  dplyr::select(bb.sp, plant.sp, preference)
  
write_csv(preference, "../analyses/output/preference.csv")

#################################
### Join with FL and BB abund ###
#################################

# For bb-fl combos that never co-occurred, set preference = 1
pref_forbidden_link_fill <- inner_join(fl_abund_sp, bb_abund_sp.sub) %>%
  mutate(co = case_when(
    fl.abund == 0 | bb.abund == 0 ~ 0,
    fl.abund != 0 & bb.abund != 0 ~ 1)
  ) %>%
  group_by(plant.sp, bb.sp) %>%
  summarize(co.max = max(co)) %>%
  filter(co.max == 0) %>%
  mutate(preference.update = rep(1, n())) %>%
  dplyr::select(-co.max) %>%
  inner_join(fl_abund_sp) %>%
  select(-year)

fl_abund_wt <- fl_abund_sp %>%
  select(-year) %>%
  left_join(preference) %>% 
  
# Add the forbidden links with preference set to 1 (neutral)
  full_join(pref_forbidden_link_fill) %>%
  mutate(preference = case_when(
    is.na(preference) ~ preference.update,
    !is.na(preference) ~ preference)
    ) %>%
  dplyr::select(-preference.update) %>%
  mutate(fl.abund.wt = fl.abund*preference) %>%
  mutate(yday = yday(date)) %>%
  group_by(site, date, yday, bb.sp) %>%
  summarize(fl.abund.wt = sum(fl.abund.wt, na.rm = TRUE)) %>%
  ungroup() %>%
  semi_join(survey, by = c("site", "date")) %>% # This gets rid of site*date combos that don't exist
  left_join(site_data, by = "site") %>%
  mutate(year = factor(year(date)), # add in the years missing from the bb_abund join
         bb.sp = factor(bb.sp), # convert bb.sp to a factor
         management = factor(management),
         site = factor(site),
         transect = factor(transect)) %>%
  group_by(year) %>%
  mutate(total.transects.year = n()) %>%
  ungroup()

write_csv(fl_abund_wt, "../analyses/output/fl_abund_wt.csv")
```

### Call GAMs
##### My argument for not including site as a random effect is that it would create identifiability issues with the elevation variable that I am actally interested in. This will probably cause the p-values to be underestimated, maybe to the point of being uninformative. But I don't think I care. My goal is not to establish inferentially that time and elevation affect BB abundance; I want to say how they do. And I don't want to obscure the "how" for the sake of inferential scruples.
#### Floral resources
```{r}
### 2010
weighted_fl_abundance.2010 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      #s(site, bs = "re") +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(8, 8), 
                                                m=2),
                                    data = filter(fl_abund_wt, year == 2010),
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2010)
#weighted_fl_abundance.2010.sum <- summary(weighted_fl_abundance.2010)
#print(plot(weighted_fl_abundance.2010, allTerms = TRUE), pages = 4)
weighted_fl_abundance.2010.ck <- check2D(weighted_fl_abundance.2010, 
                                         x1 = "yday", x2 = "elev.mean")

### 2011
weighted_fl_abundance.2011 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      #s(site, bs = "re") +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(8, 8), 
                                                m=2),
                                    data = filter(fl_abund_wt, year == 2011),
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2011)
#weighted_fl_abundance.2011.sum <- summary(weighted_fl_abundance.2011)
#print(plot(weighted_fl_abundance.2011, allTerms = TRUE), pages = 4)
weighted_fl_abundance.2011.ck <- check2D(weighted_fl_abundance.2011, 
                                         x1 = "yday", x2 = "elev.mean")

### 2012
weighted_fl_abundance.2012 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      #s(site, bs = "re") +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(8, 8), 
                                                m=2),
                                    data = filter(fl_abund_wt, year == 2012),
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2012)
#weighted_fl_abundance.2012.sum <- summary(weighted_fl_abundance.2012)
#print(plot(weighted_fl_abundance.2012, allTerms = TRUE), pages = 4)
weighted_fl_abundance.2012.ck <- check2D(weighted_fl_abundance.2012, 
                                         x1 = "yday", x2 = "elev.mean")
```

#### Bumbles
```{r}
### 2010
bb_abund.2010 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2010 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2010)
#bb_abund.2010.sum <- summary(bb_abund.2010)
#print(plot(bb_abund.2010, allTerms = TRUE), pages = 1)
bb_abund.2010.ck <- check2D(bb_abund.2010, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals

### 2011
bb_abund.2011 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2011 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2011)
#bb_abund.2011.sum <- summary(bb_abund.2011)
#print(plot(bb_abund.2011, allTerms = TRUE), pages = 1)
bb_abund.2011.ck <- check2D(bb_abund.2011, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals

### 2012
bb_abund.2012 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2012 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2012)
#bb_abund.2012.sum <- summary(bb_abund.2012)
#print(plot(bb_abund.2012, allTerms = TRUE), pages = 1)
bb_abund.2012.ck <- check2D(bb_abund.2012, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals
```

### Extract predictions
```{r}
# Function to build data set over which to generate predictions
newdata_build <- function(dat, y) {
  
  ## yday min/max
  min_yday <- min(filter(dat, year == y)$yday)
  max_yday <- max(filter(dat, year == y)$yday)
  
  ## elev min.max
  min_elev <- min(filter(dat, year == y)$elev.mean)
  max_elev <- max(filter(dat, year == y)$elev.mean)
  
  ## species list
  spp <- dat %>%
    filter(year == y) %>%
    select(bb.sp) %>%
    unique() %>%
    na.omit() ##### NEED TO FIGURE OUT WHERE THE NA COMES FROM!
  
  # sequence of 50 points along the yday and elev ranges, respectively
  seq_yday <- seq(min_yday, max_yday, length.out = 50)
  seq_elev <- seq(min_elev, max_elev, length.out = 50)
  
  newdata <- tibble(seq_yday, seq_elev) %>% # combine seqs into data frame
    complete(seq_yday, seq_elev) %>% # get all possible values
    crossing(spp) %>% # get all possible combos with species
    select(yday = seq_yday, elev.mean = seq_elev, bb.sp) # rename columns to match the original model inputs
}

newdata2010.FL <- newdata_build(fl_abund_wt, 2010)
newdata2011.FL <- newdata_build(fl_abund_wt, 2011)
newdata2012.FL <- newdata_build(fl_abund_wt, 2012)

newdata2010.BB <- newdata_build(filter(bb_abund_sp, bb.total.abund >= 5), 2010)
newdata2011.BB <- newdata_build(filter(bb_abund_sp, bb.total.abund >= 5), 2011)
newdata2012.BB <- newdata_build(filter(bb_abund_sp, bb.total.abund >= 5), 2012)

# A little wrapper to make predictions and return a tibble with desired columns 
predict_func <- function(mod, new, y) {
  predict.bam(mod, newdata = new, type = "response") %>%
    data.frame() %>%
    tibble() %>%
    bind_cols(new) %>%
    select(yday, elev.mean, bb.sp, pred = 1) %>%
    mutate(year = rep(y, n()))
}

# Generate predictions
predict2010.FL <- predict_func(weighted_fl_abundance.2010, newdata2010.FL, 2010)
predict2011.FL <- predict_func(weighted_fl_abundance.2011, newdata2011.FL, 2011)
predict2012.FL <- predict_func(weighted_fl_abundance.2012, newdata2012.FL, 2012)
predict_pool.FL <- bind_rows(predict2010.FL, predict2011.FL, predict2012.FL)

predict2010.BB <- predict_func(bb_abund.2010, newdata2010.BB, 2010)
predict2011.BB <- predict_func(bb_abund.2011, newdata2011.BB, 2011)
predict2012.BB <- predict_func(bb_abund.2012, newdata2012.BB, 2012)
predict_pool.BB <- bind_rows(predict2010.BB, predict2011.BB, predict2012.BB)

# Subset predictions
predict_major.FL <- filter(predict_pool.FL, bb.sp %in% c("bss", "pasc", "prat", "soro", "wurf"))
predict_highelev.FL <- filter(predict_pool.FL, bb.sp %in% c("pyre", "mend", "mont"))
predict_minor.FL <- filter(predict_pool.FL, bb.sp %in% c("gers", "hort", "hypn","jone", "lapi", "muci"))

predict_major.BB <- filter(predict_pool.BB, bb.sp %in% c("bss", "pasc", "prat", "soro", "wurf"))
predict_highelev.BB <- filter(predict_pool.BB, bb.sp %in% c("pyre", "mend", "mont"))
predict_minor.BB <- filter(predict_pool.BB, bb.sp %in% c("gers", "hort", "hypn","jone", "lapi", "muci"))
```

### Visualize
```{r}
ggplot(predict_major.FL, aes(yday, elev.mean, fill = pred)) +
  geom_raster() +
  geom_contour(aes(z = pred), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_highelev.FL, aes(yday, elev.mean, fill = pred)) +
  geom_raster() +
  geom_contour(aes(z = pred), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_minor.FL, aes(yday, elev.mean, fill = pred)) +
  geom_raster() +
  geom_contour(aes(z = pred), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

# Plot
ggplot(predict_major.BB, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_highelev.BB, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_minor.BB, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25, binwidth = 1) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)
```