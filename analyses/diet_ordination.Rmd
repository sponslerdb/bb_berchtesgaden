---
title: "ordination"
author: "Doug Sponsler"
date: "12/4/2020"
output: html_document
---

# Load packages
```{r}
library(vegan)
library(ggvegan)
library(ggrepel)
library(treemapify)
library(tidyverse)
library(lubridate)
library(patchwork)
library(tidymodels)
```

## Load data
```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
# Site data
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class2 = factor(elev.class2, levels = c("low", "mid", "high"))) # turn elav.class into an ordered factor

# BB traits
bb_traits <- read_csv("../processed_data/bb_traits.csv") 

# FL traits
## family-level taxonomy
fl_tax <- read_csv("../processed_data/floral_tax.csv") 

## Kugler morphotypes (accessed through Bioflor)
fl_ktype <- read_csv("../processed_data/floral_k_type.csv") 

## Flower colors (accessed through BioFlor)
fl_color <- read_csv("../processed_data/floral_color.csv")

## diameter and corolla depth data from Gita Benadi
fl_morph <- read_csv("../processed_data/flower_morphology_GitaBenadi.csv") %>% 
  dplyr::select(SampleID, plant.family = Family, plant.sp = Species, 
                Unit, Flowers_per_unit, diam = Diameter, LN) %>%
  group_by(plant.sp) %>%
  summarize(diam = mean(diam), LN = mean(LN))

## verbal description of Kugler morphotypes
fl_ktype_key <- read_delim("../processed_data/kugler_key.tsv", delim = "\t", col_names = FALSE) %>%
  dplyr::select(k.type = 1, description = 2)

## join all floral trait tables
fl_traits <- fl_tax %>%
  full_join(fl_ktype) %>%
  full_join(fl_color) %>%
  full_join(fl_morph) %>%
  dplyr::select(plant.sp, plant.genus, plant.family, k.type, k.type.s, k.type.ss, color, diam, LN)

# Network
net <- read_csv("../processed_data/network.csv") %>%
  mutate(year = factor(year)) %>% # convert year to factor
  left_join(site_data, by = "site") %>% # add site data
  ungroup() %>%
  arrange(site, date) %>%
  left_join(fl_traits) %>% # add floral traits
  #group_by(site) %>%
  group_by(elev.class2) %>%
  mutate(period = cut_interval(dayofyear, 3, labels = c("early",  "mid", "late"))) %>% # divide each elev.class2 into 4 equal time slices
  mutate(k.type.s = as.character(k.type.s), # these can't be factors or else complete() will try to preserve all their levels for each group, even the levels that do not occur
         k.type.ss = as.character(k.type.ss))

# Floral survey
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  filter(flower.cover > 0) %>% # only count plants in bloom
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover) %>%
  left_join(fl_traits) # add floral traits
```

# Define sample parsing
We will parse the samples by elevation class and season, dividing the samples from each elevation class into equal-interval thirds
```{r}
samples <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>% # focal species
  group_by(elev.class2) %>%
  #group_by(site) %>%
  mutate(period = cut_interval(dayofyear, 3, labels = c("early",  "mid", "late"))) %>%
  group_by(site, period, dayofyear) %>%
  summarize(obs = n()) %>%
  left_join(site_data) %>%
  mutate(date = as_date(dayofyear))

ggplot(samples, aes(as_date(yday(date)), elev.mean, color = period)) +
  geom_point(size = 2, aes(alpha = obs)) +
  #geom_point(size = 2, alpha = 0.75) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_alpha_continuous(name = "Observations") +
  scale_x_date(date_labels = "%b", breaks = as_date(c("1970-04-01", "1970-05-01", "1970-06-01",
                                                    "1970-07-01", "1970-08-01", "1970-09-01"))) +
  geom_hline(yintercept = c(900, 1500), linetype = "dashed") +
  theme_light(12) +
  labs(x = "Time",
       y = "Elevation (m x 10)") 
```

# Define functions
```{r}
# Plot ordisurf
## Based on https://oliviarata.wordpress.com/2014/07/17/ordinations-in-ggplot2-v2-ordisurf/
surfplot <- function(x, y, min_score = 0.2) {
  
  grid <- x$grid # extracts the ordisurf object
  grid_exp <- expand.grid(x = grid$x, y = grid$y) # get x and ys
  grid_exp$z <- as.vector(grid$z) # unravel the matrix for the z scores
  
  contours <- data.frame(na.omit(grid_exp)) %>% # gets rid of the nas
    as_tibble() %>%
    rename(MDS1 = x, MDS2 = y)
  
  scores <- y %>% 
    filter((abs(MDS1) > min_score | abs(MDS2) > min_score) | Score == "BB.sp") %>%
    mutate(max.score = max(MDS1, MDS2))
  
  ggplot(scores, aes(MDS1, MDS2, pch = Score)) +
    geom_contour(data = contours, 
                 aes(MDS1, MDS2, z = z, color = stat(level)),
                 size = 1.5, alpha = 0.75, inherit.aes = FALSE) +
    geom_point(size = 2) +
    geom_text_repel(aes(MDS1, MDS2, label = Label), key_glyph = "rect") +
    #geom_text(aes(MDS1, MDS2, label = Label, alpha = max.score), key_glyph = "rect") +
    theme_light() +
    scale_color_viridis_c(name = "Tongue length") +
    scale_shape_manual(values = c(16, 1), name = "Level") +
    coord_fixed() # Gavin Simpson says this is **really** important
}


# Fortify PCOA and add the results of an envfit() to BB tongue length
pcoa_fort <- function(x){
  fortify(x, axes = 1:2) %>%
  mutate(Score = case_when(
    Score == "species" ~ "FL.sp",
    Score == "sites" ~ "BB.sp"))
}

# Plot PCoA; to avoid overplotting, scores < min_score are not plotted
pcoa_plot <- function(x, min_score = 0.25) {
  
  # # Add T.class variable for the BB.sp subset of the PCoA
  # t.class <- x %>%
  #   filter(Score == "BB sp.") %>%
  #   mutate(T.class = factor(if_else(
  #     Label %in% c("hort", "pasc", "wurf", "gers", "mend", "hypn"), "long", "short"))
  #     )
  
  # ggplot(filter(x, (abs(MDS1) > min_score | abs(MDS2) > min_score) | (Score == "BB.sp")), 
  #        aes(MDS1, MDS2, color = Score)) + # no threshold for BB spp
  ggplot(x, aes(MDS1, MDS2, color = Score)) +
    #geom_polygon(data = t.class, aes(MDS1, MDS2, linetype = T.class), # draw polygons around T classes
     #            color = "gray70", fill = NA, size = 1.25, key_glyph = "abline") +
    geom_point(size = 2, alpha = 0.75) + # add points
    ggrepel::geom_text_repel(aes(label = Label), key_glyph = "rect", size = 3) + # add labels
    coord_fixed() + # Gavin Simpson says this is **really** important
    theme_classic() +
    theme(legend.title=element_blank())
}

    
# Generates PCoAs, ordisurfs, ADONIS tests, and ordination plots 
## The ... represents the variables we will use to parse our analysis. For aggregate analysis, just leave the ...
## unpopulated, e.g. niche_analysis(net, bb_traits, plant.sp). 
## To parse by elev.class2: niche_analysis(net, bb_traits, plant.sp)
## To parse by  elev.class2, period, and pollen: niche_analysis(net, bb_traits, plant.sp, period, pollen)
## You get the idea. You should anyway -- you wrote it. https://tidyeval.tidyverse.org/multiple.html
niche_analysis <- function(x, y, criterion, k, ...) { 
  
  criterion <- enquo(criterion) # this argument toggles taxonomic (plant.sp) vs. morphological (k.type.s) analysis

  x %>%
    filter(caste != "male") %>% # exclude males
    filter(!bb.sp %in% c("gers", "humi")) %>% # exclude gers because it's a specialist, humi because it's so rare
    group_by(site, date, bb.sp, !!criterion, ...) %>% 
    summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
    group_by(site, date, ...) %>%
    complete(bb.sp, !!criterion, fill = list(freq = 0)) %>% # fill in zeros for unvisited plants
    group_by(site, date, bb.sp) %>%
    mutate(prop = freq/sum(freq)) %>% # get proportional interaction frequency for each BB-FL pair per site-date 
    group_by(..., bb.sp, !!criterion) %>%
    summarize(prop = mean(prop)) %>% # get mean proportional intneraction frequency aggregated by ...
    group_by(...) %>%
    nest() %>% # nest into list-column
    mutate(comm1 = map(data, # spread into the kind of array vegan likes
                       function(x) pivot_wider(x, names_from = !!criterion, values_from = prop) %>%
                         replace(is.na(.), 0)
                       ), 
           comm2 = map(comm1, # column to rowname
                       function(x) column_to_rownames(x, var = "bb.sp")
           ),
           pcoa = map(comm2, # call PCoA
                      function(x) capscale(x ~ 1, distance = "horn")
                      ),
           traits = map(comm1, # join BB traits
                        function(x) x %>% 
                          left_join(y) %>% # y is the trait table, an argument in the main function call
                          column_to_rownames(var = "bb.sp") %>% 
                          select(pbl.w) # pbl.w is the variable I'm interested in
                        ),
           adonis = map2(comm2, traits, # run adonis permuatation test for distance ~ tongue class
                         function(x, y) adonis(x ~ pbl.w, data = y, method = "horn")
                         ),
           pcoa.fort = map(pcoa, pcoa_fort),
           pcoa.plot = map(pcoa.fort, pcoa_plot),
           adonis.r2 = map(adonis, # extract adonis r2
                           function(x) x$aov.tab$R2[[1]]
                           ),
           adonis.p = map(adonis, # extract adonis p-value
                          function(x) x$aov.tab$'Pr(>F)'[[1]]
                          ),
           ordisurf = map2(pcoa, traits, function(x, y) ordisurf(x ~ pbl.w, data = y, k = k)),
           ordisurf.dev_exp = map(ordisurf, function(x) summary(x)$dev.expl),
           ordisurf.p = map(ordisurf, function(x) summary(x)$s.pv),
           ordisurf.plot = map2(ordisurf, pcoa.fort, surfplot),
           var.exp.MDS1 = map(pcoa, # extract variance explained by MDS1
                      function(x) x$CA$eig[[1]] / sum(x$CA$eig)
                      ), 
           var.exp.MDS2 = map(pcoa, # extract variance explained by MDS2
                      function(x) x$CA$eig[[2]] / sum(x$CA$eig)
                      )) %>%
    unnest(cols = c(ordisurf.dev_exp, ordisurf.p, adonis.r2, 
                    adonis.p, var.exp.MDS1, var.exp.MDS2)) %>% # these are lists of length = 1, so unnesting them simply displays the value
    mutate(var.exp.MDS1_MDS2 = var.exp.MDS1 + var.exp.MDS2) %>%
    select(..., pcoa, pcoa.plot, var.exp.MDS1_MDS2, var.exp.MDS1, var.exp.MDS2, 
            ordisurf.dev_exp, ordisurf.p, adonis.r2, adonis.p,
            ordisurf, ordisurf.plot, adonis, comm2, traits, pcoa.fort)
}
```

# 1.1 Ordination by species with post-hoc fitting of tongue length  
```{r message=FALSE, warning=FALSE, echo = FALSE}
# By plant.sp
niche.tax <- niche_analysis(net, bb_traits, criterion = plant.sp.abb, k = 8)
niche.tax.plot <- niche.tax$ordisurf.plot[[1]]

# By ktype
niche.morph <- niche_analysis(net, bb_traits, criterion = k.type.ss, k = 8)
niche.morph.plot <- niche.morph$ordisurf.plot[[1]]

# By color
niche.color <- niche_analysis(net, bb_traits, criterion = color, k = 8)
niche.color.plot <- niche.color$pcoa.plot[[1]]

## Taxonomic and morphological together
pdf("../analyses/output/niche_pcoa.pdf", height = 8.5, width = 11)
(niche.tax.plot + ggtitle("Taxonomic") | niche.morph.plot + ggtitle("Morphological")) + plot_layout(guides = 'keep') 
dev.off()
```

# 1.2 Ordination by species with post-hoc fitting of tongue length, broken down by elevation class
```{r message=FALSE, warning=FALSE, echo = FALSE}
# Taxonomic
niche_x_elev.tax <- niche_analysis(net, bb_traits, criterion = plant.sp.abb, k = 8, elev.class2)

## Extract and name plots
niche_high.tax.plot <- filter(niche_x_elev.tax, elev.class2 == "high")$ordisurf.plot[[1]] + ggtitle("high/Tax")
niche_mid.tax.plot <- filter(niche_x_elev.tax, elev.class2 == "mid")$ordisurf.plot[[1]] + ggtitle("mid/Tax")
niche_low.tax.plot <- filter(niche_x_elev.tax, elev.class2 == "low")$ordisurf.plot[[1]] + ggtitle("low/Tax")

# Morphological
niche_x_elev.morph <- niche_analysis(net, bb_traits, criterion = k.type.ss, k = 8, elev.class2)

## Extract and name plots
niche_high.morph.plot <- filter(niche_x_elev.morph, elev.class2 == "high")$ordisurf.plot[[1]] + ggtitle("high/morph")
niche_mid.morph.plot <- filter(niche_x_elev.morph, elev.class2 == "mid")$ordisurf.plot[[1]] + ggtitle("mid/morph")
niche_low.morph.plot <- filter(niche_x_elev.morph, elev.class2 == "low")$ordisurf.plot[[1]] + ggtitle("low/morph")

# Color
niche_x_elev.color <- niche_analysis(net, bb_traits, criterion = color, k = 8, elev.class2)

## Extract and name plots
niche_high.color.plot <- filter(niche_x_elev.color, elev.class2 == "high")$pcoa.plot[[1]] + ggtitle("high/color")
niche_mid.color.plot <- filter(niche_x_elev.color, elev.class2 == "mid")$pcoa.plot[[1]] + ggtitle("mid/color")
niche_low.color.plot <- filter(niche_x_elev.color, elev.class2 == "low")$pcoa.plot[[1]] + ggtitle("low/color")

## Display plots on grid
pdf("../analyses/output/niche_x_elev_pcoa.pdf", height = 8.5, width = 11)
(niche_high.tax.plot | niche_high.morph.plot) /
(niche_mid.tax.plot | niche_mid.morph.plot) /
(niche_low.tax.plot | niche_low.morph.plot) + plot_layout(guides = 'keep') 
dev.off()
```

# 1.3 Ordination by BB species * elev.class2 * period, pooling across years
```{r message=FALSE, warning=FALSE, echo = FALSE}
# Taxonomic
niche_x_elevperiod.tax <- niche_analysis(net, bb_traits, criterion = plant.sp.abb, k = 7, elev.class2, period)

## Extract and name plots
niche_high_early.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "high" & period == "early")$ordisurf.plot[[1]] 
niche_high_mid.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "high" & period == "mid")$ordisurf.plot[[1]]
niche_high_late.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "high" & period == "late")$ordisurf.plot[[1]]

niche_mid_early.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "mid" & period == "early")$ordisurf.plot[[1]]
niche_mid_mid.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "mid" & period == "mid")$ordisurf.plot[[1]]
niche_mid_late.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "mid" & period == "late")$ordisurf.plot[[1]]

niche_low_early.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "low" & period == "early")$ordisurf.plot[[1]]
niche_low_mid.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "low" & period == "mid")$ordisurf.plot[[1]]
niche_low_late.tax.plot <- filter(niche_x_elevperiod.tax, elev.class2 == "low" & period == "late")$ordisurf.plot[[1]]

# Morphological
niche_x_elevperiod.morph <- niche_analysis(net, bb_traits, criterion = k.type.ss, k = 7, elev.class2, period)

## Extract and name plots
niche_high_early.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "high" & period == "early")$ordisurf.plot[[1]]
niche_high_mid.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "high" & period == "mid")$ordisurf.plot[[1]] 
niche_high_late.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "high" & period == "late")$ordisurf.plot[[1]] 

niche_mid_early.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "mid" & period == "early")$ordisurf.plot[[1]]
niche_mid_mid.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "mid" & period == "mid")$ordisurf.plot[[1]] 
niche_mid_late.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "mid" & period == "late")$ordisurf.plot[[1]] 

niche_low_early.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "low" & period == "early")$ordisurf.plot[[1]]
niche_low_mid.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "low" & period == "mid")$ordisurf.plot[[1]] 
niche_low_late.morph.plot <- filter(niche_x_elevperiod.morph, elev.class2 == "low" & period == "late")$ordisurf.plot[[1]] 

# Color
niche_x_elevperiod.color <- niche_analysis(net, bb_traits, criterion = color, k = 7, elev.class2, period)

## Extract and name plots
niche_high_early.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "high" & period == "early")$pcoa.plot[[1]]
niche_high_mid.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "high" & period == "mid")$pcoa.plot[[1]] 
niche_high_late.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "high" & period == "late")$pcoa.plot[[1]] 

niche_mid_early.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "mid" & period == "early")$pcoa.plot[[1]]
niche_mid_mid.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "mid" & period == "mid")$pcoa.plot[[1]]
niche_mid_late.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "mid" & period == "late")$pcoa.plot[[1]] 

niche_low_early.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "low" & period == "early")$pcoa.plot[[1]]
niche_low_mid.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "low" & period == "mid")$pcoa.plot[[1]] 
niche_low_late.color.plot <- filter(niche_x_elevperiod.color, elev.class2 == "low" & period == "late")$pcoa.plot[[1]] 

## Display plots on grid
#pdf("../analyses/output/niche_x_elevperiod_pcoa_tax.pdf", height = 8.5, width = 11)
(niche_high_early.tax.plot | niche_high_mid1.tax.plot  | niche_high_mid2.tax.plot | niche_high_late.tax.plot) /
(niche_mid_early.tax.plot | niche_mid_mid1.tax.plot | niche_mid_mid2.tax.plot | niche_mid_late.tax.plot) /
(niche_low_early.tax.plot | niche_low_mid1.tax.plot  | niche_low_mid2.tax.plot  | niche_low_late.tax.plot)  + 
  plot_layout(guides = 'collect') 
#dev.off()

#pdf("../analyses/output/niche_x_elevperiod_pcoa_morph.pdf", height = 8.5, width = 11)
(niche_high_early.morph.plot | niche_high_mid1.morph.plot  | niche_high_mid2.morph.plot | niche_high_late.morph.plot) /
(niche_mid_early.morph.plot | niche_mid_mid1.morph.plot | niche_mid_mid2.morph.plot | niche_mid_late.morph.plot) /
(niche_low_early.morph.plot | niche_low_mid1.morph.plot  | niche_low_mid2.morph.plot  | niche_low_late.morph.plot)  + 
  plot_layout(guides = 'collect') 
#dev.off()
```

## 1.6 Tree plots
This visualization deserves to be pulled out as a stand-alone chunk. It's so good.
```{r}
### Visitation by BB species, parsed by elev.class2 and period
visitation_abund.sp <- net %>%
  filter(caste != "male") %>%
  filter(!bb.sp %in% c("gers", "humi")) %>% 
  #group_by(site) %>%
  group_by(elev.class2) %>%
  mutate(period = cut_interval(dayofyear, 3, labels = c("early",  "mid", "late"))) %>%
  group_by(site, date, bb.sp, period, elev.class2, plant.sp.abb, plant.genus, k.type.ss, color, plant.family) %>% 
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(site, date, period, elev.class2, plant.sp.abb, plant.genus, k.type.ss, color, plant.family) %>%
  complete(bb.sp, plant.sp.abb, fill = list(freq = 0)) %>% # fill in zeros for unvisited plants
  group_by(site, date, bb.sp) %>%
  mutate(prop = freq/sum(freq)) %>% # get proportional interaction frequency for each BB-FL pair per site-date 
  group_by(bb.sp, period, elev.class2, plant.sp.abb, plant.genus, k.type.ss, color, plant.family) %>%
  summarize(prop = mean(prop)) %>% # get mean proportional intneraction frequency aggregated by ...
  left_join(bb_traits) %>%
  arrange(elev.class2, period, bb.sp, -prop) 

# Color palette

cols = c("0" = "gray60", "1" = "#8DD3C7", "2" = "#FFFFB3", "3" = "#BEBADA",
         "4" = "#FB8072", "5" = "#80B1D3", "6" = "#FDB462", "7" = "#B3DE69",
         "8" = "#FCCDE5", "9" = "#D9D9D9")

cols2 = c("blue" = "cornflowerblue", 
          "yellow" = "gold1", 
          "pink" = "orchid2", 
          "red" = "firebrick1",
         "violet" = "mediumpurple2", 
         "purple" = "purple", 
         "white" = "white", 
         "various colors" = "black",
         "brown" = "sienna",
         "undet" = "gray40", 
         "green" = "olivedrab1", 
         "orange" = "orange", 
         "lilac" = "mediumorchid")

# Early
tp.early <- ggplot(filter(visitation_abund.sp, period == "early"), 
                aes(area = prop, fill = k.type.ss, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

tp.early.col <- ggplot(filter(visitation_abund.sp, period == "early"), 
                aes(area = prop, fill = color, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols2) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

# Mid
tp.mid <- ggplot(filter(visitation_abund.sp, period == "mid"), 
                 aes(area = prop, fill = k.type.ss, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

tp.mid.col <- ggplot(filter(visitation_abund.sp, period == "mid"), 
                 aes(area = prop, fill = color, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols2) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

# Late
tp.late <- ggplot(filter(visitation_abund.sp, period == "late"), 
                  aes(area = prop, fill = k.type.ss, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

tp.late.col <- ggplot(filter(visitation_abund.sp, period == "late"), 
                  aes(area = prop, fill = color, label = plant.sp.abb)) +
  geom_treemap(color = "white") +
  geom_treemap_text(fontface = "italic", color = "black", place = "centre", "grow" = TRUE, alpha = 0.5) +
  scale_fill_manual(values = cols2) + 
  labs(fill = "Morphotype") +
  facet_grid(fct_rev(elev.class2)~reorder(bb.sp, pbl.w)) +
  theme(strip.text = element_text(size = 14))

# Pair with ordination plots
tp_ord1 <- (
  tp.early / (
    niche_low_early.tax.plot + ggtitle("low") | 
    niche_mid_early.tax.plot + ggtitle("mid") | 
    niche_high_early.tax.plot + ggtitle("high")
    ) + 
    plot_layout(guides = 'collect')
  ) + 
  plot_layout(heights = c(2, 1))
ggsave("./output/tree_ord_early.png", tp_ord1, width = 16, height = 10)

tp_ord2 <- (
  tp.mid1 | (
    niche_high_mid1.tax.plot / 
    niche_mid_mid1.tax.plot / 
    niche_low_mid1.tax.plot
    ) + 
    plot_layout(guides = 'collect')
  ) + 
  plot_layout(widths = c(5, 1))
ggsave("./output/tree_ord_mid1.png", tp_ord2, width = 14, height = 8)

tp_ord3 <- (
  tp.mid2 | (
    niche_high_mid2.tax.plot / 
    niche_mid_mid2.tax.plot / 
    niche_low_mid2.tax.plot
    ) + 
    plot_layout(guides = 'collect')
  ) + 
  plot_layout(widths = c(5, 1))
ggsave("./output/tree_ord_mid2.png", tp_ord3, width = 14, height = 8)

tp_ord4 <- (
  tp.late | (
    niche_high_late.tax.plot / 
    niche_mid_late.tax.plot / 
    niche_low_late.tax.plot
    ) + 
    plot_layout(guides = 'collect')
  ) + 
  plot_layout(widths = c(5, 1))
ggsave("./output/tree_ord_late.png", tp_ord4, width = 14, height = 8)
```
