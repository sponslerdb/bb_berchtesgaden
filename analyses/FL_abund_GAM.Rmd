---
title: "preference"
output: html_document
---
### Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidyverse)
library(lubridate)
```

### Climate data
```{r, include=FALSE, echo=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, year, date, gdd.cum) %>%
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  #dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low")))
```

### Load network and survey data
```{r}
### BB-FL visitation data
net <- read_csv("../processed_data/network.csv") %>%
  dplyr::select(site, date, bb.sp, plant.sp)

### Floral survey data
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

survey_dups <- survey %>%
  group_by(site, date, plant.sp) %>%
  mutate(dups = n()) %>%
  filter(dups > 1) 

dup_species <- survey_dups %>%
  group_by(plant.sp) %>%
  mutate(dups = n()/2) %>%
  group_by(site, date, plant.sp, dups) %>%
  mutate(different = length(unique(flower.cover)) -1) %>%
  group_by(site, date, plant.sp, dups) %>%
  summarize(different = mean(different)) %>%
  group_by(plant.sp, dups) %>%
  summarize(different.dups = sum(different)) %>% 
  arrange(-dups)


### Shared transects
shared_transects <- inner_join(net, survey, by = c("site", "date")) %>%
  dplyr::select(site, date) %>%
  unique() 
```

### FL and BB abundance / diversity
```{r echo=FALSE, include=FALSE}
### Per-transect BB abundance: species-level
bb_abund_sp <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  semi_join(shared_transects) %>% # I only want BB data with corresponding floral data
  group_by(site, date, bb.sp) %>% # group by bb.sp*transect (and other variables we want to retain)
  summarize(bb.abund = n()) %>% # get bb.sp*transect abundance
  ungroup %>%
  complete(site, date, bb.sp, fill = list(bb.abund = 0)) %>% # complete implicit absences
  mutate(year = factor(year(date))) %>%
  semi_join(net, by = c("site", "date")) # only include site-dates that actually occurred

### Per-transect floral abund: by species
fl_abund_sp <- survey %>%
  #semi_join(shared_transects) %>%
  group_by(site, date, plant.sp) %>% # group by plant.sp*transect
  summarize(fl.abund = sum(flower.cover)) %>% # get plant.sp*transect total flower cover; this step really shouldn't be required, but in a few cases, there is more than one abundance entry for the same species on a given transect; not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, I could drop the dups or average them. We'll see what Kalli and Fabrice have to say.
  group_by(site, date) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund)) %>% # get the proportional flower cover for each species.
  ungroup() %>%
  full_join(dplyr::select(net, site, date, plant.sp), by = c("site", "date", "plant.sp")) %>% # add the handful of species occurring in the visitation network but missing from the survey data
  complete(site, date, plant.sp, fill = list(fl.abund = 0, prop.fl.abund = 0)) %>%
  semi_join(survey, by = c("site", "date")) %>%  # only include site-dates that actually occurred
  unique() %>%
  mutate(year = factor(year(date)))

test <- fl_abund_sp %>%
  group_by(site, date) %>%
  summarize(n = n())
```

### Get most important plants for each BB species
```{r}
observed_visits <- net %>%
  semi_join(shared_transects) %>% # include only site*date combos where floral surveying was done
  group_by(site, date, bb.sp, plant.sp) %>% # group by bb*plant*transect
  summarize(visits = n()) %>% # total visits per bb-fl pair
  group_by(site, date, bb.sp) %>%
  mutate(prop.visits = visits/sum(visits))

# All possible bumble-plant pairings *site * date, filtered to include only those when the given bb.sp was present and the given plant.sp was *either* present *or* visited (see note below)
visitation_by_abundance <- fl_abund_sp %>%
  inner_join(bb_abund_sp) %>%
  filter(bb.abund > 0) %>%
  filter(fl.abund > 0) %>% 
  left_join(observed_visits) %>%
  #filter(fl.abund > 0 | visits > 0) %>% # In about 10% of the bb.sp*plant.sp*site*year combos, the visited plant was not recorded in the floral survey data. There are a few different ways we could handle this, but I think an argument could be make that treating those plants as if they had zero abundance (even though they were evidently present gets close to the truth, since they must have been rather rare to have been missed in the surveying.)
  replace_na(list(visits = 0, prop.visits = 0))

#write_csv(visitation_by_abundance, "../analyses/output/visitation_by_abundance.csv") 

### Get mean abundance/visitation for each plant*bb combo
visitation_by_abundance_mean <- visitation_by_abundance %>%
  mutate(year = factor(year(date))) %>%
  group_by(plant.sp, bb.sp) %>%
  summarize(prop.fl.abund.m = mean(prop.fl.abund),
            prop.visits.wm = weighted.mean(prop.visits, bb.abund))

#write_csv(visitation_by_abundance_mean, "../analyses/output/visitation_by_abundance_mean.csv")

ggplot(filter(visitation_by_abundance_mean, prop.visits.wm > 0), 
       aes(log(prop.fl.abund.m + 0.01), log(prop.visits.wm))) +
  geom_point(alpha = 0.5, aes(color = bb.sp)) +
  geom_smooth(method = "lm")

ggplot(filter(visitation_by_abundance_mean), 
       aes(prop.fl.abund.m, prop.visits.wm)) +
  geom_point(alpha = 0.5, aes(color = bb.sp)) +
  geom_smooth(method = "lm")
```

### Okay, here's what we're going to do. Preference has a strong bimodal pattern, with lots of plant species totally ignored while the ones that are foraged upon are visited in proportion to their abundance. We can't model that latter pattern well if we retain all the totally ignored plant species. So, let's model the visited plants separately from the unvisited ones. 
```{r}
### Call linear model on the subset of the floral species that were visited at least once
# log on log regression is common for proportional datam (log ratio regression)
pref.lm <- lm(log(prop.visits.wm) ~ log(prop.fl.abund.m + 0.01), 
              data = filter(visitation_by_abundance_mean, prop.visits.wm > 0))

summary(pref.lm)
plot(pref.lm)

### Extract residuals
pref.lm.resid <- residuals(pref.lm) %>%
  data.frame() %>%
  as_tibble() %>%
  rename(preference = 1)
```

Join residuals back into data and summarize by site-date-bb.sp (this deserves its own code chunk)
```{r}
#################################
### Build preference data set ###
#################################
# Start with the mean prop.fl.abund and weighted mean prop.visits
preference <- visitation_by_abundance_mean %>%  
  ungroup() %>%

# Remove bb*fl*year combos that had 0 visits
  filter(prop.visits.wm > 0) %>% 
  
# With the zeroes removed, what's left can be joined 1:1 with the 
# residuals of the model above, i.e. the raw preference data
  bind_cols(pref.lm.resid) %>% 
  
# Exponentiate the residuals to back-transform the data and ensure 
# that preference is > 0 for all visited plant species.
  mutate(preference = exp(preference)) %>% 
  
# Now we need to add back all the bb*fl*year combos that had 0 visits
# Then we have NAs for preference and floral abundance columns
  full_join(unique(dplyr::select(visitation_by_abundance_mean, bb.sp, plant.sp))) %>%
  
# Replace the NAs of the preference column with 0s; 
  replace_na(list(preference = 0)) %>%

# Drop the columns used to calculate preference so that they
# don't confuse us when we add site-date level abundance data
  dplyr::select(bb.sp, plant.sp, preference)
  
write_csv(preference, "../analyses/output/preference.csv")

#################################
### Join with FL and BB abund ###
#################################

# For bb-fl combos that never co-occurred, set preference = 1
pref_forbidden_link_fill <- inner_join(fl_abund_sp, bb_abund_sp) %>%
  mutate(co = case_when(
    fl.abund == 0 | bb.abund == 0 ~ 0,
    fl.abund != 0 & bb.abund != 0 ~ 1)
  ) %>%
  group_by(plant.sp, bb.sp) %>%
  summarize(co.max = max(co)) %>%
  filter(co.max == 0) %>%
  mutate(preference.update = rep(1, n())) %>%
  dplyr::select(-co.max) %>%
  inner_join(fl_abund_sp) 

fl_abund_wt <- fl_abund_sp %>%
  select(-year) %>%
  left_join(preference) %>% 
  
  # Add the forbidden links with preference set to 1 (neutral)
  full_join(pref_forbidden_link_fill) %>%
  mutate(preference = case_when(
    is.na(preference) ~ preference.update,
    !is.na(preference) ~ preference)
    ) %>%
  dplyr::select(-preference.update) %>%
  
  mutate(fl.abund.wt = fl.abund*preference) %>%
  mutate(yday = yday(date)) %>%
  group_by(site, date, yday, bb.sp) %>%
  summarize(fl.abund.wt = sum(fl.abund.wt, na.rm = TRUE)) %>%
  ungroup() %>%
  semi_join(survey, by = c("site", "date")) %>% # This gets rid of site*date combos that don't exist
  left_join(site_data, by = "site") %>%
  mutate(year = factor(year(date)), # add in the years missing from the bb_abund join
         bb.sp = factor(bb.sp), # convert bb.sp to a factor
         management = factor(management),
         site = factor(site),
         transect = factor(transect)) %>%
  group_by(year) %>%
  mutate(total.transects.year = n()) %>%
  ungroup()

write_csv(fl_abund_wt, "../analyses/output/fl_abund_wt.csv")
```

GAM modeling of preference-weighted abundance per bb species

** One thing I need to go back and reconsider is that right now, I think forbidden links (i.e. links between species that never co-occurred) are given a zero for preference. A better approach would be to set their preference to a neutral value, which would be 1 in my case, since exp(0) = 1 and my preference values are calculated as exp(residual) of my linear model of visitation ~ abundance. **

I think I need to include site as a random effect because if I don't the pseudoreplication of elevation is pretty extreme, especially in 2012 where I have lots of repeated measures. I am not, for example, measuring floral abundance at 1000 m 20 independent times; I'm measuring it 20 times at the same spot. This does, of  course, create identifiability issues insofar as site and elevation are concurved. But I think I need to accept these problems. The seriousness of the identifiability problems depends in part, I think, on how mgcv handles random effect smooths. Does it first account for all the variation it can with the main effects, then model the residuals with the random effect? In this case, it's probably not a big problem, since the "partial" influence of site would orthogonal (right?) with that of te(elev.mean, yday).

```{r}
### Global model
weighted_fl_abundance.global <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      s(year, bs = "re") +
                                      s(site, bs = "re") +
                                        te(yday, elev.mean, 
                                         by = year,
                                                id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(8, 8), 
                                                m=2) +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(8, 8), 
                                                m=1),
                                    data = fl_abund_wt,
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

weighted_fl_abundance.global2 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      s(year, bs = "re") +
                                      s(site, bs = "re") +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(10, 10), 
                                                m=1),
                                    data = fl_abund_wt,
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

weighted_fl_abundance.global3 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      s(year, bs = "re") +
                                      s(site, bs = "re") +
                                      te(yday, elev.mean, 
                                              id = 0,
                                              bs= c("gp", "tp"), 
                                              k=c(10, 10), 
                                              m=2) +
                                      te(yday, elev.mean, 
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp"), 
                                                k=c(10, 10), 
                                                m=1),
                                    data = fl_abund_wt,
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

weighted_fl_abundance.global4 <- bam(log(fl.abund.wt + 0.001) ~
                                      s(bb.sp, bs = "re") +
                                      #s(management, bs = "re") +
                                      s(year, bs = "re") +
                                      s(site, bs = "re") +
                                      te(yday, elev.mean, year,
                                                by = bb.sp,
                                                #id = 0,
                                                bs= c("gp", "tp", "re"), 
                                                k=c(5, 5), 
                                                m=1),
                                    data = fl_abund_wt,
                                    discrete = TRUE,
                                    family = "gaussian",
                                    select = TRUE,
                                    method = "fREML") %>% getViz(nsim = 500)

AIC(weighted_fl_abundance.global, weighted_fl_abundance.global2, weighted_fl_abundance.global3, weighted_fl_abundance.global4)

check.gamViz(weighted_fl_abundance.global)
check.gamViz(weighted_fl_abundance.global2)
check.gamViz(weighted_fl_abundance.global3)
check.gamViz(weighted_fl_abundance.global4)

weighted_fl_abundance.global.sum <- summary(weighted_fl_abundance.global)
weighted_fl_abundance.global.sum2 <- summary(weighted_fl_abundance.global2)
weighted_fl_abundance.global.sum3 <- summary(weighted_fl_abundance.global3)
weighted_fl_abundance.global.sum3 <- summary(weighted_fl_abundance.global4)

print(plot(weighted_fl_abundance.global, allTerms = TRUE), pages = 4)
print(plot(weighted_fl_abundance.global2, allTerms = TRUE), pages = 4)
print(plot(weighted_fl_abundance.global3, allTerms = TRUE), pages = 4)
print(plot(weighted_fl_abundance.global4, allTerms = TRUE), pages = 4)



weighted_fl_abundance.global.ck <- check2D(weighted_fl_abundance.global, 
                                         x1 = "yday", x2 = "elev.mean")
weighted_fl_abundance.global.ck + l_gridCheck2D(gridFun = mean)


### 2010
weighted_fl_abundance.2010 <- bam(fl.abund.wt ~ s(bb.sp, bs = "re") + 
                                    management + 
                                    #slope.est +
                                    #s(site, bs = "re") +
                                    te(yday, elev.mean, 
                                       by = bb.sp,
                                       bs= c("gp", "tp"), 
                                       k=c(10, 10), m=2),
                                  data = filter(fl_abund_wt, year == 2010),
                                  discrete = TRUE,
                                  family = "tw",
                                  select = TRUE,
                                  method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2010)
weighted_fl_abundance.2010.sum <- summary(weighted_fl_abundance.2010)
print(plot(weighted_fl_abundance.2010, allTerms = TRUE), pages = 1)
weighted_fl_abundance.2010.ck <- check2D(weighted_fl_abundance.2010, 
                                         x1 = "yday", x2 = "elev.mean")
weighted_fl_abundance.2010.ck + l_gridCheck2D(gridFun = mean)

### 2011
weighted_fl_abundance.2011 <- bam(fl.abund.wt ~ s(bb.sp, bs = "re") + 
                                    #s(transect, bs = "re") +
                                    management + 
                                    #slope.est +
                                    #s(site, bs = "re") +
                                    te(yday, elev.mean, 
                                       by = bb.sp,
                                       bs= c("gp", "tp"), 
                                       k=c(10, 10), m=2),
                                  data = filter(fl_abund_wt, year == 2011),
                                  discrete = TRUE,
                                  family = "tw",
                                  select = TRUE,
                                  method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2011)
weighted_fl_abundance.2011.sum <- summary(weighted_fl_abundance.2011)
print(plot(weighted_fl_abundance.2011, allTerms = TRUE), pages = 1)
weighted_fl_abundance.2011.ck <- check2D(weighted_fl_abundance.2011, 
                                         x1 = "yday", x2 = "elev.mean")
weighted_fl_abundance.2011.ck + l_gridCheck2D(gridFun = mean)

### 2012
weighted_fl_abundance.2012 <- bam(fl.abund.wt ~ s(bb.sp, bs = "re") + 
                                    #s(transect, bs = "re") +
                                    management + 
                                    #slope.est +
                                    s(site, bs = "re") +
                                    te(yday, elev.mean, 
                                       by = bb.sp,
                                       bs= c("gp", "tp"), 
                                       k=c(10, 10), m=1),
                                  data = filter(fl_abund_wt, year == 2012),
                                  discrete = TRUE,
                                  family = "tw",
                                  select = TRUE,
                                  method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abundance.2012)
weighted_fl_abundance.2012.sum <- summary(weighted_fl_abundance.2012)
print(plot(weighted_fl_abundance.2012, allTerms = TRUE), pages = 1)
weighted_fl_abundance.2012.ck <- check2D(weighted_fl_abundance.2012, 
                                         x1 = "yday", x2 = "elev.mean")
weighted_fl_abundance.2012.ck + l_gridCheck2D(gridFun = mean)
```

### Tabulate plots
```{r}
bssFL_2010 <- plot(sm(weighted_fl_abundance.2010, 4)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. terrestris/lucorum")), x = NULL, y = NULL)
bssFL_2011 <- plot(sm(weighted_fl_abundance.2011, 4)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. terrestris/lucorum")), x = NULL, y = NULL)
bssFL_2012 <- plot(sm(weighted_fl_abundance.2012, 4)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. terrestris/lucorum")), x = NULL, y = NULL)

gersFL_2010 <- plot(sm(weighted_fl_abundance.2010, 5)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. gerstaeckeri")), x = NULL, y = NULL)
gersFL_2011 <- plot(sm(weighted_fl_abundance.2011, 5)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. gerstaeckeri")), x = NULL, y = NULL) 
gersFL_2012 <- plot(sm(weighted_fl_abundance.2012, 5)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. gerstaeckeri")), x = NULL, y = NULL)

hortFL_2010 <- plot(sm(weighted_fl_abundance.2010, 6)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hortorum")), x = NULL, y = NULL)
hortFL_2011 <- plot(sm(weighted_fl_abundance.2011, 6)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hortorum")), x = NULL, y = NULL)
hortFL_2012 <- plot(sm(weighted_fl_abundance.2012, 6)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hortorum")), x = NULL, y = NULL)

humiFL_2010 <- plot(sm(weighted_fl_abundance.2010, 7)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. humilis")), x = NULL, y = NULL)
humiFL_2011 <- plot(sm(weighted_fl_abundance.2011, 7)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. humilis")), x = NULL, y = NULL)
humiFL_2012 <- plot(sm(weighted_fl_abundance.2012, 7)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. humilis")), x = NULL, y = NULL)

hypnFL_2010 <- plot(sm(weighted_fl_abundance.2010, 8)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hypnorum")), x = NULL, y = NULL)
hypnFL_2011 <- plot(sm(weighted_fl_abundance.2011, 8)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hypnorum")), x = NULL, y = NULL)
hypnFL_2012 <- plot(sm(weighted_fl_abundance.2012, 8)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. hypnorum")), x = NULL, y = NULL)

joneFL_2010 <- plot(sm(weighted_fl_abundance.2010, 9)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. jonellus")), x = NULL, y = NULL)
joneFL_2011 <- plot(sm(weighted_fl_abundance.2011, 9)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. jonellus")), x = NULL, y = NULL)
joneFL_2012 <- plot(sm(weighted_fl_abundance.2012, 9)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. jonellus")), x = NULL, y = NULL)

lapiFL_2010 <- plot(sm(weighted_fl_abundance.2010, 10)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. lapidarius")), x = NULL, y = NULL)
lapiFL_2011 <- plot(sm(weighted_fl_abundance.2011, 10)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. lapidarius")), x = NULL, y = NULL)
lapiFL_2012 <- plot(sm(weighted_fl_abundance.2012, 10)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. lapidarius")), x = NULL, y = NULL)

mendFL_2010 <- plot(sm(weighted_fl_abundance.2010, 11)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mendax")), x = NULL, y = NULL)
mendFL_2011 <- plot(sm(weighted_fl_abundance.2011, 11)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mendax")), x = NULL, y = NULL)
mendFL_2012 <- plot(sm(weighted_fl_abundance.2012, 11)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mendax")), x = NULL, y = NULL)

montFL_2010 <- plot(sm(weighted_fl_abundance.2010, 12)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. monticola")), x = NULL, y = NULL)
montFL_2011 <- plot(sm(weighted_fl_abundance.2011, 12)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. monticola")), x = NULL, y = NULL)
montFL_2012 <- plot(sm(weighted_fl_abundance.2012, 12)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. monticola")), x = NULL, y = NULL)

muciFL_2010 <- plot(sm(weighted_fl_abundance.2010, 13)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mucidis")), x = NULL, y = NULL)
muciFL_2011 <- plot(sm(weighted_fl_abundance.2011, 13)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mucidis")), x = NULL, y = NULL)
muciFL_2012 <- plot(sm(weighted_fl_abundance.2012, 13)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. mucidis")), x = NULL, y = NULL)

pascFL_2010 <- plot(sm(weighted_fl_abundance.2010, 14)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pascuorum")), x = NULL, y = NULL)
pascFL_2011 <- plot(sm(weighted_fl_abundance.2011, 14)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pascuorum")), x = NULL, y = NULL)
pascFL_2012 <- plot(sm(weighted_fl_abundance.2012, 14)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pascuorum")), x = NULL, y = NULL)

pratFL_2010 <- plot(sm(weighted_fl_abundance.2010, 15)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pratorum")), x = NULL, y = NULL)
pratFL_2011 <- plot(sm(weighted_fl_abundance.2011, 15)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pratorum")), x = NULL, y = NULL)
pratFL_2012 <- plot(sm(weighted_fl_abundance.2012, 15)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pratorum")), x = NULL, y = NULL)

psitFL_2010 <- plot(sm(weighted_fl_abundance.2010, 16)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. psithyrus")), x = NULL, y = NULL)
psitFL_2011 <- plot(sm(weighted_fl_abundance.2011, 16)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. psithyrus")), x = NULL, y = NULL)
psitFL_2012 <- plot(sm(weighted_fl_abundance.2012, 16)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. psithyrus")), x = NULL, y = NULL)

pyreFL_2010 <- plot(sm(weighted_fl_abundance.2010, 17)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pyrenaeus")), x = NULL, y = NULL)
pyreFL_2011 <- plot(sm(weighted_fl_abundance.2011, 17)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pyrenaeus")), x = NULL, y = NULL)
pyreFL_2012 <- plot(sm(weighted_fl_abundance.2012, 17)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. pyrenaeus")), x = NULL, y = NULL)

soroFL_2010 <- plot(sm(weighted_fl_abundance.2010, 18)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. soroensis")), x = NULL, y = NULL)
soroFL_2011 <- plot(sm(weighted_fl_abundance.2011, 18)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. soroensis")), x = NULL, y = NULL)
soroFL_2012 <- plot(sm(weighted_fl_abundance.2012, 18)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. soroensis")), x = NULL, y = NULL)

wurfFL_2010 <- plot(sm(weighted_fl_abundance.2010, 19)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. wurflenii")), x = NULL, y = NULL)
wurfFL_2011 <- plot(sm(weighted_fl_abundance.2011, 19)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. wurflenii")), x = NULL, y = NULL)
wurfFL_2012 <- plot(sm(weighted_fl_abundance.2012, 19)) +
  l_fitRaster() +
  l_fitContour(size = 0.1) +
  guides(fill = FALSE) +
  #l_points() +
  labs(title = expression(italic("B. wurflenii")), x = NULL, y = NULL)

major_sp <- gridPrint(bssFL_2010, bssFL_2011, bssFL_2012, 
                      pascFL_2010, pascFL_2011, pascFL_2012,
                      pratFL_2010, pratFL_2011, pratFL_2012,
                      soroFL_2010, soroFL_2011, soroFL_2012,
                      wurfFL_2010, wurfFL_2011, wurfFL_2012, ncol = 3)

high_elev_sp <- gridPrint(pyreFL_2010, pyreFL_2011, pyreFL_2012, 
                          mendFL_2010, mendFL_2011, mendFL_2012,
                          montFL_2010, montFL_2011, montFL_2012, ncol = 3)

minor_sp <- gridPrint(gersFL_2010, gersFL_2011, gersFL_2012,
                      hortFL_2010, hortFL_2011, hortFL_2012,
                      #humiFL_2010, humiFL_2011, humiFL_2012, # too rarely seen, I think only 3 times
                      hypnFL_2010, hypnFL_2011, hypnFL_2012,
                      joneFL_2010, joneFL_2011, joneFL_2012,
                      lapiFL_2010, lapiFL_2011, lapiFL_2012,
                      #psitFL_2010, psitFL_2011, psitFL_2012, # Let's ignore 
                      muciFL_2010, muciFL_2011, muciFL_2012, ncol = 3)
plot(major_sp)
plot(high_elev_sp)
plot(minor_sp)

```

### Abundance mismatch
```{r}
mismatch <- fl_abund_wt %>%
  filter(!is.na(bb.abund)) %>%
  group_by(year, bb.sp) %>%
  mutate(bb.abund.rank = rank(-bb.abund, ties.method = "average"),
            fl.abund.wt.rank = rank(-fl.abund.wt, ties.method = "average"))

ggplot(mismatch, aes(fl.abund.wt, bb.abund)) +
  geom_point() +
  facet_wrap(~bb.sp)

lm_mismatch <- lmer(bb.abund ~ log(fl.abund.wt + 0.01) + (1 +fl.abund.wt | bb.sp),
                    data = mismatch)
summary(lm_mismatch)
plot(lm_mismatch)

ggplot(mismatch, aes(log(fl.abund.wt + 0.01), sqrt(bb.abund))) +
  geom_point(aes(color = year)) +
  facet_wrap(~bb.sp, scales = "free")

mismatch_gam <- bam(bb.abund ~ bb.sp + year + s(log(fl.abund.wt + 0.01), by = bb.sp) + s(yday, k = 10),
                    family = "quasipoisson",
                    method = "fREML",
                    discrete = TRUE,
                    data = mismatch) %>% getViz()

check.gamViz(mismatch_gam)
summary(mismatch_gam)
print(plot(mismatch_gam , allTerms = TRUE), pages = 4)
```

### Now let's model floral richness, but considering only species with preference > 0. This is very consistent year-to-year, so we can get away with a single model. In fact, AIC favors the global-only model, so we can make a case for not considering species differences (indeed, they appear to be minimal, with the exception of a couple of rare species (gers, humi) that we need to take with a grain of salt anyway).
```{r}
fl_rich_wt <- fl_abund_sp %>%
  right_join(preference) %>% 
  filter(preference > 0 & fl.abund > 0) %>%
  mutate(yday = yday(date)) %>%
  group_by(site, date, yday, bb.sp) %>%
  summarize(fl.rich.wt = length(unique(plant.sp))) %>%
  ungroup() %>%
  left_join(bb_abund_sp) %>%
  left_join(site_data, by = "site") %>%
  semi_join(survey, by = c("site", "date")) %>% # This gets rid of site*date combos that don't exist
  mutate(year = factor(year(date)), # add in the years missing from the bb_abund join
         bb.sp = factor(bb.sp), # convert bb.sp to a factor
         management = factor(management),
         site = factor(site)) # convert management to a factor

fl.rich_I <- bam(fl.rich.wt ~ s(bb.sp, bs = "re") + 
                 year +
                 s(management, bs = "re") + 
                 s(site, bs = "re") +
                 te(yday, elev.mean, 
                    by = bb.sp,
                    bs= c("tp", "tp"), 
                    k=c(6, 6), m=2),
               data = fl_rich_wt,
               discrete = TRUE,
               family = "quasipoisson",
               select = TRUE,
               method = "fREML") %>% getViz()

check.gamViz(fl.rich)
fl.rich.sum <- summary(fl.rich)
print(plot(fl.rich, allTerms = TRUE), pages = 1)

fl.rich_GI <- bam(fl.rich.wt ~ s(bb.sp, bs = "re") + 
                 year +
                 s(management, bs = "re") + 
                 s(site, bs = "re") +
                 te(yday, elev.mean, 
                    bs= c("tp", "tp"), 
                    k=c(6, 6), m=2) +
                 te(yday, elev.mean, 
                    by = bb.sp,
                    bs= c("tp", "tp"), 
                    k=c(6, 6), m=2),
               data = fl_rich_wt,
               discrete = TRUE,
               family = "quasipoisson",
               select = TRUE,
               method = "fREML") %>% getViz()

check.gamViz(fl.rich)
fl.rich_GI.sum <- summary(fl.rich_GI)
print(plot(fl.rich_GI, allTerms = TRUE), pages = 1)

fl.rich_G <- bam(fl.rich.wt ~ s(bb.sp, bs = "re") + 
                 year +
                 s(management, bs = "re") + 
                 s(site, bs = "re") +
                 te(yday, elev.mean, 
                    bs= c("tp", "tp"), 
                    k=c(6, 6), m=2),
               data = fl_rich_wt,
               discrete = TRUE,
               family = "quasipoisson",
               select = TRUE,
               method = "fREML") %>% getViz()

check.gamViz(fl.rich_G)
fl.rich_G.sum <- summary(fl.rich_G)
print(plot(fl.rich_G, allTerms = TRUE), pages = 1)

AIC(fl.rich_GI, fl.rich_I, fl.rich_G)
```

### Does preference relate to BB-FL traits? This serves mainly as a sanity check for my floral preference assessment.
```{r}
bb_traits <- read_csv("../processed_data/bb_traits.csv") %>%
  dplyr::select(subgenus, bb.sp, pbl.w, pbl.w.class)

fl_ktype <- read.csv("../processed_data/floral_k_type_nom_fix.csv") %>%
  dplyr::select(plant.sp, k.type) %>%
  mutate(k.type.s = str_extract(k.type, "[-+]?[0-9]*\\.?[0-9]+"),
         k.type.ss = str_extract(k.type, "[-+]?[0-9]*"))

fl_morph <- read.csv("../processed_data/flower_morphology_GitaBenadi.csv") %>%
  rename(plant.sp = Species) %>%
  group_by(plant.sp) %>%
  summarize(corolla.depth = mean(LN))

fl_tax <- read_csv("../processed_data/floral_tax.csv")

pref_traits <- preference %>%
  left_join(bb_traits) %>%
  left_join(fl_ktype) %>%
  left_join(fl_morph) %>%
  separate(plant.sp, c("plant.genus", "plant.species"), sep = " ", remove = FALSE) %>%
  left_join(fl_tax) %>%
  mutate(preference.bin = case_when(
    preference > 0 ~ 1,
    preference == 0 ~ 0
  )) %>%
  mutate(tongue.mismatch = abs(pbl.w - corolla.depth),
         bb.sp = factor(bb.sp),
         plant.sp = factor(plant.sp),
         plant.genus = factor(plant.genus),
         subgenus = factor(subgenus),
         k.type.s = factor(k.type.s),
         plant.family = factor(plant.family))

### To deal with zero inflation, binarize and do binomial regression
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}

ggplot(pref_traits, aes(tongue.mismatch, preference.bin)) + 
  geom_point() +
  binomial_smooth()

### Model: the binomial model might be the best bet
library(DHARMa)
library(lmerTest)
lmer_bin <- glmer(preference.bin ~ tongue.mismatch + 
                       (1 | plant.sp) +
                       (1 | bb.sp), 
                 family = "binomial",
                 data = pref_traits)

summary(lmer_bin)
plot(lmer_bin)
simulationOutput_bin <- simulateResiduals(fittedModel = lmer_bin, plot = T)
testResiduals(simulationOutput_bin)
plot(simulationOutput_bin)
```