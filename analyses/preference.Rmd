---
title: "preference"
output: html_document
---
### Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidyverse)
library(lubridate)
```


### Climate data
```{r, include=FALSE, echo=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, year, date, gdd.cum) %>%
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low")))
```

### Load network and survey data
```{r, echo=FALSE, include=FALSE}
### BB traits
bb_traits <- read_csv("../processed_data/bb_traits.csv") %>%
  dplyr::select(subgenus, bb.sp, pbl.w, pbl.w.class)

### FL Kugler classification
fl_traits <- read.csv("../processed_data/floral_k_type_nom_fix.csv") %>%
  dplyr::select(plant.sp, k.type) %>%
  mutate(k.type.s = str_extract(k.type, "[-+]?[0-9]*\\.?[0-9]+"),
         k.type.ss = str_extract(k.type, "[-+]?[0-9]*"))

### FL corolla depth (from Benadi)
fl_corolla_depth <- read.csv("../processed_data/flower_morphology_GitaBenadi.csv") %>%
  group_by(plant.sp = Species) %>%
  summarize(corolla.depth = mean(LN))

### FL higher  taxonomy
fl_tax <- read_csv("../processed_data/floral_tax.csv") 

### Colony life cycle break points
breaks <- read_csv("./output/breaks.csv") %>%
  mutate(year = factor(year))

### BB-FL visitation data
net <- read_csv("../processed_data/network.csv") %>%
  mutate(year = factor(year)) %>% # convert year to factor
  full_join(bb_traits, by = c("bb.sp" = "bb.sp")) %>%
  left_join(site_data, by = c("site")) %>%
  left_join(gdd, by = c("site", "date", "year")) %>%
  left_join(breaks, by = c("site", "year")) %>%
  left_join(fl_traits) %>%
  left_join(fl_corolla_depth) %>%
  left_join(fl_tax, by = "plant.genus") %>%
  #left_join(temperature, by = c("site", "date")) %>%
  ungroup() %>%
  mutate(phase = case_when(
    gdd.cum < break1.gdd ~ "founding",
    gdd.cum >= break1.gdd & gdd.cum < break2.gdd ~ "buildup",
    gdd.cum > break2.gdd ~ "reproductive"
  )) %>%
  mutate(phase = factor(phase, levels = c("founding", "buildup", "reproductive"))) %>%
  mutate(caste = case_when(
    caste == "worker" ~ "worker",
    caste == "male" ~ "reproductive",
    caste == "youngqueen" ~ "reproductive",
    caste == "queen" ~ "foundress",
    caste == "oldqueen" ~ "foundress"
  )) %>%
  rename(yday = dayofyear) %>%
  arrange(site, date)

### Floral survey data
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  mutate(year = factor(year)) %>% # convert year to factor
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime, not specifically for a given site*date)
  left_join(gdd, by = c("site", "date", "year")) %>%
  left_join(breaks, by = c("site", "year")) %>%
  left_join(site_data, by = c("site")) %>%
  left_join(fl_traits) %>%
  left_join(fl_traits) %>%
  left_join(fl_tax) %>%
  #left_join(temperature, by = c("site", "date")) %>%
  ungroup() %>%
  mutate(phase = case_when(
    gdd.cum < break1.gdd ~ "founding",
    gdd.cum >= break1.gdd & gdd.cum < break2.gdd ~ "buildup",
    gdd.cum > break2.gdd ~ "reproductive"
  )) %>%
  mutate(phase = factor(phase, levels = c("founding", "buildup", "reproductive"))) %>%
  rename(yday = dayofyear) %>%
  arrange(site, date)
```

### FL and BB abundance / diversity
```{r echo=FALSE, include=FALSE}
### Per-transect BB abundance: species-level
bb_abund_sp <- net %>%
  group_by(site, date, yday, gdd.cum, year, elev.class2, 
           elev.mean, phase, break1.gdd, break2.gdd, bb.sp) %>%
  summarize(bb.abund = n()) %>%
  ungroup() %>%
  spread(bb.sp, bb.abund) %>%
  gather(bb.sp, bb.abund, -c(site, date, year, yday, gdd.cum, elev.class2, 
                             elev.mean, phase, break1.gdd, break2.gdd)) %>%
  replace_na(list(bb.abund = 0)) %>%
  mutate(bb.sp = factor(bb.sp))

### Per-transect BB abundance: species-level, by caste
bb_abund_sp_caste <- net %>%
  group_by(site, date, yday, gdd.cum, year, elev.class2, 
           elev.mean, phase, break1.gdd, break2.gdd, bb.sp, caste) %>%
  summarize(bb.abund = n()) %>%
  group_by(caste) %>%  # The next several lines of crazy nonsense are all about filling in zeros where a given caste*species was not observed.
  spread(bb.sp, bb.abund) %>%
  gather(bb.sp, bb.abund, -c(site, date, year, yday, gdd.cum, elev.class2, 
                             elev.mean, phase, break1.gdd, break2.gdd, caste)) %>%
  group_by(bb.sp) %>%
  spread(caste, bb.abund) %>%
  gather(caste, bb.abund, -c(site, date, year, yday, gdd.cum, elev.class2, 
                             elev.mean, phase, break1.gdd, break2.gdd, bb.sp)) %>%
  replace_na(list(bb.abund = 0)) %>%
  ungroup() %>%
  mutate(bb.sp = factor(bb.sp))

### Per-transect floral abund: by species
fl_abund_sp <- survey %>%
  group_by(site, date, year, plant.sp, yday) %>%
  summarize(fl.abund = sum(flower.cover)) %>%
  ungroup() %>%
  spread(plant.sp, fl.abund) %>%
  gather(plant.sp, fl.abund, -c(site, date, year, yday)) %>%
  replace_na(list(fl.abund = 0)) %>%
  mutate(plant.sp = factor(plant.sp)) %>%
  dplyr::select(site, year, yday, plant.sp, fl.abund) %>%  # this is an attempt to manage the memory crashes I'm getting with a later join step
  group_by(site, year, yday) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund))
```

### Get most important plants for each BB species
```{r}
# Per transect visitation rates of flower species per BB species
visit_rates <- net %>%
  group_by(bb.sp, plant.sp, year, site, yday) %>%
  summarize(visits = n()) %>%
  group_by(bb.sp) %>%
  spread(plant.sp, visits) %>%
  gather(plant.sp, visits, -c(bb.sp, year, site, yday)) %>%
  group_by(plant.sp) %>%
  spread(bb.sp, visits) %>%
  gather(bb.sp, visits, -c(plant.sp, year, site, yday)) %>%
  group_by(year, site, bb.sp, yday) %>%
  replace_na(list(visits = 0)) %>%
  group_by(site, year, yday, bb.sp) %>%
  mutate(prop.visits = visits/sum(visits)) %>% # This will create NAs wherever a given bb=fl combo was all zeros, so we need to set the NAs to 0 
  replace_na(list(prop.visits = 0)) %>%
  arrange(site, year, yday, bb.sp, -prop.visits) %>%
  ungroup() %>%
  dplyr::select(year, site, yday, bb.sp, plant.sp, visits, prop.visits) # this is an attempt to manage the memory crashes I'm getting with the subsequent join step

### Join FL abundance data to FL visitation data
fl_abund_x_visitation <- visit_rates %>%
  inner_join(fl_abund_sp) %>%
  filter(fl.abund > 0 & prop.fl.abund < 1) %>% # Can't calculate preference where the plant.sp is absent or where it is the only plant present
  inner_join(bb_abund_sp, by = c("site", "year", "yday", "bb.sp")) %>%
  filter(bb.abund > 0) # Can't calculate preference where the bb.sp is absent

fl_abund_x_visitation.wm <- fl_abund_x_visitation %>%
  group_by(year, bb.sp, plant.sp) %>%
  summarize(prop.fl.abund.m = mean(prop.fl.abund),
            prop.visits.wm = weighted.mean(prop.visits, bb.abund))
```

### Okay, here's what we're going to do. Preference has a strong bimodal pattern, with lots of plant species totally ignored while the ones that are foraged upon are visited in proportion to their abundance. We can't model that latter pattern well if we retain all the totally ignored plant species. So, let's model the visited plants separately from the unvisited ones. 
```{r}
### Call linear model on the subset of the floral species that were visited at least once
pref.lm <- lm(log(prop.visits.wm) ~ log(prop.fl.abund.m), # log on log regression is common for proportional data
              data = filter(fl_abund_x_visitation.wm, prop.visits.wm > 0))

summary(pref.lm)
plot(pref.lm)

ggplot(filter(fl_abund_x_visitation.wm, prop.visits.wm > 0),
       aes(log(prop.fl.abund.m), log(prop.visits.wm))) +
  geom_point() +
  geom_smooth(method = "lm")

### Extract residuals
pref.lm.resid <- residuals(pref.lm) %>%
  data.frame() %>%
  as_tibble() %>%
  rename(preference = 1)
```

Join residuals back into data and summarize by site-date-bb.sp (this deserves its own code chunk)
```{r}
#################################
### Build preference data set ###
#################################
# Start with the mean prop.fl.abund and weighted mean prop.visits
pref <- fl_abund_x_visitation.wm %>%  
  ungroup() %>%

# Remove bb*fl*year combos that had 0 visits
  filter(prop.visits.wm > 0) %>% 
  
# With the zeroes removed, what's left can be joined 1:1 with the 
# residuals of the model above, i.e. the raw preference data
  bind_cols(pref.lm.resid) %>% 
  
# Exponentiate the residuals to back-transform the data and ensure 
# that preference is > 0 for all visited plant species.
  mutate(preference = exp(preference)) %>% 
  
# Now we need to add back all the bb*fl*year combos that had 0 visits
# They we have NAs for preference and for floral abundance columns
  full_join(unique(dplyr::select(visit_rates, year, bb.sp, plant.sp))) %>%
  
# Replace the NAs of the preference column with 0s; 
  replace_na(list(preference = 0)) %>%

# Drop the columns used to calculate preference so that they
# don't confuse us when we add site-date level abundance data
  dplyr::select(year, bb.sp, plant.sp, preference)
  
#################################
### Join with FL and BB abund ###
#################################
  
pref_wt_abund <- fl_abund_sp %>%
  full_join(pref, by = c("year", "plant.sp")) %>%  # This step introduces a small handful of NA because there were certain cases where a plant species was not observed at all in a given year. We will just omit those zeros from our data since they won't affect the analysis significantly
  mutate(fl.abund.weighted = fl.abund*preference) %>%
  group_by(site, year, yday, bb.sp) %>%
  summarize(fl.abund.weighted = sum(fl.abund.weighted, na.rm = TRUE)) %>%
  left_join(site_data, by = "site") %>%
  filter(!is.na(site)) %>%
  left_join(bb_abund_sp)
```

Preference-weighted floral abundance by year
```{r}
pref_sum <- pref_wt_abund %>%
  group_by(site, year, bb.sp) %>%
  summarize(fl.abund.weighted = mean(fl.abund.weighted))

ggplot(pref_sum, aes(year, fl.abund.weighted, color = bb.sp)) +
  geom_point()

ggplot(pref_sum, aes(year, log(fl.abund.weighted))) +
  geom_boxplot() +
  facet_wrap(~bb.sp, scales = "free")
```

GAM modeling of preference-weighted abundance per bb species
## Against any potential objections to my use of an added constant to avoid the log(0) problem, I would argue that when what is being measured is a resource, the presence of a resource in vanishingly small amounts is biologically equivalent to its absence. I suppose the strength of this argument hinges on how much we trust that our samples represent our sites. But if they don't, what are we even doing here? note that this argument does not hold when one is concerned with diversity and species distributions, since then a species rarity is a very different thing that its absence.
```{r}
### Set constants
k <- min(
  filter(pref_wt_abund, fl.abund.weighted > 0)$fl.abund.weighted
)

### Call models
weighted_fl_abundance.2010 <- bam(log(fl.abund.weighted + k) ~ te(yday, elev.mean, 
                                                  by = factor(bb.sp),
                                                  bs= c("tp", "tp"), 
                                                  k=c(10, 10), m=1),
                        data = filter(pref_wt_abund, year == 2010),
                        discrete = TRUE,
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2010)
summary(weighted_fl_abundance.2010)
print(plot(weighted_fl_abundance.2010 , allTerms = TRUE), pages = 4)

weighted_fl_abundance.2011 <- bam(log(fl.abund.weighted + k) ~ te(yday, elev.mean, 
                                                  by = factor(bb.sp),
                                                  bs= c("tp", "tp"), 
                                                  k=c(10, 10), m=1),
                        data = filter(pref_wt_abund, year == 2011),
                        discrete = TRUE,
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2011)
summary(weighted_fl_abundance.2011)
print(plot(weighted_fl_abundance.2011 , allTerms = TRUE), pages = 4)

weighted_fl_abundance.2012 <- bam(log(fl.abund.weighted + k) ~ te(yday, elev.mean, 
                                                  by = factor(bb.sp),
                                                  bs= c("tp", "tp"), 
                                                  k=c(10, 10), m=1),
                        data = filter(pref_wt_abund, year == 2012),
                        discrete = TRUE,
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2012)
summary(weighted_fl_abundance.2012)
print(plot(weighted_fl_abundance.2012 , allTerms = TRUE), pages = 4)
```

### Plotting bb.abund against fl.abund.weighted
```{r}
ggplot(pref_wt_abund, aes(log(fl.abund.weighted + 0.01), log(bb.abund), color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") +
  facet_wrap(~bb.sp, scales = "free")

ggplot(pref_wt_abund, aes(log(fl.abund.weighted + 0.01), log(bb.abund), color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm") 
```

### Plot fl.abund.weighted against phase and elev.class
```{r}
ggplot(pref_wt_abund, aes(phase, log(fl.abund.weighted + k), color = year)) +
  geom_boxplot() +
  facet_wrap(~bb.sp)

ggplot(pref_wt_abund, aes(elev.class2, log(fl.abund.weighted + k), color = year)) +
  geom_boxplot() +
  facet_wrap(~bb.sp)
```