---
title: "preference"
output: html_document
---
### Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidyverse)
library(lubridate)
```


### Climate data
```{r, include=FALSE, echo=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, year, date, gdd.cum) %>%
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  #dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low")))
```

### Load network and survey data
```{r}
### BB-FL visitation data
net <- read_csv("../processed_data/network.csv") %>%
  dplyr::select(site, date, bb.sp, plant.sp)

### Floral survey data
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

survey_dups <- survey %>%
  group_by(site, date, plant.sp) %>%
  mutate(dups = n()) %>%
  filter(dups > 1) 

dup_species <- survey_dups %>%
  group_by(plant.sp) %>%
  mutate(dups = n()/2) %>%
  group_by(site, date, plant.sp, dups) %>%
  mutate(different = length(unique(flower.cover)) -1) %>%
  group_by(site, date, plant.sp, dups) %>%
  summarize(different = mean(different)) %>%
  group_by(plant.sp, dups) %>%
  summarize(different.dups = sum(different)) %>% 
  arrange(-dups)


### Shared transects
shared_transects <- inner_join(net, survey, by = c("site", "date")) %>%
  dplyr::select(site, date) %>%
  unique() 
```

### FL and BB abundance / diversity
```{r echo=FALSE, include=FALSE}
### Per-transect BB abundance: species-level
bb_abund_sp <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  semi_join(shared_transects) %>% # I only want BB data with corresponding floral data
  group_by(site, date, bb.sp) %>% # group by bb.sp*transect (and other variables we want to retain)
  summarize(bb.abund = n()) %>% # get bb.sp*transect abundance
  ungroup %>%
  complete(site, date, bb.sp, fill = list(bb.abund = 0)) %>% # complete implicit absences
  mutate(year = factor(year(date)))

### Per-transect floral abund: by species
fl_abund_sp <- survey %>%
  semi_join(shared_transects) %>%
  group_by(site, date, plant.sp) %>% # group by plant.sp*transect
  summarize(fl.abund = sum(flower.cover)) %>% # get plant.sp*transect total flower cover; this step really shouldn't be required, but in a few cases, there is more than one abundance entry for the same species on a given transect; not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, I could drop the dups or average them. We'll see what Kalli and Fabrice have to say.
  group_by(site, date) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund)) %>% # get the proportional flower cover for each species.
  ungroup() %>%
  full_join(dplyr::select(net, site, date, plant.sp), by = c("site", "date", "plant.sp")) %>% # add the handful of species occurring in the visitation network but missing from the survey data
  complete(site, date, plant.sp, fill = list(fl.abund = 0, prop.fl.abund = 0)) %>%
  unique() %>%
  mutate(year = factor(year(date)))
```

### Get most important plants for each BB species
```{r}
# This creates a data set where each bumble bee species present at a given site*date is paired with each floral species present at a given site date, even if there was never a visitation between them.
observed_visits <- net %>%
  semi_join(shared_transects) %>% # include only site*date combos where floral surveying was done
  group_by(site, date, bb.sp, plant.sp) %>% # group by bb*plant*transect
  summarize(visits = n()) %>% # total visits per bb-fl pair
  group_by(site, date, bb.sp) %>%
  mutate(prop.visits = visits/sum(visits))

# All possible plants * site * date
possible_plants <- bind_rows(dplyr::select(net, c(site, date, plant.sp)),
                             dplyr::select(survey, c(site, date, plant.sp))) %>%
  unique() %>%
  complete(site, date, plant.sp)

# All possible bumbles * site * date
possible_bb <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  unique() %>%
  complete(site, date, bb.sp)

# All possible bumble-plant pairings *site * date, filtered to include only those when the given bb.sp was present and the given plant.sp was *either* present *or* visited (see note below)
visitation_by_abundance <- full_join(possible_plants, possible_bb) %>%
  left_join(bb_abund_sp) %>%
  left_join(fl_abund_sp) %>%
  filter(bb.abund > 0) %>%
  left_join(observed_visits) %>%
  filter(fl.abund > 0 | visits > 0) %>% # In about 10% of the bb.sp*plant.sp*site*year combos, the visited plant was not recorded in the floral survey data. There are a few different ways we could handle this, but I think an argument could be make that treating those plants as if they had zero abundance (even though they were evidently present gets close to the truth, since they must have been rather rare to have been missed in the surveying.)
  replace_na(list(visits = 0, prop.visits = 0))

#write_csv(visitation_by_abundance, "../analyses/output/visitation_by_abundance.csv") 

### Get mean abundance/visitation for each plant*bb combo
visitation_by_abundance_mean <- visitation_by_abundance %>%
  mutate(year = factor(year(date))) %>%
  group_by(plant.sp, bb.sp) %>%
  summarize(prop.fl.abund.m = mean(prop.fl.abund),
            prop.visits.wm = weighted.mean(prop.visits, bb.abund)) %>%
  mutate(selection.ratio = prop.visits.wm/prop.fl.abund.m)

write_csv(visitation_by_abundance_mean, "../analyses/output/visitation_by_abundance_mean.csv")

ggplot(filter(visitation_by_abundance_mean, prop.visits.wm > 0), 
       aes(log(prop.fl.abund.m + 0.01), log(prop.visits.wm))) +
  geom_point(alpha = 0.5, aes(color = bb.sp)) +
  geom_smooth(method = "lm")
```

### Okay, here's what we're going to do. Preference has a strong bimodal pattern, with lots of plant species totally ignored while the ones that are foraged upon are visited in proportion to their abundance. We can't model that latter pattern well if we retain all the totally ignored plant species. So, let's model the visited plants separately from the unvisited ones. 
```{r}
### Call linear model on the subset of the floral species that were visited at least once
# log on log regression is common for proportional datam (log ratio regression)
pref.lm <- lm(log(prop.visits.wm) ~ log(prop.fl.abund.m + 0.01), 
              data = filter(visitation_by_abundance_mean, prop.visits.wm > 0))

summary(pref.lm)
plot(pref.lm)

### Extract residuals
pref.lm.resid <- residuals(pref.lm) %>%
  data.frame() %>%
  as_tibble() %>%
  rename(preference = 1)
```

Join residuals back into data and summarize by site-date-bb.sp (this deserves its own code chunk)
```{r}
#################################
### Build preference data set ###
#################################
# Start with the mean prop.fl.abund and weighted mean prop.visits
preference <- visitation_by_abundance_mean %>%  
  ungroup() %>%

# Remove bb*fl*year combos that had 0 visits
  filter(prop.visits.wm > 0) %>% 
  
# With the zeroes removed, what's left can be joined 1:1 with the 
# residuals of the model above, i.e. the raw preference data
  bind_cols(pref.lm.resid) %>% 
  
# Exponentiate the residuals to back-transform the data and ensure 
# that preference is > 0 for all visited plant species.
  mutate(preference = exp(preference)) %>% 
  
# Now we need to add back all the bb*fl*year combos that had 0 visits
# Then we have NAs for preference and floral abundance columns
  full_join(unique(dplyr::select(visitation_by_abundance_mean, bb.sp, plant.sp))) %>%
  
# Replace the NAs of the preference column with 0s; 
  replace_na(list(preference = 0)) %>%

# Drop the columns used to calculate preference so that they
# don't confuse us when we add site-date level abundance data
  dplyr::select(bb.sp, plant.sp, preference)
  
#################################
### Join with FL and BB abund ###
#################################
bb_abund_sp_sum <- bb_abund_sp %>% # Get annual totals for BB species so that we can filter out really rare ones
  group_by(year, bb.sp) %>%
  summarize(bb.total.abund = sum(bb.abund))
  
fl_abund_wt <- fl_abund_sp %>%
  right_join(preference) %>% 
  mutate(fl.abund.wt = fl.abund*preference) %>%
  mutate(yday = yday(date)) %>%
  group_by(site, date, yday, bb.sp) %>%
  summarize(fl.abund.wt = sum(fl.abund.wt, na.rm = TRUE)) %>%
  ungroup() %>%
  left_join(bb_abund_sp) %>%
  left_join(bb_abund_sp_sum) %>%
  filter(bb.total.abund >= 5) %>%
  left_join(site_data, by = "site") %>%
  semi_join(survey, by = c("site", "date")) %>% # This gets rid of site*date combos that don't exist
  mutate(year = factor(year(date)), # add in the years missing from the bb_abund join
         bb.sp = factor(bb.sp), # convert bb.sp to a factor
         management = factor(management)) # convert management to a factor

write_csv(fl_abund_wt, "../analyses/output/fl_abund_wt.csv")
```

GAM modeling of preference-weighted abundance per bb species
## Against any potential objections to my use of an added constant to avoid the log(0) problem, I would argue that when what is being measured is a resource, the presence of a resource in vanishingly small amounts is biologically equivalent to its absence. I suppose the strength of this argument hinges on how much we trust that our samples represent our sites. But if they don't, what are we even doing here? note that this argument does not hold when one is concerned with diversity and species distributions, since then a species rarity is a very different thing that its absence.
```{r}
### Set constants
k <- min(
  filter(fl_abund_wt, fl.abund.wt > 0)$fl.abund.wt
)

### Call models
weighted_fl_abundance.2010.qp <- bam(fl.abund.wt ~ bb.sp + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2010),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2010.qp)
summary(weighted_fl_abundance.2010.qp)
print(plot(weighted_fl_abundance.2010.qp , allTerms = TRUE), pages = 4)

weighted_fl_abundance.2010.qp2 <- bam(sqrt(fl.abund.wt) ~ bb.sp + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2010),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2010.qp2)
summary(weighted_fl_abundance.2010.qp2)
print(plot(weighted_fl_abundance.2010.qp2, allTerms = TRUE), pages = 3)


weighted_fl_abundance.2011.qp <- bam(fl.abund.wt ~ bb.sp + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2011),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2011.qp)
summary(weighted_fl_abundance.2011.qp)
print(plot(weighted_fl_abundance.2011.qp , allTerms = TRUE), pages = 4)

weighted_fl_abundance.2011.qp2 <- bam(sqrt(fl.abund.wt) ~ bb.sp + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2011),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2011.qp2)
summary(weighted_fl_abundance.2011.qp2)
print(plot(weighted_fl_abundance.2011.qp2, allTerms = TRUE), pages = 4)

weighted_fl_abundance.2012.qp <- bam(fl.abund.wt ~ bb.sp + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2012),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2012.qp)
summary(weighted_fl_abundance.2012.qp)
print(plot(weighted_fl_abundance.2012.qp , allTerms = TRUE), pages = 4)

weighted_fl_abundance.2012.qp2_re <- bam(sqrt(fl.abund.wt) ~ s(bb.sp, bs = "re") + 
                                        management + 
                                        te(yday, elev.mean, 
                                           by = bb.sp,
                                           bs= c("tp", "tp"), 
                                           k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2012),
                        discrete = TRUE,
                        select = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2012.qp2_re)
summary(weighted_fl_abundance.2012.qp2_re)
print(plot(weighted_fl_abundance.2012.qp2_re, allTerms = TRUE), pages = 4)

weighted_fl_abundance.2012.qp2_p <- bam(sqrt(fl.abund.wt) ~ bb.sp + management + 
                                        te(yday, elev.mean, 
                                           by = bb.sp,
                                           bs= c("tp", "tp"), 
                                           k=c(10, 10), m=1),
                        data = filter(fl_abund_wt, year == 2012),
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.2012.qp2_p)
summary(weighted_fl_abundance.2012.qp2_p)
print(plot(weighted_fl_abundance.2012.qp2_p, allTerms = TRUE), pages = 4)


weighted_fl_abundance.qp2 <- bam(sqrt(fl.abund.wt) ~ bb.sp + year + te(yday, elev.mean, 
                                                            by = bb.sp,
                                                            bs= c("tp", "tp"), 
                                                            k=c(10, 10), m=1),
                        data = fl_abund_wt,
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_abundance.qp2)
summary(weighted_fl_abundance.qp2)
print(plot(weighted_fl_abundance.qp2 , allTerms = TRUE), pages = 4)

```

### Abundance mismatch
```{r}
mismatch <- fl_abund_wt %>%
  filter(!is.na(bb.abund)) %>%
  group_by(year, bb.sp) %>%
  mutate(bb.abund.rank = rank(-bb.abund, ties.method = "average"),
            fl.abund.wt.rank = rank(-fl.abund.wt, ties.method = "average"))

v <- c(10,9, 5, 8,7)
v.rank = rank(v)

ggplot(mismatch, aes(fl.abund.wt.rank, bb.abund.rank)) +
  geom_point() +
  facet_wrap(~bb.sp)

lm_mismatch <- lmer(bb.abund ~ log(fl.abund.wt + 0.01) + (1 +fl.abund.wt | bb.sp),
                    data = mismatch)
summary(lm_mismatch)
plot(lm_mismatch)

ggplot(mismatch, aes(log(fl.abund.wt + 0.01), sqrt(bb.abund))) +
  geom_point(aes(color = year)) +
  facet_wrap(~bb.sp, scales = "free")

mismatch_gam <- bam(bb.abund ~ bb.sp + year + s(log(fl.abund.wt + 0.01), by = bb.sp) + s(yday, k = 10),
                    family = "quasipoisson",
                    method = "fREML",
                    discrete = TRUE,
                    data = mismatch) %>% getViz()

check.gamViz(mismatch_gam)
summary(mismatch_gam)
print(plot(mismatch_gam , allTerms = TRUE), pages = 4)
```

### Now let's model floral richness, but considering only species with preference > 0
```{r}
fl_rich_wt <- fl_abund_sp %>%
  right_join(preference) %>% 
  filter(preference > 0 & fl.abund > 0) %>%
  mutate(yday = yday(date)) %>%
  group_by(site, date, yday, bb.sp) %>%
  summarize(fl.rich.wt = length(unique(plant.sp))) %>%
  ungroup() %>%
  left_join(bb_abund_sp) %>%
  left_join(site_data, by = "site") %>%
  semi_join(survey, by = c("site", "date")) %>% # This gets rid of site*date combos that don't exist
  mutate(year = factor(year(date)), # add in the years missing from the bb_abund join
         bb.sp = factor(bb.sp), # convert bb.sp to a factor
         management = factor(management)) # convert management to a factor

weighted_fl_rich <- bam(fl.rich.wt ~ bb.sp + year + te(yday, elev.mean, 
                                                by = bb.sp,
                                                bs= c("tp", "tp"), 
                                                k=c(10, 10), m=1),
                        data = fl_rich_wt,
                        discrete = TRUE,
                        family = "quasipoisson",
                        method = "fREML") %>% getViz()

check.gamViz(weighted_fl_rich)
summary(weighted_fl_rich)
print(plot(weighted_fl_rich , allTerms = TRUE), pages = 4)
```

