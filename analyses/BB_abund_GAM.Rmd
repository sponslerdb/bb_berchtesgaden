---
title: "BB_abund_GAM"
output: html_document
---
### Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidyverse)
library(lubridate)
```

### Climate data
```{r, include=FALSE, echo=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>% # make year a factor
  dplyr::select(site, year, date, gdd.cum) %>% # drop unused columns
  semi_join(read_csv("../processed_data/network.csv"), by = "site") # drop sites that were not samples
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")), # rename in English
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low")))
```

### Load network data
```{r}
### BB-FL visitation data
net <- read_csv("../processed_data/network.csv") %>%
  dplyr::select(site, date, bb.sp, plant.sp) # drop unused columns
```

### BB abundance / diversity
```{r echo=FALSE, include=FALSE}
### Per-transect BB abundance: species-level
bb_abund_sp <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  group_by(site, date, bb.sp) %>% # 
  summarize(bb.abund = n()) %>% # get per transect bb abundance
  ungroup() %>%
  complete(site, date, bb.sp, fill = list(bb.abund = 0)) %>% # complete implicit absences
  semi_join(net, by = c("site", "date")) %>% # drop site-dates that did not exist in the data set
  left_join(site_data) %>% # add site data
  mutate(year = factor(year(date)),
         yday = yday(date),
         bb.sp = factor(bb.sp),
         management = factor(management),
         site = factor(site),
         transect = factor(transect)) %>%
  group_by(year, bb.sp) %>%
  mutate(bb.total.abund = sum(bb.abund))
```

## Global GAM: this is more elegant than breaking it down by year, but my concern is that the model will be totally dominated by the 2012 data, since I have so many more samples that year.
```{r}
bb_abund.global <- bam(bb.abund ~
                         s(bb.sp, bs = "re") +
                         s(year, bs = "re") +
                         s(site, bs = "re") + ### I think I need to include site as a random effect because if I don't the pseudoreplication of elevation is pretty extreme, especially in 2012 where I have lots of repeated measures. I am not, for example, measuring floral abundance at 1000 m 20 independent times; I'm measuring it 20 times at the same spot. This does, of  course, create identifiability issues insofar as site and elevation are concurved. But I think I need to accept these problems.
                         te(yday, elev.mean, 
                                   by = bb.sp,
                                   #id = 0,
                                   bs= c("gp", "tp"), 
                                   k=c(8, 8), 
                                   m=1) +
                         te(yday, elev.mean, 
                                   by = year,
                                   #id = 0,
                                   bs= c("gp", "tp"), 
                                   k=c(4, 4), 
                                   m=2),
                       data = filter(bb_abund_sp, bb.total.abund >= 5),
                       discrete = TRUE,
                       family = "tw",
                       select = TRUE,
                       method = "fREML") %>% getViz(nsim = 500)

bb_abund.global2 <- gam(bb.abund ~
                s(bb.sp, bs = "re") +
                s(year, bs = "re") +
                s(site, bs = "re") +
                te(yday, elev.mean, 
                          by = bb.sp,
                          #id = 0,
                          bs= c("gp", "tp"), 
                          k=c(6, 6), 
                          m=1) +
                te(yday, elev.mean, 
                          by = year,
                          #id = 0,
                          bs= c("gp", "tp"), 
                          k=c(4, 4), 
                          m=2),
              data = filter(bb_abund_sp, bb.total.abund >= 5 & bb.sp %in% c("bss", "pasc", "prat", "pyre")),
              discrete = FALSE,
              family = ziP(),
              select = TRUE,
              method = "REML") %>% getViz(nsim = 500)

ziptest <- gam(bb.abund ~
                t2(yday, elev.mean, 
                          by = bb.sp,
                          #id = 0,
                          bs= c("gp", "tp"), 
                          k=c(3, 3), 
                          m=1),
              data = filter(bb_abund_sp, bb.total.abund >= 5),
              #discrete = FALSE,
              family = ziP(),
              select = TRUE,
              method = "REML") %>% getViz(nsim = 50)

check.gamViz(bb_abund.global)
check.gamViz(bb_abund.global2)
check.gamViz(ziptest)


bb_abund.global.sum <- summary(bb_abund.global)
bb_abund.global2.sum <- summary(bb_abund.global2)

AIC(bb_abund.global, bb_abund.global2)

print(plot(bb_abund.global, allTerms = TRUE), pages = 3)
print(plot(bb_abund.global2, allTerms = TRUE), pages = 3)

bb_abund.global.ck <- check2D(bb_abund.global, x1 = "yday", x2 = "elev.mean")
bb_abund.global.ck + l_gridCheck2D(gridFun = mean)
```

## Annual GAMs
### My argument for not including site as a random effect is that it would create identifiability issues with the elevation variable that I am actally interested in. This will probably cause the p-values to be underestimated, maybe to the point of being uninformative. But I don't think I care. My goal is not to establish inferentially that time and elevation affect BB abundance; I want to say how they do. And I don't want to obscure the "how" for the sake of inferential scruples.  
```{r}
### 2010
bb_abund.2010 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2010 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2010)
bb_abund.2010.sum <- summary(bb_abund.2010)
print(plot(bb_abund.2010, allTerms = TRUE), pages = 1)
bb_abund.2010.ck <- check2D(bb_abund.2010, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals

### 2011
bb_abund.2011 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2011 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2011)
bb_abund.2011.sum <- summary(bb_abund.2011)
print(plot(bb_abund.2011, allTerms = TRUE), pages = 1)
bb_abund.2011.ck <- check2D(bb_abund.2011, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals

### 2012
bb_abund.2012 <- bam(bb.abund ~ 
                       s(bb.sp, bs = "re") + 
                       te(yday, elev.mean, 
                          by = bb.sp,
                          bs= c("gp", "cr"), 
                          k=c(8, 8), 
                          m=2),
                     data = filter(bb_abund_sp, year == 2012 & bb.total.abund >= 5),
                     discrete = TRUE,
                     family = "tw",
                     select = TRUE,
                     method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_abund.2012)
bb_abund.2012.sum <- summary(bb_abund.2012)
print(plot(bb_abund.2012, allTerms = TRUE), pages = 1)
bb_abund.2012.ck <- check2D(bb_abund.2012, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals
```

# Extract predictions
```{r}
# Function to build data set over which to generate predictions
newdata_build <- function(dat, y) {
  
  ## yday min/max
  min_yday <- min(filter(dat, year == y)$yday)
  max_yday <- max(filter(dat, year == y)$yday)
  
  ## elev min.max
  min_elev <- min(filter(dat, year == y)$elev.mean)
  max_elev <- max(filter(dat, year == y)$elev.mean)
  
  ## species list
  spp <- dat %>%
    filter(year == y & bb.total.abund >= 5) %>%
    select(bb.sp) %>%
    unique() %>%
    na.omit() ##### NEED TO FIGURE OUT WHERE THE NA COMES FROM!
  
  # sequence of 50 points along the yday and elev ranges, respectively
  seq_yday <- seq(min_yday, max_yday, length.out = 50)
  seq_elev <- seq(min_elev, max_elev, length.out = 50)
  
  newdata <- tibble(seq_yday, seq_elev) %>% # combine seqs into data frame
    complete(seq_yday, seq_elev) %>% # get all possible values
    crossing(spp) %>% # get all possible combos with species
    select(yday = seq_yday, elev.mean = seq_elev, bb.sp) # rename columns to match the original model inputs
}

newdata2010 <- newdata_build(bb_abund_sp, 2010)
newdata2011 <- newdata_build(bb_abund_sp, 2011)
newdata2012 <- newdata_build(bb_abund_sp, 2012)

# A little wrapper to make predictions and return a tibble with desired columns 
predict_func <- function(mod, new, y) {
  predict.bam(mod, newdata = new, type = "response") %>%
    data.frame() %>%
    tibble() %>%
    bind_cols(new) %>%
    select(yday, elev.mean, bb.sp, pred = 1) %>%
    mutate(year = rep(y, n()))
}

# Generate predictions
predict2010 <- predict_func(bb_abund.2010, newdata2010, 2010)
predict2011 <- predict_func(bb_abund.2011, newdata2011, 2011)
predict2012 <- predict_func(bb_abund.2012, newdata2012, 2012)
predict_pool <- bind_rows(predict2010, predict2011, predict2012)

# Subset predictions
predict_major <- filter(predict_pool, bb.sp %in% c("bss", "pasc", "prat", "soro", "wurf"))
predict_highelev <- filter(predict_pool, bb.sp %in% c("pyre", "mend", "mont"))
predict_minor <- filter(predict_pool, bb.sp %in% c("gers", "hort", "hypn","jone", "lapi", "muci"))

ggplot(predict_major, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_highelev, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)

ggplot(predict_minor, aes(yday, elev.mean, fill = log(pred))) +
  geom_raster() +
  geom_contour(aes(z = log(pred)), color = "black", size = 0.25) +
  scale_fill_viridis_c() +
  facet_grid(year~bb.sp)
```

## Bumble bee species richness
```{r}
bb_rich <- bb_abund_sp %>%
  filter(bb.abund > 0) %>%
  group_by(site, date, yday, year, elev.mean, management) %>%
  summarize(bb.rich = length(unique(bb.sp)))
```

## Global species richness GAM (no need to separate the years, meiner Meinung nach)
```{r}
### 2010
bb_rich.global <- bam(bb.rich ~ 
                        te(yday, elev.mean, 
                           by = year,
                           bs= c("gp", "cr"), 
                           k=c(6, 6), 
                           m=2),
                      data = filter(bb_rich),
                      discrete = TRUE,
                      family = "gaussian",
                      select = TRUE,
                      method = "fREML") %>% getViz(nsim = 500)


check.gamViz(bb_rich.global)
bb_rich.global.sum <- summary(bb_rich.global)
print(plot(bb_rich.global, allTerms = TRUE), pages = 1)
bb_rich.global.ck <- check2D(bb_rich.global, x1 = "yday", x2 = "elev.mean") # See if there is any spatiotemporal pattern to the residuals
```
