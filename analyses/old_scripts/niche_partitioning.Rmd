---
title: "Flexibility and constraints in resource selection within a generalist pollinator guild"
output: html_document
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(bipartite)
library(mgcv)
library(mgcViz)
library(ggbipart)
library(GGally)
library(vegan)
library(ggvegan)
library(tidyverse)
library(lubridate)
library(patchwork)
library(tidymodels)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
### Load data

# Site data
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, 
                   elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, 
                             levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, 
                             levels = c("high", "mid", "low"))) # turn elav.class into an ordered factor

# Climate data
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, date, gdd.cum)

total_gdd <- gdd %>%
  mutate(year = factor(year(date))) %>%
  group_by(site, year) %>%
  summarize(total.gdd = max(gdd.cum))

# Network
net <- read_csv("../processed_data/network.csv") %>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  mutate(year = factor(year)) %>% # convert year to factor
  left_join(site_data, by = "site") %>%
  left_join(gdd, by = c("site", "date")) %>%
  ungroup() %>%
  arrange(site, date)

ggplot(net, aes(bb.sp, fill = pollen)) +
  geom_bar(position = "fill")

# Floral survey
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

# BB traits
bb_traits <- read_csv("../processed_data/bb_traits.csv") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf"))

# FL traits
fl_tax <- read_csv("../processed_data/floral_tax.csv")
  
fl_ktype <- read_csv("../processed_data/floral_k_type.csv") %>%
  select(plant.sp, plant.genus = genus, k.type) %>%
  mutate(k.type.s = str_extract(k.type, "[-+]?[0-9]*\\.?[0-9]+"),
         k.type.ss = str_extract(k.type, "[-+]?[0-9]*"))

fl_morph <- read_csv("../processed_data/flower_morphology_GitaBenadi.csv") %>%
  select(SampleID, plant.family = Family, plant.sp = Species, 
         Unit, Flowers_per_unit, diam = Diameter, LN) %>%
  group_by(plant.sp) %>%
  summarize(diam = mean(diam),
            LN = mean(LN))

fl_ktype_key <- read_delim("../processed_data/kugler_key.tsv", delim = "\t", col_names = FALSE) %>%
  select(k.type = 1, description = 2)

fl_traits <- fl_tax %>%
  full_join(fl_ktype) %>%
  full_join(fl_morph) %>%
  select(plant.sp, plant.genus, plant.family, 
         k.type, k.type.s, k.type.ss, diam, LN)

### Auxiliary data, i.e. all the covariates we need to control for
BB_covars <- net %>%
  group_by(site, year, date) %>%
  summarize(bb.rich = length(unique(bb.sp)),
            sqrt.bb.abund = sqrt(n()))

FL_covars <- survey %>%
  mutate(year = factor(year(date))) %>%
  filter(flower.cover > 0) %>%
  group_by(site, year, date) %>%
  summarize(fl.rich = length(unique(plant.sp)),
            log.fl.abund = log(sum(flower.cover))) 

BB_covars.site <- net %>%
  group_by(site, year) %>%
  summarize(bb.rich = length(unique(bb.sp)),
            sqrt.bb.abund = sqrt(n()))

FL_covars.site <- survey %>%
  mutate(year = factor(year(date))) %>%
  filter(flower.cover > 0) %>%
  group_by(site, year) %>%
  summarize(fl.rich = length(unique(plant.sp)),
            log.fl.abund = log(sum(flower.cover))) 

BB_covars.mean <- net %>%
  group_by(site, year, date) %>%
  summarize(bb.rich = length(unique(bb.sp)),
            bb.abund = n()) %>%
  group_by(site, year) %>%
  summarize(mean.bb.rich = mean(bb.rich),
            mean.sqrt.bb.abund = sqrt(mean(bb.abund)))

FL_covars.mean <- survey %>%
  mutate(year = factor(year(date))) %>%
  filter(flower.cover > 0) %>%
  group_by(site, year, date) %>%
  summarize(fl.rich = length(unique(plant.sp)),
            fl.abund = sum(flower.cover))  %>%
  group_by(site, year) %>%
  summarize(mean.fl.rich = mean(fl.rich),
            mean.log.fl.abund = log(mean(fl.abund)))

### Species names and such for plotting
species_names <- cbind(c("bss", "pasc", "prat", 
                         "soro", "wurf", "hort", 
                         "pyre", "mend", "mont", 
                         "gers", "hypn","jone", 
                         "lapi", "muci", "psit", 
                         "humi"),
                       c("B. sensu-strictu", "B. pascuorum", "B. pratorum", 
                         "B. soroensis", "B. wurflenii", "B. hortorum",
                         "B. pyrenaeus", "B. mendax", "B. monticola",
                         "B. gerstaeckeri", "B. hypnorum", "B. jonellus", 
                         "B. lapidarius", "B. mucidus", "B. psithyrus", 
                         "B. humilis"),
                       c("B. ss.", "B. pasc.", "B. prat.", 
                         "B. soro.", "B. wurf.", "B. hort.",
                         "B. pyre.", "B. mend.", "B. mont.",
                         "B. gers.", "B. hypn.", "B. jone.", 
                         "B. lapi.", "B. muci.", "B. psit.", 
                         "B. humi"),
                       c("major", "major", "major", 
                         "major", "major", "common", 
                         "high elev.", "high elev.", "high elev.",
                         "minor", "minor", "common", 
                         "minor", "minor", "common", 
                         "minor")
                       ) %>%
  as.data.frame() %>%
  as_tibble() %>%
  dplyr::select(bb.sp = 1, species.name = 2, species.abb = 3, abund.class = 4) %>%
  mutate(focal = if_else(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf"), TRUE, FALSE))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
### Species-level by transect
bb_abund.transect <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  group_by(bb.sp, site, date, year) %>%
  summarize(bb.sp.abund = n())

bb_abund.site <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  group_by(bb.sp, site, year) %>%
  summarize(bb.sp.abund = n())
  
niche_overlap.sp <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>% # focal species
  filter(!is.na(pollen)) %>% # drop observations with no pollen/nectar classification
  group_by(bb.sp, pollen, plant.sp, site, date, year) %>% # group by transect and BB-FL pair
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per transect
  group_by(bb.sp, pollen, site, date, year) %>% # group by transect and BB species
  mutate(prop = freq/sum(freq)) %>% # get proportional interaction frequency for each BB-FL pair
  select(-freq) %>% # drop freq variable
  pivot_wider(names_from = plant.sp, values_from = prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  group_by(pollen, site, date, year) %>%
  nest() %>% # nest into list-column
  mutate(data2 = map(data, function(x) column_to_rownames(x, var = "bb.sp")), # column to rownames
         dist = map(data2, function(x) vegdist(x, method = "horn")), # convert to Horn's distance matrix
         tidy_dist = map(dist, tidy)) %>% # convert to tidy array of Horn's distances
  select(pollen, site, date, year, tidy_dist) %>% # drop intermediate list-columns
  unnest(cols = c(tidy_dist)) %>% # unnest back into a single data frame
  left_join(site_data) %>% # add site data
  select(site, date, year, pollen, bb.sp1 = item1, bb.sp2 = item2, distance, elev.mean) %>% # select and rename vars
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>% # add traits for bb.sp1
  rename(subgenus1 = subgenus, pbl.w1 = pbl.w, pbl.w.class1 = pbl.w.class) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>% # add traits for bb.sp2
  rename(subgenus2 = subgenus, pbl.w2 = pbl.w, pbl.w.class2 = pbl.w.class) %>%
  select(site, date, year, pollen, bb.sp1, bb.sp2, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  left_join(bb_abund.transect, by = c("bb.sp1" = "bb.sp", "site", "date", "year")) %>%
  rename(bb.sp1.abund = bb.sp.abund) %>%
  select(site, date, year, pollen, bb.sp1, bb.sp2, bb.sp1.abund, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  left_join(bb_abund.transect, by = c("bb.sp2" = "bb.sp", "site", "date", "year")) %>%
  rename(bb.sp2.abund = bb.sp.abund) %>%
  select(site, date, year, pollen, bb.sp1, bb.sp2, bb.sp1.abund, bb.sp2.abund, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  mutate(pbl.diff = abs(pbl.w1 - pbl.w2), # tongue length differences
         yday = yday(date), # yday variable will come in handy
         abund.diff = abs(bb.sp1.abund - bb.sp2.abund),
         subgenus.diff = if_else(subgenus1 == subgenus2, "same", "different"), # binary: same or different subgenus
         
         # Logical columns indicating whether a given species belongs to a given species pair
         # This is handy for extracting data for individual species across all their counterparts
         bss = if_else(bb.sp1 == "bss" | bb.sp2 == "bss", TRUE, FALSE),
         pasc = if_else(bb.sp1 == "pasc" | bb.sp2 == "pasc", TRUE, FALSE),
         wurf = if_else(bb.sp1 == "wurf" | bb.sp2 == "wurf", TRUE, FALSE),
         prat = if_else(bb.sp1 == "prat" | bb.sp2 == "prat", TRUE, FALSE),
         soro = if_else(bb.sp1 == "soro" | bb.sp2 == "soro", TRUE, FALSE),
         hort = if_else(bb.sp1 == "hort" | bb.sp2 == "hort", TRUE, FALSE)) %>%
  
  unite(sp.pair, c(bb.sp1, bb.sp2), sep = ":") %>% # create a single species pair column...
  mutate(sp.pair = factor(sp.pair)) %>% # ...and make it a factor so that mgcv can handle it
  left_join(BB_covars) %>% # add BB covars
  left_join(FL_covars) %>% # add floral covars
  mutate(niche.overlap = 1-distance) # express niche overlap so that 1 = perfect overlap and 0 = no overlap

niche_overlap.sp_site <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>% # focal species
  filter(!is.na(pollen)) %>% # drop observations with no pollen/nectar classification
  group_by(bb.sp, pollen, plant.sp, site, year) %>% # group by site-year and BB-FL pair
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-year
  group_by(bb.sp, pollen, site, year) %>% # group by site-year and BB species
  mutate(prop = freq/sum(freq)) %>% # get proportional interaction frequency for each BB-FL pair
  select(-freq) %>% # drop freq variable
  pivot_wider(names_from = plant.sp, values_from = prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  group_by(pollen, site, year) %>%
  nest() %>% # nest into list-column
  mutate(data2 = map(data, function(x) column_to_rownames(x, var = "bb.sp")), # column to rownames
         dist = map(data2, function(x) vegdist(x, method = "horn")), # convert to Horn's distance matrix
         tidy_dist = map(dist, tidy)) %>% # convert to tidy array of Horn's distances
  select(pollen, site, year, tidy_dist) %>% # drop intermediate list-columns
  unnest(cols = c(tidy_dist)) %>% # unnest back into a single data frame
  left_join(site_data) %>% # add site data
  select(site, year, pollen, bb.sp1 = item1, bb.sp2 = item2, distance, elev.mean) %>% # select and rename vars
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>% # add traits for bb.sp1
  rename(subgenus1 = subgenus, pbl.w1 = pbl.w, pbl.w.class1 = pbl.w.class) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>% # add traits for bb.sp2
  rename(subgenus2 = subgenus, pbl.w2 = pbl.w, pbl.w.class2 = pbl.w.class) %>%
  select(site, year, pollen, bb.sp1, bb.sp2, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  left_join(bb_abund.site, by = c("bb.sp1" = "bb.sp", "site", "year")) %>%
  rename(bb.sp1.abund = bb.sp.abund) %>%
  select(site, year, pollen, bb.sp1, bb.sp2, bb.sp1.abund, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  left_join(bb_abund.site, by = c("bb.sp2" = "bb.sp", "site", "year")) %>%
  rename(bb.sp2.abund = bb.sp.abund) %>%
  select(site, year, pollen, bb.sp1, bb.sp2, bb.sp1.abund, bb.sp2.abund, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  mutate(pbl.diff = abs(pbl.w1 - pbl.w2), # tongue length differences
         abund.diff = abs(bb.sp1.abund - bb.sp2.abund),
         subgenus.diff = if_else(subgenus1 == subgenus2, "same", "different"), # binary: same or different subgenus
         
         # Logical columns indicating whether a given species belongs to a given species pair
         # This is handy for extracting data for individual species across all their counterparts
         bss = if_else(bb.sp1 == "bss" | bb.sp2 == "bss", TRUE, FALSE),
         pasc = if_else(bb.sp1 == "pasc" | bb.sp2 == "pasc", TRUE, FALSE),
         wurf = if_else(bb.sp1 == "wurf" | bb.sp2 == "wurf", TRUE, FALSE),
         prat = if_else(bb.sp1 == "prat" | bb.sp2 == "prat", TRUE, FALSE),
         soro = if_else(bb.sp1 == "soro" | bb.sp2 == "soro", TRUE, FALSE),
         hort = if_else(bb.sp1 == "hort" | bb.sp2 == "hort", TRUE, FALSE)) %>%
  
  unite(sp.pair, c(bb.sp1, bb.sp2), sep = ":") %>% # create a single species pair column...
  mutate(sp.pair = factor(sp.pair)) %>% # ...and make it a factor so that mgcv can handle it
  left_join(BB_covars.site) %>% # add BB covars
  left_join(FL_covars.site) %>% # add floral covars
  mutate(niche.overlap = 1-distance) # express niche overlap so that 1 = perfect overlap and 0 = no overlap


niche_overlap.sp.strongpairs <- niche_overlap.sp %>%
  filter(bb.sp1.abund >= 5 & bb.sp2.abund >= 5)

niche_overlap.sp.mean <- niche_overlap.sp %>%
  group_by(pollen, sp.pair, site, year, elev.mean, pbl.diff, subgenus.diff, 
           bss, pasc, wurf, prat, soro, hort) %>%
  summarize(mean.niche.overlap = mean(niche.overlap)) %>%
  left_join(BB_covars.mean) %>%
  left_join(FL_covars.mean)

niche_overlap.sp.mean2x <- niche_overlap.sp %>%
  group_by(pollen, site, year, date, elev.mean) %>% # Average across species pairs within transects
  summarize(mean.niche.overlap = mean(niche.overlap)) %>% 
  group_by(pollen, site, year, elev.mean) %>% # Average across transects
  summarize(mean.niche.overlap = mean(mean.niche.overlap)) %>% 
  left_join(BB_covars.mean) %>%
  left_join(FL_covars.mean)


### K-type by transect
niche_overlap.ktype <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(!is.na(pollen)) %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, pollen, k.type.s, site, date, year) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair
  group_by(bb.sp, pollen, site, date, year) %>%
  mutate(prop = freq/sum(freq)) %>% # get proportional interaction frequency for each BB-FL pair
  select(-freq) %>% # drop freq variable
  #unite(ID, c(bb.sp, pollen), sep = "_"),
  pivot_wider(names_from = k.type.s, values_from = prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  group_by(pollen, site, date, year) %>%
  nest() %>% # nest into list-column
  mutate(data2 = map(data, function(x) column_to_rownames(x, var = "bb.sp")), # column to rownames
         dist = map(data2, function(x) vegdist(x, method = "horn")), # convert to Horn's distance matrix
         tidy_dist = map(dist, tidy)) %>% # convert to tidy array of Horn's distances
  select(pollen, site, date, year, tidy_dist) %>% # drop intermediate list-columns
  unnest(cols = c(tidy_dist)) %>% # unnest back into a single data frame
  left_join(site_data) %>% # add site data
  select(site, date, year, pollen, bb.sp1 = item1, bb.sp2 = item2, distance, elev.mean) %>% # select and rename vars
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>% # add traits for bb.sp1
  rename(subgenus1 = subgenus, pbl.w1 = pbl.w, pbl.w.class1 = pbl.w.class) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>% # add traits for bb.sp2
  rename(subgenus2 = subgenus, pbl.w2 = pbl.w, pbl.w.class2 = pbl.w.class) %>%
  select(site, date, year, pollen, bb.sp1, bb.sp2, subgenus1, subgenus2, distance, 
         pbl.w1, pbl.w2, pbl.w.class1, pbl.w.class2, elev.mean) %>%
  mutate(pbl.diff = abs(pbl.w1 - pbl.w2), # tongue length differences
         yday = yday(date), # yday variable will come in handy
         subgenus.diff = if_else(subgenus1 == subgenus2, "same", "different"), # binary: same or different subgenus
         
         # Logical columns indicating whether a given species belongs to a given species pair
         # This is handy for extracting data for individual species across all their counterparts
         bss = if_else(bb.sp1 == "bss" | bb.sp2 == "bss", TRUE, FALSE),
         pasc = if_else(bb.sp1 == "pasc" | bb.sp2 == "pasc", TRUE, FALSE),
         wurf = if_else(bb.sp1 == "wurf" | bb.sp2 == "wurf", TRUE, FALSE),
         prat = if_else(bb.sp1 == "prat" | bb.sp2 == "prat", TRUE, FALSE),
         soro = if_else(bb.sp1 == "soro" | bb.sp2 == "soro", TRUE, FALSE),
         hort = if_else(bb.sp1 == "hort" | bb.sp2 == "hort", TRUE, FALSE)) %>%
  
  unite(sp.pair, c(bb.sp1, bb.sp2), sep = ":") %>% # create a single species pair column...
  mutate(sp.pair = factor(sp.pair)) %>% # ...and make it a factor so that mgcv can handle it
  left_join(BB_covars) %>% # add BB covars
  left_join(FL_covars) %>% # add floral covars
  mutate(niche.overlap = 1-distance) # express niche overlap so that 1 = perfect overlap and 0 = no overlap

niche_overlap.ktype.mean <- niche_overlap.ktype %>%
  group_by(pollen, sp.pair, site, year, elev.mean, pbl.diff, subgenus.diff, 
           bss, pasc, wurf, prat, soro, hort) %>%
  summarize(mean.niche.overlap = mean(niche.overlap)) %>%
  left_join(BB_covars.mean) %>%
  left_join(FL_covars.mean)

niche_overlap.ktype.mean2x <- niche_overlap.ktype %>%
  group_by(pollen, site, year, date, elev.mean) %>% # Average across species pairs within transects
  summarize(mean.niche.overlap = mean(niche.overlap)) %>% 
  group_by(pollen, site, year, elev.mean) %>% # Average across transects
  summarize(mean.niche.overlap = mean(mean.niche.overlap)) %>% 
  left_join(BB_covars.mean) %>%
  left_join(FL_covars.mean)
```

### This story starts with three observations arising from my first set of analyses.  

  1. The bumble bee species in the Berchtesgaden system -- even the abundant and widespread ones -- exhibit substantial non-overlap in resource use (Figure 1).
  2. The bumble bee community exhibits little turnover in space/elevation and time.
  3. The floral community exhibits dramatic turnover in space/elevation and time.
  
### We will focus on six species that are abundant and widespread:  
  1. *B. sensu-strictu*
  2. *B. pascuorum*
  3. *B. pratorum*
  4. *B. hortorum*
  5. *B. soroensis*
  6. *B. wurflenii*

```{r fig.cap="**Figure 1: Focal species**", message=FALSE, warning=FALSE, echo=FALSE}
bb_range.year <- net %>%
  left_join(site_data) %>%
  group_by(site, date, elev.mean, bb.sp, year) %>%
  summarize(abund = n()) %>%
  group_by(site, elev.mean, bb.sp, year) %>%
  summarize(abund = mean(abund)) %>%
  group_by(bb.sp) %>%
  mutate(elev.floor = min(elev.mean),
         elev.ceiling = max(elev.mean),
         elev.range = elev.ceiling - elev.floor,
         elev.med = elev.floor + ((elev.ceiling - elev.floor)/2)) %>%
  left_join(species_names) 

ggplot(bb_range.year, aes(reorder(bb.sp, elev.med), elev.mean, color = focal)) +
  geom_line(size = 2, alpha = 0.25) +
  geom_point(aes(size = abund), alpha = 0.5) +
  facet_wrap(~year, ncol = 1) +
  theme_light(12) +
  scale_size_continuous(name = "Abundance") +
  scale_color_discrete(name = "Focal species") +
  xlab("BB species") +
  ylab("Elevation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
  
### To improve readability, we will bin our floral taxa to family level. 
```{r fig.cap="**Figure 2: Metaweb diagram**", message=FALSE, warning=FALSE, echo=FALSE}
# Species level
## All
metaweb.sp <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.sp")

## Nectar
metaweb.sp.n <- net %>%
  filter(pollen == "nopollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.sp")

## Pollen
metaweb.sp.p <- net %>%
  filter(pollen == "pollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.sp")

# Family level
## All
metaweb.fam <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.family) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.family")

## Nectar
metaweb.fam.n <- net %>%
  filter(pollen == "nopollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.family) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.family")

## Pollen
metaweb.fam.p <- net %>%
  filter(pollen == "pollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, plant.family) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace(is.na(.), 0) %>%
  column_to_rownames("plant.family")

# K-type
## All
metaweb.ktype <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, k.type.s) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace_na(replace = list(bss = 0, hort = 0, pasc = 0, prat = 0, soro = 0, wurf = 0)) %>%
  replace_na(replace = list(k.type.s = "undet")) %>%
  column_to_rownames("k.type.s")

## Nectar
metaweb.ktype.n <- net %>%
  filter(pollen == "nopollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, k.type.s) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace_na(replace = list(bss = 0, hort = 0, pasc = 0, prat = 0, soro = 0, wurf = 0)) %>%
  replace_na(replace = list(k.type.s = "undet")) %>%
  column_to_rownames("k.type.s")

## Pollen
metaweb.ktype.p <- net %>%
  filter(pollen == "pollen") %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  separate(plant.sp, c("plant.genus", "species"), sep = " ") %>%
  left_join(fl_traits) %>%
  group_by(bb.sp, k.type.s) %>%
  summarize(freq = n()) %>%
  pivot_wider(names_from = bb.sp, values_from = freq) %>%
  replace_na(replace = list(bss = 0, hort = 0, pasc = 0, prat = 0, soro = 0, wurf = 0)) %>%
  replace_na(replace = list(k.type.s = "undet")) %>%
  column_to_rownames("k.type.s")


#visweb(metaweb.sp, type = "diagonal", labsize = 2, pred.lablength = 5, prey.lablength = 5)
#visweb(metaweb.gen, type = "diagonal", labsize = 2, pred.lablength = 5, prey.lablength = 5)
visweb(metaweb.fam, type = "diagonal", labsize = 2, pred.lablength = 5, prey.lablength = 5)
visweb(metaweb.fam.n, type = "diagonal", labsize = 2, pred.lablength = 5, prey.lablength = 5)
visweb(metaweb.fam.p, type = "diagonal", labsize = 2, pred.lablength = 5, prey.lablength = 5)
# visweb(metaweb.ktype.s, type = "diagonal", labsize = 1, pred.lablength = 5, prey.lablength = 5)
# visweb(metaweb.ktype.ss, type = "diagonal", labsize = 1, pred.lablength = 5, prey.lablength = 5)
# 
# plotweb(metaweb.sp, text.rot = 90, labsize = 1, low.lablength = 5)
# plotweb(metaweb.gen, text.rot = 90, labsize = 1, low.lablength = 5)
plotweb(metaweb.fam, text.rot = 90, labsize = 1, low.lablength = 5)
plotweb(metaweb.fam.n, text.rot = 90, labsize = 1, low.lablength = 5)
plotweb(metaweb.fam.p, text.rot = 90, labsize = 1, low.lablength = 5)
# plotweb(metaweb.ktype.s, text.rot = 90, labsize = 1, low.lablength = 5)
# plotweb(metaweb.ktype.ss, text.rot = 90, labsize = 1, low.lablength = 5)
```
  
### H0: Does niche overlap differ from that predicted by random foraging?
#### Random null model
```{r message=FALSE, warning=FALSE}
### Define function that will be used inside map() calls
df_to_cmat <- function(x) {
  pivot_wider(x, names_from = plant.sp, values_from = freq) %>%
    replace(is.na(.), 0)
}

permat_set <- function(x){
  x %>%
    column_to_rownames("bb.sp") %>%
    vegan::permatfull(fixedmar = "rows", shuffle = "ind", times = 99)
}

ret <- function(x){
  return(x$perm)
}

tidy_dist <- function(x) {
  x %>%
    tidy() %>%
    mutate(index = seq_along())
}

### Generate random niche overlap data
#### Need to look into th the missing value warnings I'm getting from the vegdist() call; I think it's because some plants end up with zero visits in some permutations.
random_niche <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>% # focal species
  filter(!is.na(pollen)) %>% # drop observations with no pollen/nectar classification
  select(site, date, pollen, year, bb.sp, plant.sp) %>% 
  group_by(bb.sp, pollen, plant.sp, site, date) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair
  group_by(pollen, site, date) %>%
  nest() %>% # nest data into list-column grouped by pollen, site, date
  mutate(data = map(data, df_to_cmat), # turn table into community matrix
         data = map(data, permat_set), # permute community matrices
         data = map(data, ret)) %>% # extract permutations from permat objects
  unnest(data) %>% # unnest
  mutate(data = map(data, function(x) vegdist(x, method = "horn")), # convert each permutation into distance matrix
         data = map(data, tidy)) %>% # convert distance matrices to tidy arrays
  group_by(pollen, site, date) %>%
  mutate(iter = row_number()) %>% # add index to denote iterations
  unnest(cols = data) %>% # unnest again
  rename(bb.sp1 = item1, bb.sp2 = item2) %>%
  unite(sp.pair, c(bb.sp1, bb.sp2), sep = ":") %>% # create a single species pair column...
  mutate(sp.pair = factor(sp.pair), # ...and make it a factor so that mgcv can handle it
         niche.overlap = 1-distance) %>% # express niche overlap so that 1 = perfect overlap and 0 = no overlap
  select(pollen, site, date, sp.pair, iter, niche.overlap)

```

#### Niche overlap by species pair
```{r}
ggplot(niche_overlap.sp, aes(sp.pair, niche.overlap)) +
  geom_boxplot(fill = "gray60") +
  facet_wrap(~pollen, ncol = 1) +
  theme_light()

ggplot(niche_overlap.sp.strongpairs, aes(sp.pair, niche.overlap)) +
  geom_boxplot(fill = "gray60") +
  facet_wrap(~pollen, ncol = 1) +
  theme_light()

ggplot(niche_overlap.sp_site, aes(sp.pair, niche.overlap)) +
  geom_boxplot(fill = "gray60") +
  facet_wrap(~pollen, ncol = 1) +
  theme_light()
```

#### Niche overlap: pollen vs. nectar
```{r}
ggplot(niche_overlap.sp, aes(pollen, niche.overlap)) +
  geom_violin(fill = "gray60") +
  geom_boxplot(fill = "NA") +
  theme_light()

ggplot(niche_overlap.sp.strongpairs, aes(pollen, niche.overlap)) +
  geom_violin(fill = "gray60") +
  geom_boxplot(fill = "NA") +
  theme_light()

ggplot(niche_overlap.sp_site, aes(pollen, niche.overlap)) +
  geom_violin(fill = "gray60") +
  geom_boxplot(fill = "NA") +
  theme_light()


lm_p.v.n <- lm(niche.overlap ~ pollen, data = niche_overlap.sp) 
summary(lm_p.v.n)
plot(lm_p.v.n)
```
  
### Question 1: Why do these bumble bee species partition the floral community as they do?
#### **H0: Random null model.** Shuffle network and see if observed niche partitioning differs significantly from random niche partitioning.
#### **H1: Tongue-length / corolla depth matching.** This is the classic explanation for resource partitioning in BB communities. 
#### **H2: Competition.** It is also possble that competition could --- perhaps transiently --- drive BB species to partition floral resources according to some criterion other than tongue length matching. For example, several BB species may have very similar tongue lengths and yet show marked resource partitioning. 
#### Others? Phylogenetic patterns could represent unmeasured floral trait variation, such as nutritional parameters / secondary chemistry / visual or olfactory cues and their corresponding traits in the BBs (physiology, perception). Differences in spatial foraging strategies? Differences in specialization, e.g. maybe some BB species can manage fewer floral species at a time.

### We can do a quick test of H1: I see no evidence that tongue length differences can explain dietary differences
```{r, echo = FALSE}
ggplot(niche_overlap.sp, aes(pbl.diff, niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  labs(title = "transect-wise")

ggplot(filter(niche_overlap.sp.strongpairs, wurf == FALSE), aes(pbl.diff, niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(title = "transect-wise")

ggplot(filter(niche_overlap.sp_site, wurf == FALSE), aes(pbl.diff, niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "lm") +
  labs(title = "transect-wise")

ggplot(niche_overlap.sp, aes(pbl.diff, niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  facet_wrap(~cut_interval(yday(date), 5)) +
  labs(title = "transect-wise by date interval")

ggplot(niche_overlap.sp.mean, aes(pbl.diff, mean.niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  labs(title = "site-wise")

ggplot(niche_overlap.sp.mean, aes(pbl.diff, mean.niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  facet_wrap(~cut_interval(elev.mean, 5)) +
  labs(title = "site-wise by elevation interval")
```

```{r}
ggplot(niche_overlap.sp, aes(sqrt(abund.diff), niche.overlap, color = pollen)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  labs(title = "transect-wise")
```
### Niche overlap by elevation/time
```{r, echo=FALSE}
# Elevation
ggplot(niche_overlap.sp, aes(elev.mean, niche.overlap, color = pollen)) +
  geom_point() +
  geom_smooth() +
  facet_grid(year~sp.pair) +
  labs(title = "transect-wise pair-wise niche overlap by elevation") +
  ylim(c(0,1))

ggplot(niche_overlap.sp.strongpairs, aes(elev.mean, niche.overlap, color = pollen)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(year~sp.pair) +
  labs(title = "transect-wise pair-wise niche overlap by elevation") +
  ylim(c(0,1))

ggplot(niche_overlap.sp_site, aes(elev.mean, niche.overlap, color = pollen)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4)) +
  facet_grid(year~sp.pair) +
  labs(title = "transect-wise pair-wise niche overlap by elevation") +
  ylim(c(0,1))    

ggplot(niche_overlap.sp.mean, aes(elev.mean, mean.niche.overlap, color = pollen)) +
  geom_point() +
  geom_smooth() +
  facet_grid(year~sp.pair) +
  labs(title = "site-wise pair-wise niche overlap by elevation") +
  ylim(c(0,1))

# Time
ggplot(niche_overlap.sp, aes(yday, niche.overlap, color = pollen)) +
  geom_point() +
  geom_smooth() +
  facet_grid(year~sp.pair) +
  labs(title = "transect-wise pair-wise niche overlap by elevation") +
  ylim(c(0,1))
```

### Cluster and ordination analysis
```{r}
# Combined
net.combined <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  group_by(bb.sp, plant.sp, site, date) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, site, date) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.combined_dist <- vegdist(net.combined, method = "horn")
net.combined_clust <- hclust(net.combined_dist, "ward.D")
plot(net.combined_clust)
groups.combined <- cutree(net.combined_clust, 3)

pcoa.combined_dist <- capscale(net.combined ~ 1, distance = "horn", scale = TRUE)
ordiplot(pcoa.combined_dist, type = "t")

ordiplot(pcoa.combined_dist, type = 'n')
points(pcoa.combined_dist, pch = groups, col = groups)

# Pollen
net.pollen <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(pollen == "pollen") %>%
   group_by(bb.sp, plant.sp, site, date) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, site, date) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.pollen.sitepool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(pollen == "pollen") %>%
   group_by(bb.sp, plant.sp, site) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, site) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.pollen_dist <- vegdist(net.pollen, method = "horn")
net.pollen_clust <- hclust(net.pollen_dist, "ward.D")
plot(net.pollen_clust)
groups.pollen <- cutree(net.pollen_clust, 3)

net.pollen_dist.sitepool <- vegdist(net.pollen.sitepool, method = "horn")
net.pollen_clust.sitepool <- hclust(net.pollen_dist.sitepool, "ward.D")
plot(net.pollen_clust.sitepool)
groups.pollen.sitepool <- cutree(net.pollen_clust.sitepool, 3)

pcoa.pollen_dist.sitepool <- capscale(net.pollen.sitepool ~ 1, distance = "horn", scale = TRUE)
ordiplot(pcoa.pollen_dist.sitepool, type = "t")

ordiplot(pcoa.pollen_dist.sitepool, type = 'n')
points(pcoa.pollen_dist.sitepool, pch = groups.pollen.sitepool, col = groups.pollen.sitepool)

# Nectar
net.nectar <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp, site, date) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, site, date) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar.sitepool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp, site) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, site) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar_dist <- vegdist(net.nectar, method = "horn")
net.nectar_clust <- hclust(net.nectar_dist, "ward.D")
plot(net.nectar_clust)
groups.nectar <- cutree(net.nectar_clust, 3)

pcoa.nectar_dist <- capscale(net.nectar ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist, type = "t")

ordiplot(pcoa.nectar_dist, type = 'n')
points(pcoa.nectar_dist, pch = groups, col = groups)


net.nectar_dist.sitepool <- vegdist(net.nectar.sitepool, method = "horn")
net.nectar_clust.sitepool <- hclust(net.nectar_dist.sitepool, "ward.D")
plot(net.nectar_clust.sitepool)
groups.nectar.sitepool <- cutree(net.nectar_clust.sitepool, 2)

pcoa.nectar_dist.sitepool <- capscale(net.nectar.sitepool ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist.sitepool, type = "t")

ordiplot(pcoa.nectar_dist.sitepool, type = 'n')
points(pcoa.nectar_dist.sitepool, pch = groups.nectar.sitepool, col = groups.nectar.sitepool)

net.nectar.allpool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar_dist.allpool <- vegdist(net.nectar.allpool, method = "horn")
net.nectar_clust.allpool <- hclust(net.nectar_dist.allpool, "ward.D")
plot(net.nectar_clust.allpool)
groups.nectar.allpool <- cutree(net.nectar_clust.allpool, 2)

pcoa.nectar_dist.allpool <- capscale(net.nectar.allpool ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist.allpool, type = "t")

ordiplot(pcoa.nectar_dist.allpool, type = 'n')
points(pcoa.nectar_dist.allpool, pch = groups.nectar.allpool, col = groups.nectar.allpool)

net.nectar.highpool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(elev.mean >= 1500) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar_dist.highpool <- vegdist(net.nectar.highpool, method = "horn")
net.nectar_clust.highpool <- hclust(net.nectar_dist.highpool, "ward.D")
plot(net.nectar_clust.highpool)
groups.nectar.highpool <- cutree(net.nectar_clust.highpool, 2)

pcoa.nectar_dist.highpool <- capscale(net.nectar.highpool ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist.highpool, type = "t")

ordiplot(pcoa.nectar_dist.highpool, type = 'n')
points(pcoa.nectar_dist.highpool, pch = groups.nectar.highpool, col = groups.nectar.highpool)

net.nectar.lowpool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(elev.mean <= 1000) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar_dist.lowpool <- vegdist(net.nectar.lowpool, method = "horn")
net.nectar_clust.lowpool <- hclust(net.nectar_dist.lowpool, "ward.D")
plot(net.nectar_clust.lowpool)
groups.nectar.lowpool <- cutree(net.nectar_clust.lowpool, 3)

pcoa.nectar_dist.lowpool <- capscale(net.nectar.lowpool ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist.lowpool, type = "t")

ordiplot(pcoa.nectar_dist.lowpool, type = 'n')
points(pcoa.nectar_dist.lowpool, pch = groups.nectar.lowpool, col = groups.nectar.lowpool)



net.nectar.midpool <- net %>%
  filter(bb.sp %in% c("bss", "pasc", "prat", "hort", "soro", "wurf")) %>%
  filter(elev.mean > 1000 & elev.mean < 1500) %>%
  filter(pollen == "nopollen") %>%
   group_by(bb.sp, plant.sp) %>%
  summarize(freq = n()) %>% # get interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp) %>%
  mutate(prop = freq/sum(freq))%>% # get proportional interaction frequency for each BB-FL pair per site-date
  group_by(bb.sp, plant.sp) %>%
  summarize(mean.prop = mean(prop)) %>% # get mean proportional interaction frequency for each BB-FL pair across site-dates
  pivot_wider(names_from = plant.sp, values_from = mean.prop) %>% # spread into the kind of array vegan likes
  replace(is.na(.), 0) %>% # replace NAs with zeros
  column_to_rownames("bb.sp")

net.nectar_dist.midpool <- vegdist(net.nectar.midpool, method = "horn")
net.nectar_clust.midpool <- hclust(net.nectar_dist.midpool, "ward.D")
plot(net.nectar_clust.midpool)
groups.nectar.midpool <- cutree(net.nectar_clust.midpool, 3)

pcoa.nectar_dist.midpool <- capscale(net.nectar.midpool ~ 1, distance = "horn")
ordiplot(pcoa.nectar_dist.midpool, type = "t")

ordiplot(pcoa.nectar_dist.midpool, type = 'n')
points(pcoa.nectar_dist.midpool, pch = groups.nectar.midpool, col = groups.nectar.midpool)



```

```
library(ggordiplots)

global_ordiplot <- gg_ordiplot(pcoa.nectar_dist, groups = groups, 
                               spiders = FALSE, hull = TRUE, 
                               ellipse = FALSE, label = FALSE)

ordiplot(pcoa.nectar_dist, type = "t")
plot(envfit(pcoa.nectar_dist, env = c(6.9, 12.7, 8.4, 7.3, 6.2, 7.5)))

str(pcoa.nectar_dist)

library(ggvegan)
fortify(pcoa.nectar_dist)

autoplot(pcoa.nectar_dist)
```

### GAMS
```{r, echo = FALSE}
pollen.gam.2010 <- bam(niche.overlap ~ 
                         s(sp.pair, bs = "re") +
                         te(yday, elev.mean, by = sp.pair, bs = c("gp", "tp"), k = 5),
                       data = filter(niche_overlap.sp, year == 2010),
                       method = "fREML",
                       discrete= TRUE,
                       family = "scat") %>% getViz()

check.gamViz(pollen.gam.2010)
pollen.gam.2010.sum <- summary(pollen.gam.2010)
print(plot(pollen.gam.2010, allTerms = TRUE), pages = 1)

pollen.gam.2011 <- bam(niche.overlap ~ 
                         s(sp.pair, bs = "re") +
                         te(yday, elev.mean, by = sp.pair, bs = c("gp", "tp"), k = 5),
                       data = filter(niche_overlap.sp, year == 2011),
                       method = "fREML",
                       discrete= TRUE,
                       family = "scat") %>% getViz()

check.gamViz(pollen.gam.2011)
pollen.gam.2011.sum <- summary(pollen.gam.2011)
print(plot(pollen.gam.2011, allTerms = TRUE), pages = 1)

pollen.gam.2012 <- bam(niche.overlap ~ 
                         s(sp.pair, bs = "re") +
                         te(yday, elev.mean, by = sp.pair, bs = c("gp", "tp"), k = 5),
                       data = filter(niche_overlap.sp, year == 2012),
                       method = "fREML",
                       discrete= TRUE,
                       family = "scat") %>% getViz()

check.gamViz(pollen.gam.2012)
pollen.gam.2012.sum <- summary(pollen.gam.2012)
print(plot(pollen.gam.2012, allTerms = TRUE), pages = 1)
```
