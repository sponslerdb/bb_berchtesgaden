---
title: "flower_choice"
output: html_document
---

# Packages 
```{r}
library(tidyverse)
```

# Load site data and temperature data
```{r, include=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) # turn elav.class into an ordered factor

gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, date, gdd.cum)
```

# Load floral taxonomy and trait data
```{r}
fl_tax <- read_csv("../processed_data/floral_tax.csv")
  
fl_ktype <- read_csv("../processed_data/floral_k_type.csv") %>%
  select(plant.sp, plant.genus = genus, k.type) %>%
  mutate(k.type.s = str_extract(k.type, "[-+]?[0-9]*\\.?[0-9]+"),
         k.type.ss = str_extract(k.type, "[-+]?[0-9]*"))

fl_morph <- read_csv("../processed_data/flower_morphology_GitaBenadi.csv") %>%
  select(SampleID, plant.family = Family, plant.sp = Species, 
         Unit, Flowers_per_unit, diam = Diameter, LN) %>%
  group_by(plant.sp) %>%
  summarize(diam = mean(diam),
            LN = mean(LN))

fl_ktype_key <- read_delim("../processed_data/kugler_key.tsv", delim = "\t", col_names = FALSE) %>%
  select(k.type = 1, description = 2)

fl_traits <- fl_tax %>%
  full_join(fl_ktype) %>%
  full_join(fl_morph) %>%
  select(plant.sp, plant.genus, plant.family, 
         k.type, k.type.s, k.type.ss, diam, LN)
```

# Load BB trait data 
```{r}
bb_traits <- read_csv("../processed_data/bb_traits.csv")
```

# Load network and survey data
```{r, include=FALSE}
# Visitation network
net <- read_csv("../processed_data/network.csv") %>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  mutate(year = factor(year)) %>% # convert year to factor
  left_join(site_data, by = "site") %>%
  left_join(gdd, by = c("site", "date")) %>%
  left_join(fl_traits) %>%
  left_join(bb_traits) %>%
  ungroup() %>%
  arrange(site, date)

visitation <- net %>%
  group_by(site, pollen, date, year, bb.sp, plant.sp) %>%
  summarize(visits = n()) %>%
  left_join(site_data, by = "site") %>%
  left_join(gdd, by = c("site", "date")) %>%
  left_join(fl_traits)

# Floral survey
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  dplyr::select(site, date, plant.sp, flower.cover) %>%
  group_by(site, date) %>%
  left_join(fl_traits) %>%
  left_join(site_data)

survey_sub <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover) %>%
  left_join(fl_traits) %>%
  left_join(site_data)
```


# How does the absolute abundance of floral trait classes compare to the visitation rates of floral trait classes?
```{r}
# Whole plant community
## By elevation
ggplot(survey, aes(cut_interval(elev.mean, n = 8), flower.cover, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

ggplot(survey, aes(cut_interval(elev.mean, n = 8), flower.cover, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

## By week
ggplot(survey, aes(cut_interval(as_date(yday(date)), 10), flower.cover, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date))

ggplot(survey, aes(cut_interval(as_date(yday(date)), 10), flower.cover, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date))

# Visited plant community
## By elevation
ggplot(survey_sub, aes(cut_interval(elev.mean, n = 8), flower.cover, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

ggplot(survey_sub, aes(cut_interval(elev.mean, n = 8), flower.cover, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

## By week
ggplot(survey_sub, aes(cut_interval(as_date(yday(date)), 10), flower.cover, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date))

ggplot(survey_sub, aes(cut_interval(as_date(yday(date)), 10), flower.cover, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date))

# Visitation rates
## By elevation
ggplot(visitation, aes(cut_interval(elev.mean, n = 8), visits, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

ggplot(visitation, aes(cut_interval(elev.mean, n = 8), visits, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_grid(pollen~bb.sp)

ggplot(visitation, aes(cut_interval(elev.mean, n = 8), visits, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_wrap(~year(date), ncol = 1)

## By week
ggplot(filter(visitation, !is.na(pollen)), aes(cut_interval(as_date(yday(date)), 10), visits, fill = k.type.s)) +
  geom_col(position = "fill") +
  facet_grid(pollen~bb.sp)

ggplot(visitation, aes(cut_interval(as_date(yday(date)), 6), visits, fill = k.type.ss)) +
  geom_col(position = "fill") +
  facet_grid(cut_interval(elev.mean, n = 5) ~ year(date))
```

# Tongue length and corolla depth
```{r}
ggplot(net, aes(pbl.w, LN)) +
  geom_point() +
  facet_grid(cut_interval(elev.mean, n = 5) ~ .)

ggplot(net, aes(pbl.w, LN)) +
  geom_point() +
  facet_grid(cut_interval(as_date(yday(date)), 6) ~ .)

```

# Tongue length and elevation
```{r}
ggplot(net, aes(cut_interval(elev.mean, n = 8), fill = factor(pbl.w.class))) +
  geom_bar(position = "fill") +
  facet_wrap(~year)

ggplot(net, aes(cut_interval(elev.mean, n = 8), fill = factor(bb.sp))) +
  geom_bar(position = "fill") +
  facet_wrap(~year)
```

# Do bumble bee species differ in the abundance of the floral resources they select?
```{r}
fl_abund_sp <- survey %>%
  group_by(site, date, plant.sp) %>% # group by plant.sp*transect
  summarize(fl.abund = sum(flower.cover)) %>% # get plant.sp*transect total flower cover; this step really shouldn't be required, but in a few cases, there is more than one abundance entry for the same species on a given transect; not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, I could drop the dups or average them. We'll see what Kalli and Fabrice have to say.
  group_by(site, date) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund)) %>% # get the proportional flower cover for each species.
  ungroup()

abund_vis <- net %>%
  #group_by(site, date, bb.sp, plant.sp) %>%
  #summarize(visits = n()) %>%
  #group_by(site, date, bb.sp) %>%
  #mutate(prop_visits = visits/sum(visits)) %>%
  left_join(fl_abund_sp)
  
ggplot(abund_vis, aes(bb.sp, prop.fl.abund)) +
  geom_boxplot()

ggplot(abund_vis, aes(elev.mean, log(prop.fl.abund))) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ bb.sp)

ggplot(abund_vis, aes(yday(date), log(prop.fl.abund))) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~ bb.sp)
```

#
```{r}
ggplot(net, aes(bb.sp, fill = plant.genus)) +
  geom_bar(position = "fill")

ggplot(net, aes(bb.sp, fill = plant.family)) +
  geom_bar(position = "fill")
  
  ggplot(net, aes(bb.sp, fill = k.type.s)) +
    geom_bar(position = "fill")
```