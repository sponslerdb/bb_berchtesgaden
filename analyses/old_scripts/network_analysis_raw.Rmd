---
title: "network analysis raw"
output: html_document
---

### Introduction
Our philosophy in this iteration of the analysis is that we can simply treat the number of transects as a covariate to be controlled statistically. This avoids the need to bootstrap and throw away a lot of data, but we pay a price in terms of model identifiability due to the collinearity between elevation and transect number. 

### Prepare environment
```{r setup, message=FALSE, warning=FALSE, include=FALSE}
library(bipartite)
library(mgcv)
library(mgcViz)
library(ggforce)
library(vegan)
library(tidyverse)
library(lubridate)
```

### Load data
```{r message=FALSE, warning=FALSE, include=FALSE}
# Site data
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, 
                   elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, 
                             levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, 
                             levels = c("high", "mid", "low"))) # turn elav.class into an ordered factor

# Climate data
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  dplyr::select(site, date, gdd.cum)

total_gdd <- gdd %>%
  mutate(year = factor(year(date))) %>%
  group_by(site, year) %>%
  summarize(total.gdd = max(gdd.cum))

# Network
net <- read_csv("../processed_data/network.csv") %>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  mutate(year = factor(year)) %>% # convert year to factor
  left_join(site_data, by = "site") %>%
  left_join(gdd, by = c("site", "date")) %>%
  ungroup() %>%
  arrange(site, date)

# Floral survey
survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

# BB traits
bb_traits <- read_csv("../processed_data/bb_traits.csv")

### Auxiliary data, i.e. all the covariates we need to control for
BB_aux <- net %>%
  group_by(site, year, date) %>%
  summarize(bb.rich = length(unique(bb.sp)),
            bb.abund = n()) %>%
  group_by(site, year) %>%
  summarize(bb.rich = mean(bb.rich),
            log.bb.abund = log(mean(bb.abund)),
            bb.transects = length(unique(date)))

FL_aux <- survey %>%
  mutate(year = factor(year(date))) %>%
  filter(flower.cover > 0) %>%
  group_by(site, year, date) %>%
  summarize(fl.rich = length(unique(plant.sp)),
            fl.abund = sum(flower.cover)) %>%
  group_by(site, year) %>%
  summarize(fl.rich = mean(fl.rich),
            log.fl.abund = log(mean(fl.abund)),
            fl.transects = length(unique(date)))
```

### Calculate network/group-level metrics
This is straightforward because none of these metrics involve independent abundance data (i.e. our survey data). We will focus on the network-level metrics of connectance and NODF (nestedness) and the group-level metrics of niche overlap and C score (both are measures of dietary overlap / partitioning)
```{r echo=FALSE, message=FALSE, warning=FALSE}
netmet <- net %>%
  group_by(site, year, bb.sp, plant.sp) %>% # group by site, date, bee species, plant species
  summarize(freq = n()) %>% # calculate interaction frequency per species pair within each site
  group_by(site, year) %>%
  unite(webID, c(site, year), sep = "_") %>%
  ungroup() %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() %>% # convert to to bipartite web
  map(networklevel, level = "higher", weighted = TRUE,
      index = c("connectance", "web asymmetry", "weighted NODF", "C score", "niche overlap")) %>% 
  data.frame() %>%
  t() %>%
  data.frame() %>%
  rownames_to_column() %>%
  dplyr::select(site_year = rowname, everything()) %>%
  as_tibble() %>%
  separate(site_year, c("site", "year"), sep =  "_") %>%
  left_join(site_data) %>%
  left_join(BB_aux) %>%
  left_join(FL_aux) %>%
  left_join(total_gdd) %>%
  mutate(site = factor(site),
         year = factor(year))
```

### Temperature ~ elevation 
The question has been raised of whether we might learn more by using temperature instead of elevation as a predictor variable. We see here, though, that total degree-day accumulation and elevation are almost perfectly correlated, so I think there is little to be gained by using temperature as an explanatory variable. We do, however, see that 2011 and 2012 were substantially warmer than 2010.
```{r  message=FALSE, warning=FALSE, echo = FALSE}
ggplot(netmet, aes(elev.mean, total.gdd, color = year)) +
  geom_point() +
  xlab("Elevation") +
  ylab("Total GDD") +
  theme_gray(14)
```


### Extract species-level metrics
```{r echo = FALSE, message=FALSE, warning=FALSE}
# This is ugly code. The reason is that to calculate d' the right way, we need to use our floral survey data as an independent measure of floral species abundance. I can't figure out a way to wrap this up in a nice neat map() call like I did for the network-level metrics, so instead I am analyzing each site-year one at a time, then collating them. First, the prep work.

# Calculate the mean proportional flower cover of each floral species per site-year
# Complete() expands the array to include all possible site/date/sp  combos, 
# filling in zeros for combos that did not occur.
survey_abundances <- survey %>%
  mutate(year = factor(year(date))) %>%
  filter(flower.cover > 0) %>%
  
  # get plant.sp*transect total flower cover; this step really shouldn't be required, 
  # but in a few cases, there is more than one abundance entry for the same species on a given transect; 
  # not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, 
  # I could drop the dups or average them.
  
  group_by(site, date, year, plant.sp) %>%
  summarize(flower.cover = sum(flower.cover)) %>%
  
  mutate(site = factor(site), # Need to make site and plant.sp factors for complete() to work
         plant.sp = factor(plant.sp)) %>%
  complete(site, date, plant.sp, fill = list(flower.cover = 0)) %>% # get all combos, fill in zeros
  group_by(site, date, year) %>%
  mutate(prop = if_else( # get proportional abundance per site date
    flower.cover > 0, flower.cover/sum(flower.cover), 0)
    ) %>%
  group_by(site, year, plant.sp) %>% # get mean proportional abundance per site-year
  summarize(mean.cover.prop = mean(prop))

# Now, the marginal totals. This enables comparison with the survey abundances, and it
# also enables a convenient join to include only surveyed plants that occur 
# in the visitation network
network_marginal_totals <- net %>%
  group_by(site, date, year, plant.sp) %>%
  summarize(marg.tot = n()) %>% # marginal totals are just the total visits to each plant across all BB spp.
  mutate(site = factor(site),
         plant.sp = factor(plant.sp)) %>%
  complete(site, year, plant.sp, fill = list(marg.tot = 0)) %>% # get all combos and fill in zeros
  group_by(site, date, year)  %>%
  mutate(marg.tot.prop = if_else( # get proportional abundance per site date
    marg.tot > 0, marg.tot/sum(marg.tot), 0)
    ) %>%
  group_by(site, year, plant.sp) %>% 
  summarize(mean.marg.tot.prop = mean(marg.tot.prop))
  
# Left join survey abundances to network marginal totals
abundance_join <- left_join(network_marginal_totals,
                            survey_abundances) %>%
  arrange(as.character(plant.sp)) %>%
  
  # For species that we missed in the survey but visited in the network for a given site-year,
  # we will use the proportional marginal totals in place of the survey data rather than
  # having treating visited plants as having zero-abundance 
  replace_na(replace = list(mean.cover.prop = 0)) %>% 
  mutate(abundance = case_when(
    mean.cover.prop > 0 ~ mean.cover.prop,
    mean.cover.prop == 0 ~ mean.marg.tot.prop)
    ) %>%
  
  filter(mean.marg.tot.prop > 0) # for each site date, drop unvisited species

#################### Extract species metrics ########################
# Turn network into webs
sp_webs <- net %>%
  group_by(site, year, bb.sp, plant.sp) %>% # group by site, date, bee species, plant species
  summarize(freq = n()) %>% # calculate interaction frequency per species pair within each site
  group_by(site, year) %>%
  unite(webID, c(site, year), sep = "_") %>%
  ungroup() %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs(emptylist = TRUE) 

# Check names (don't screw this up!)
web_names <- names(sp_webs)

# Extract metrics one freaking web at a time
## Site H1
spmet_h1_2010 <- specieslevel(sp_webs[[1]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h1", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h1", n()),
         year = rep(2010, n()))

spmet_h1_2011 <- specieslevel(sp_webs[[2]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h1", 
                                                year == 2011)$mean.cover.prop)  %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h1", n()),
         year = rep(2011, n()))

spmet_h1_2012 <- specieslevel(sp_webs[[3]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h1", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h1", n()),
         year = rep(2012, n()))

## Site H2
spmet_h2_2010 <- specieslevel(sp_webs[[4]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h2", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h2", n()),
         year = rep(2010, n()))

spmet_h2_2011 <- specieslevel(sp_webs[[5]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h2", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h2", n()),
         year = rep(2011, n()))

spmet_h2_2012 <- specieslevel(sp_webs[[6]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h2", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h2", n()),
         year = rep(2012, n()))

## Site H3
spmet_h3_2010 <- specieslevel(sp_webs[[7]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h3", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h3", n()),
         year = rep(2010, n()))

spmet_h3_2011 <- specieslevel(sp_webs[[8]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h3", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h3", n()),
         year = rep(2011, n()))

spmet_h3_2012 <- specieslevel(sp_webs[[9]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h3", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h3", n()),
         year = rep(2012, n()))

## Site H4
spmet_h4_2010 <- specieslevel(sp_webs[[10]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h4", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h4", n()),
         year = rep(2010, n()))

spmet_h4_2011 <- specieslevel(sp_webs[[11]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h4", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h4", n()),
         year = rep(2011, n()))

spmet_h4_2012 <- specieslevel(sp_webs[[12]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h4", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h4", n()),
         year = rep(2012, n()))

## Site H5
spmet_h5_2010 <- specieslevel(sp_webs[[13]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h5", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h5", n()),
         year = rep(2010, n()))

spmet_h5_2011 <- specieslevel(sp_webs[[14]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h5", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h5", n()),
         year = rep(2011, n()))

spmet_h5_2012 <- specieslevel(sp_webs[[15]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h5", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h5", n()),
         year = rep(2012, n()))

## Site H6
spmet_h6_2010 <- specieslevel(sp_webs[[16]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h6", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h6", n()),
         year = rep(2010, n()))

spmet_h6_2011 <- specieslevel(sp_webs[[17]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h6", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h6", n()),
         year = rep(2011, n()))

spmet_h6_2012 <- specieslevel(sp_webs[[18]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h6", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h6", n()),
         year = rep(2012, n()))

## Site H7
spmet_h7_2010 <- specieslevel(sp_webs[[19]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h7", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h7", n()),
         year = rep(2010, n()))

spmet_h7_2011 <- specieslevel(sp_webs[[20]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h7", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h7", n()),
         year = rep(2011, n()))

spmet_h7_2012 <- specieslevel(sp_webs[[21]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "h7", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("h7", n()),
         year = rep(2012, n()))

## Site HO1
spmet_ho1_2010 <- specieslevel(sp_webs[[22]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho1", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho1", n()),
         year = rep(2010, n()))

spmet_ho1_2011 <- specieslevel(sp_webs[[23]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho1", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho1", n()),
         year = rep(2011, n()))

spmet_ho1_2012 <- specieslevel(sp_webs[[24]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho1", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho1", n()),
         year = rep(2012, n()))

## Site ho2
spmet_ho2_2010 <- specieslevel(sp_webs[[25]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho2", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho2", n()),
         year = rep(2010, n()))

spmet_ho2_2011 <- specieslevel(sp_webs[[26]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho2", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho2", n()),
         year = rep(2011, n()))

spmet_ho2_2012 <- specieslevel(sp_webs[[27]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho2", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho2", n()),
         year = rep(2012, n()))

## Site ho3
spmet_ho3_2010 <- specieslevel(sp_webs[[28]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho3", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho3", n()),
         year = rep(2010, n()))

spmet_ho3_2011 <- specieslevel(sp_webs[[29]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho3", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho3", n()),
         year = rep(2011, n()))

spmet_ho3_2012 <- specieslevel(sp_webs[[30]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho3", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho3", n()),
         year = rep(2012, n()))

## Site ho4
spmet_ho4_2010 <- specieslevel(sp_webs[[31]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho4", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho4", n()),
         year = rep(2010, n()))

spmet_ho4_2011 <- specieslevel(sp_webs[[32]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho4", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho4", n()),
         year = rep(2011, n()))

spmet_ho4_2012 <- specieslevel(sp_webs[[33]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho4", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho4", n()),
         year = rep(2012, n()))

## Site ho5
spmet_ho5_2010 <- specieslevel(sp_webs[[34]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho5", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho5", n()),
         year = rep(2010, n()))

spmet_ho5_2011 <- specieslevel(sp_webs[[35]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho5", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho5", n()),
         year = rep(2011, n()))

spmet_ho5_2012 <- specieslevel(sp_webs[[36]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "ho5", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("ho5", n()),
         year = rep(2012, n()))

## Site t1
spmet_t1_2010 <- specieslevel(sp_webs[[37]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t1", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t1", n()),
         year = rep(2010, n()))

spmet_t1_2011 <- specieslevel(sp_webs[[38]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t1", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t1", n()),
         year = rep(2011, n()))

spmet_t1_2012 <- specieslevel(sp_webs[[39]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t1", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t1", n()),
         year = rep(2012, n()))

## Site t4
spmet_t4_2010 <- specieslevel(sp_webs[[40]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t4", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t4", n()),
         year = rep(2010, n()))

spmet_t4_2012 <- specieslevel(sp_webs[[41]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t4", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t4", n()),
         year = rep(2012, n()))

## Site t5
spmet_t5_2010 <- specieslevel(sp_webs[[42]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t5", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t5", n()),
         year = rep(2010, n()))

spmet_t5_2011 <- specieslevel(sp_webs[[43]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t5", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t5", n()),
         year = rep(2011, n()))

spmet_t5_2012 <- specieslevel(sp_webs[[44]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "t5", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("t5", n()),
         year = rep(2012, n()))

## Site wma1
spmet_wma1_2010 <- specieslevel(sp_webs[[45]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma1", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma1", n()),
         year = rep(2010, n()))

spmet_wma1_2011 <- specieslevel(sp_webs[[46]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma1", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma1", n()),
         year = rep(2011, n()))

spmet_wma1_2012 <- specieslevel(sp_webs[[47]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma1", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma1", n()),
         year = rep(2012, n()))

## Site wma2
spmet_wma2_2010 <- specieslevel(sp_webs[[48]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma2", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma2", n()),
         year = rep(2010, n()))

spmet_wma2_2011 <- specieslevel(sp_webs[[49]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma2", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma2", n()),
         year = rep(2011, n()))

spmet_wma2_2012 <- specieslevel(sp_webs[[50]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma2", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma2", n()),
         year = rep(2012, n()))

## Site wma3
spmet_wma3_2010 <- specieslevel(sp_webs[[51]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma3", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma3", n()),
         year = rep(2010, n()))

spmet_wma3_2011 <- specieslevel(sp_webs[[52]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma3", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma3", n()),
         year = rep(2011, n()))

spmet_wma3_2012 <- specieslevel(sp_webs[[53]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma3", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma3", n()),
         year = rep(2012, n()))

## Site wma4
spmet_wma4_2010 <- specieslevel(sp_webs[[51]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma4", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma4", n()),
         year = rep(2010, n()))

spmet_wma4_2011 <- specieslevel(sp_webs[[52]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma4", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma4", n()),
         year = rep(2011, n()))

spmet_wma4_2012 <- specieslevel(sp_webs[[53]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma4", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma4", n()),
         year = rep(2012, n()))

## Site wma5
spmet_wma5_2010 <- specieslevel(sp_webs[[54]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma5", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma5", n()),
         year = rep(2010, n()))

spmet_wma5_2011 <- specieslevel(sp_webs[[55]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma5", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma5", n()),
         year = rep(2011, n()))

spmet_wma5_2012 <- specieslevel(sp_webs[[56]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wma5", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wma5", n()),
         year = rep(2012, n()))

## Site wmb1
spmet_wmb1_2010 <- specieslevel(sp_webs[[57]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb1", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb1", n()),
         year = rep(2010, n()))

spmet_wmb1_2011 <- specieslevel(sp_webs[[58]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb1", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb1", n()),
         year = rep(2011, n()))

spmet_wmb1_2012 <- specieslevel(sp_webs[[59]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb1", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb1", n()),
         year = rep(2012, n()))

## Site wmb2
spmet_wmb2_2010 <- specieslevel(sp_webs[[60]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb2", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb2", n()),
         year = rep(2010, n()))

spmet_wmb2_2011 <- specieslevel(sp_webs[[61]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb2", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb2", n()),
         year = rep(2011, n()))

spmet_wmb2_2012 <- specieslevel(sp_webs[[62]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb2", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb2", n()),
         year = rep(2012, n()))

## Site wmb3
spmet_wmb3_2010 <- specieslevel(sp_webs[[63]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb3", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb3", n()),
         year = rep(2010, n()))

spmet_wmb3_2011 <- specieslevel(sp_webs[[64]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb3", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb3", n()),
         year = rep(2011, n()))

spmet_wmb3_2012 <- specieslevel(sp_webs[[65]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb3", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb3", n()),
         year = rep(2012, n()))

## Site wmb4
spmet_wmb4_2010 <- specieslevel(sp_webs[[66]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb4", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb4", n()),
         year = rep(2010, n()))

spmet_wmb4_2011 <- specieslevel(sp_webs[[67]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb4", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb4", n()),
         year = rep(2011, n()))

spmet_wmb4_2012 <- specieslevel(sp_webs[[68]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb4", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb4", n()),
         year = rep(2012, n()))

## Site wmb5
spmet_wmb5_2010 <- specieslevel(sp_webs[[69]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb5", 
                                                year == 2010)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb5", n()),
         year = rep(2010, n()))

spmet_wmb5_2011 <- specieslevel(sp_webs[[70]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb5", 
                                                year == 2011)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb5", n()),
         year = rep(2011, n()))

spmet_wmb5_2012 <- specieslevel(sp_webs[[71]],
                              level = "higher",
                              high.abun = filter(abundance_join, 
                                                site == "wmb5", 
                                                year == 2012)$mean.cover.prop) %>%
  rownames_to_column(var = "bb.sp") %>%
  mutate(site = rep("wmb5", n()),
         year = rep(2012, n()))

# Collate metrics
spmet <- bind_rows(spmet_h1_2010, spmet_h1_2011, spmet_h1_2012,
                   spmet_h2_2010, spmet_h2_2011, spmet_h2_2012,
                   spmet_h3_2010, spmet_h3_2011, spmet_h3_2012,
                   spmet_h4_2010, spmet_h4_2011, spmet_h4_2012,
                   spmet_h5_2010, spmet_h5_2011, spmet_h5_2012,
                   spmet_h6_2010, spmet_h6_2011, spmet_h6_2012,
                   spmet_h7_2010, spmet_h7_2011, spmet_h7_2012,
                   spmet_ho1_2010, spmet_ho1_2011, spmet_ho1_2012,
                   spmet_ho2_2010, spmet_ho2_2011, spmet_ho2_2012,
                   spmet_ho3_2010, spmet_ho3_2011, spmet_ho3_2012,
                   spmet_ho4_2010, spmet_ho4_2011, spmet_ho4_2012,
                   spmet_ho5_2010, spmet_ho5_2011, spmet_ho5_2012,
                   spmet_t1_2010, spmet_t1_2011, spmet_t1_2012,
                   spmet_t4_2010, spmet_t4_2012,
                   spmet_t5_2010, spmet_t5_2011, spmet_t5_2012,
                   spmet_wma1_2010, spmet_wma1_2011, spmet_wma1_2012,
                   spmet_wma2_2010, spmet_wma2_2011, spmet_wma2_2012,
                   spmet_wma3_2010, spmet_wma3_2011, spmet_wma3_2012,
                   spmet_wma4_2010, spmet_wma4_2011, spmet_wma4_2012,
                   spmet_wma5_2010, spmet_wma5_2011, spmet_wma5_2012,
                   spmet_wmb1_2010, spmet_wmb1_2011, spmet_wmb1_2012,
                   spmet_wmb2_2010, spmet_wmb2_2011, spmet_wmb2_2012,
                   spmet_wmb3_2010, spmet_wmb3_2011, spmet_wmb3_2012,
                   spmet_wmb4_2010, spmet_wmb4_2011, spmet_wmb4_2012,
                   spmet_wmb5_2010, spmet_wmb5_2011, spmet_wmb5_2012) %>%
  mutate(site = factor(site),
         year = factor(year)) %>%
  select(site, year, everything()) %>%
  left_join(site_data) %>%
  left_join(bb_traits) %>%
  left_join(FL_aux) %>%
  left_join(BB_aux) %>%
  as_tibble() %>%
  mutate(bb.sp = factor(bb.sp))
```


#### How well does mean proportional marginal total predict mean proportional flower cover? 

It's actually not so bad.

```{r message=FALSE, warning=FALSE, echo = FALSE}
ggplot(abundance_join, aes(log(mean.marg.tot.prop), log(mean.cover.prop))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~year)
```


### Since we have curvy relationships and nested variables, we will analyze our data using hierarchical generalized additive models (HGAMs)
I think there are two ways we could approach this. 

1. If our goal is simply to explain network metrics, we can include all covariates (floral abundance, floral richness, BB abundance, BB richness, transect number) in the models, understanding that we have collinearity problems, and see which ones explain the most. Because of the (curvilinear) collinearity between elevation and the other covariates, though, this approach would make it harder to detect and interpret the infleunce of elevation, which is the main question we're interested in. 

2. The second approach is to say that while network metrics may, indeed, be influenced by abundance and richness covariates, these are just mediated effects of elevation. We may not care exactly how (i.e. via which mediating covariate) elevation influences network metrics; we might just want to know the shape of the response. But I think we **must** include transects as a covariate even in this approach; otherwise, we would need to go down the road of bootstrapping/rarefaction, and I think we all agree that we don't want to do that. 

**My recommendation would be to go with option 2, and that is what will be presented below.**  


#### Network/group-level metrics
For these models, we will use the bs = "fs" factor smooth method. This preserves degrees of freedom by forcing all smooths to have the same wiggliness. 

**Results**

  * Niche overlap (15% explained)
    + Linear negative effect of elevation
    + No significant effect of transect number
  * C score (30% explained)
    + Positive quadratic/cubic effect of elevation
    + No significant effect of transect number
    
**Discussion** 
These models have a lot of unexplained variation, but they suggest that the diets of co-existing bumble bee species become increasingly dissimilar (niche overlap) or disaggregated (C score) with increasing elevation. This pattern does not appear to be influenced significantly by transect count. 

```{r message=FALSE, warning=FALSE}
# Web asymmetry
gam_web.asym <- gam(web.asymmetry ~ 
                            s(elev.mean, year, bs = "fs", k = 5) +
                            s(bb.transects, year, bs = "fs", k = 4),
                    data = netmet,
                    family = "gaussian",
                    method = "REML",
                    select = FALSE) %>% getViz()
          
check.gamViz(gam_web.asym) 
summary(gam_web.asym)
plot(sm(gam_web.asym, 1)) +
  l_fitLine(alpha = 0.6)
plot(sm(gam_web.asym, 2)) +
  l_fitLine(alpha = 0.6)

# Niche overlap
gam_niche.overlap <- gam(niche.overlap.HL ~ 
                            s(elev.mean, year, bs = "fs", k = 5) +
                            s(bb.transects, year, bs = "fs", k = 4),
                         data = netmet,
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()
          
check.gamViz(gam_niche.overlap) 
summary(gam_niche.overlap)
plot(sm(gam_niche.overlap, 1)) +
  l_fitLine(alpha = 0.6)
plot(sm(gam_niche.overlap, 2)) +
  l_fitLine(alpha = 0.6)

# C score
gam_C.score <- gam(C.score.HL ~ 
                            s(elev.mean, year, bs = "fs", k = 5) +
                            s(bb.transects, year, bs = "fs", k = 4),
                   data = netmet,
                   family = "gaussian",
                   method = "REML",
                   select = FALSE) %>% getViz()
          
check.gamViz(gam_C.score) 
summary(gam_C.score)
plot(sm(gam_C.score, 1)) +
  l_fitLine(alpha = 0.6)
plot(sm(gam_C.score, 2)) +
  l_fitLine(alpha = 0.6)
```

#### Species-level d'
First let's look at the abundance and distribution of each species in each year. It's probably not worth trying to fit the model to species that are extremely rare or limited in their distirbution. We will drop B. humilis and B. lapidarius from 2010, B. humilis, B. gerstaeckeri, and B. mucidus from 2011, and B. humilis, B. hypnorum, and B. mucidus from 2012.
```{r message=FALSE, warning=FALSE}
bb_range.year <- net %>%
  left_join(site_data) %>%
  group_by(site, date, elev.mean, bb.sp, year) %>%
  summarize(abund = n()) %>%
  group_by(site, elev.mean, bb.sp, year) %>%
  summarize(abund = mean(abund)) %>%
  group_by(bb.sp) %>%
  mutate(elev.floor = min(elev.mean),
         elev.ceiling = max(elev.mean),
         elev.range = elev.ceiling - elev.floor,
         elev.med = elev.floor + ((elev.ceiling - elev.floor)/2))

ggplot(bb_range.year, aes(reorder(bb.sp, elev.med), elev.mean)) +
  geom_line(size = 2, alpha = 0.25) +
  geom_point(aes(size = abund), alpha = 0.5) +
  facet_wrap(~year, ncol = 1) +
  theme_light(12) +
  scale_size_continuous(name = "Abundance") +
  scale_color_discrete(name = "Abund. class") +
  xlab("BB species") +
  ylab("Elevation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

For species-level d', we will use the "by = factor" factor smooth method. This allows different wiggliness and independent significance tests for each species, which I think is the right way to handle species-level differences in the response of d' to elevation. We will also create separate models for each year so that we can drop the rare species from each year and avoid a complicated interaction term (bb.sp * year) in the by=factor call.

**Results (only significant terms shown)**

* 2010 (33% explained)
  + B. gerstaeckeri (positive, linear)
  + B. pratorum (positive, quadratic)
  + **B. pyrenaeus (negative, quadratic)**
  + B. soroensis (positive, quadratic)
* 2011 (41% explained)
  + B. hortorum (positive, linear)
  + B. psithyrus (positive, linear)
  + Transects (positive, quadratic)
* 2012 (37% explained)
  + **B. sensu-strictu (positive, cubic)**
  + B. hortorum (negative, linear)
  + B. mendax (negative, leveling off above 1500)
  + B. pascuorum (negative, linear)
  + B. pyrenaeus (negative, linear)

**Discussion**
The majority of species do not exhibit a significant relationship between elevation and discrimination, and which species do varies markedly by year. Only B. hortorum and B. pyrenaeus show significant relationships in more than a single year. Transect number was significant only in 2011. **The most interesting finding is that the relationship between elevation and discrimination is generally positive in 2010 and 2011, but it changes to negative in 2012.**

```{r}
### Species-specific models
gam_d.2010 <- gam(d ~ 
                    bb.sp +
                    s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                    s(bb.transects, k = 4),
                  data = filter(spmet, year == 2010 & 
                                  !bb.sp %in% c("humi", "lapi")),
                  family = "gaussian",
                  method = "REML",
                  select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2010) 
summary(gam_d.2010)
print(plot(gam_d.2010, select = c(2, 10, 12, 13)), pages = 1)


gam_d.2011 <- gam(d ~ 
                     bb.sp +
                     s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                     s(bb.transects, k = 4),
                   data = filter(spmet, year == 2011 &
                                   !bb.sp %in% c("humi", "gers", "muci")),
                   family = "gaussian",
                   method = "REML",
                   select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2011) 
summary(gam_d.2011)
print(plot(gam_d.2011, select = c(2, 10, 14)), pages = 1)


gam_d.2012 <- gam(d ~ 
                     bb.sp +
                     s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                     s(bb.transects, k = 4),
                   data = filter(spmet, year == 2012 &
                                   !bb.sp %in% c("humi", "hypn", "muci")),
                   family = "gaussian",
                   method = "REML",
                   select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2012) 
summary(gam_d.2012)
print(plot(gam_d.2012, select = c(1, 3, 6, 8, 11)), pages = 1)
```


### Let's revisit option 1. 
If we're not committed to a story about elevation, can we explain our network metrics by including a larger suite of covariates, some of which may be collinear with elevation? 

First, let's inspect collinearity amongst the covariates. A PCA won't be much help here since some of these relationships are nonlinear. So, we'll make a pairs plot and interpret it manually. There's a lot that could be said about these graphs, but here are some highlights.

* Elevation x covariates 
  + Roughly quadratic relationship with BB richness, BB abundance (log-transformed), and floral richness
  + Roughly linear (negative) with floral abundance (log-transformed)
  + More complex relationship with BB and floral transects
* Collinearity among covariates
  + BB richness and BB abundance are very strongly correlated
  + There is also a strong correlation between BB richness and floral richness
  + In 2011, there is a very strong correlation between BB abundance and floral abundance; interestingly, this relationship does not hold up in the other two years
  
For a start, we will use all our covariates except for floral transects, since that one has to most tangential relationship to d' (it's only effect would be via the estimation of floral species' relative abundances). We will use the select = TRUE option to perform double-penalty variable selection; this potentially penalizes some terms out of the model.
```{r  message=FALSE, warning=FALSE, echo = FALSE}
# 2010
ggplot(filter(netmet, year == 2010) %>% na.omit(), 
       aes(x = .panel_x, y = .panel_y)) + 
  geom_point() +
  geom_autodensity(alpha = 0.5, colour = NA, position = 'identity') + 
  geom_smooth(aes(colour = NULL, fill = NULL)) + 
  facet_matrix(vars(elev.mean, bb.rich, log.bb.abund, fl.rich, 
                    log.fl.abund, bb.transects, fl.transects), 
               layer.diag = 2, 
               grid.y.diag = FALSE) +
  theme_light()

# 2011
ggplot(filter(netmet, year == 2011) %>% na.omit(), 
       aes(x = .panel_x, y = .panel_y)) + 
  geom_point() +
  geom_autodensity(alpha = 0.5, colour = NA, position = 'identity') + 
  geom_smooth(aes(colour = NULL, fill = NULL)) + 
  facet_matrix(vars(elev.mean, bb.rich, log.bb.abund, fl.rich, 
                    log.fl.abund, bb.transects, fl.transects), 
               layer.diag = 2, 
               grid.y.diag = FALSE) +
  theme_light()

# 2012
ggplot(filter(netmet, year == 2010) %>% na.omit(), 
       aes(x = .panel_x, y = .panel_y)) + 
  geom_point() +
  geom_autodensity(alpha = 0.5, colour = NA, position = 'identity') + 
  geom_smooth(aes(colour = NULL, fill = NULL)) + 
  facet_matrix(vars(elev.mean, bb.rich, log.bb.abund, fl.rich, 
                    log.fl.abund, bb.transects, fl.transects), 
               layer.diag = 2, 
               grid.y.diag = FALSE) +
  theme_light()
```

#### Network/group-level metrics
For these models, we will use the bs = "fs" factor smooth method. This preserves degrees of freedom by forcing all smooths to have the same wiggliness. 

**Results**

  * Niche overlap (37% explained)
    + Weakly quadratic negative effect of floral richness
    + Linear positive effect of (log) BB abundance
    + No significant effect of elevation
    + Linear or weakly quadratic positive effect of transect count in 2011 and 2012, but negative (weakly quadratic) effect in 2010.
  * C score (57% explained)
    + Cubic negative effect of BB richness.
    + Positive linear effect of elevation
    + Negative linear effect of transect number
    
**Discussion** 
These models explain a lot more variance than the elevation-only models did. Interestingly, the effect of elevation drops out entirely in the niche overlap model with the addition of the other covariates. This suggests that the effects of elevation may, indeed, be mediated by effects on abundance and diversity, but moreover that abundance and diversity affect network metrics apart from the influence of elevation.  

The story for niche overlap seems to be that diets become more similar as floral richness goes down and bumble bee abundance goes up. The relationship with floral richness seems easy to interpret: when there are fewer options, bumble bees are forced to overlap more in their choices. The positive relationship with BB abundance might be a samping effect; when a lot of bumble bees are seen, it is more likely that their observed diets will overlap. 

C score increased lineary with elevation, indicating that, as one moves upslope, BB diets tend to become more disaggregated (in a presence/absence sense -- C score is basically an inverse and binary version of niche overlap). It also decreased linearly with transect number, which is probably a sampling effect: with higher sampling intensity, more links are observed, resulting in more observed overlap and less disaggregation. The negative cubic relationship with BB richness -- and remember that BB richness and BB abundance are almost perfectly correlated -- also suggests a sampling effect: when there are more and more kinds of BB, observed overlap is higher. 
```{r message=FALSE, warning=FALSE}
# Niche overlap
gam_niche.overlap.global <- gam(niche.overlap.HL ~ 
                                  s(bb.rich, k = 4) +
                                  s(fl.rich, k = 4) +
                                  s(log.fl.abund, k = 4) +
                                  s(log.bb.abund, k= 4) +
                                  s(elev.mean, year, bs = "fs", k = 5) +
                                  s(bb.transects, year, bs = "fs", k = 4),
                                data = netmet,
                                family = "gaussian",
                                method = "REML",
                                select = TRUE) %>% getViz()
          
check.gamViz(gam_niche.overlap.global) 
summary(gam_niche.overlap.global)
print(plot(gam_niche.overlap.global, allTerms = T), pages = 1)

plot(sm(gam_niche.overlap.global, 6)) +
  l_fitLine(alpha = 0.6) 

# C score
gam_cscore.global <- gam(C.score.HL ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           s(elev.mean, year, bs = "fs", k = 5) +
                           s(bb.transects, year, bs = "fs", k = 4),
                         data = netmet,
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()
          
check.gamViz(gam_cscore.global) 
summary(gam_cscore.global)
print(plot(gam_cscore.global, allTerms = T), pages = 1)

plot(sm(gam_cscore.global, 4)) +
  l_fitLine(alpha = 0.6)

plot(sm(gam_cscore.global, 5)) +
  l_fitLine(alpha = 0.6) 
```

### Species-level d'

**Results (only significant terms shown)**

* 2010 (41% explained)
  + B. gerstaeckeri (positive, linear)
  + B. hortorum (positive, linear)
  + B. mendax (positive, linear)
  + B. pratorum (positive, quadratic)
  + B. psithyrus (positive, linear)
  + **B. pyrenaeus (negative, quadratic)**
  + B. soroensis (positive, quadratic)
* 2011 (58% explained)
  + Negative effect of BB richness (weakly cubic)
  + Positive effect of FL richness (cubic)
  + B. sensu-strictu (positive, linear)
  + B. hortorum (positive, linear)
  + B. hypnorum (positive, linear)
  + B. lapidarius (positive, linear)
  + B. monticola (positive, logistic)
  + B. pascuorum (positive, linear)
  + B. pratorum (positive, logistic)
  + B. psithyrus (positive, linear)
  + B. pyrenaeus (positive, linear)
  + B. soroensis (positive, linear)
  + B. wurflenii (positive, linear)
  + Transects (positive, quadratic)
* 2012 (43% explained)
  + Positive effect of BB richness (linear)
  + Negative effect of FL abundance (cubic)
  + Negative effect of BB abundance (linear)
  + B. hortorum (negative, linear)
  + B. mendax (negative, linear)
  + B. pascuorum (negative, linear)
  + B/ pyrenaeus (negative, linear)

**Discussion**
This is interesting. I do not fully understand why, but the addition of abundance and diversity covariates actually strengthens the apparent effects of elevation. It could also have something to do with setting select = TRUE. The change is most evident in 2011, where most BB species now show a significant relationship with elevation. The overall patterns are the same, though. Elevation has a positive effect on discrimination in 2010 and 2011, but this switches to a negative relationship in 2012. 


**Conclusion**

```{r}
### Species-specific models
gam_d.2010.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           bb.sp +
                           s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2010 & 
                                         !bb.sp %in% c("humi", "lapi")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()

gam_d.2010.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           s(elev.mean, bb.sp, bs = "fs", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2010 & 
                                         !bb.sp %in% c("humi", "lapi")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2010.global) 
summary(gam_d.2010.global)
print(plot(gam_d.2010.global, allTerms = TRUE), pages = 1)
print(plot(gam_d.2010.global, select = c(6, 7, 10, 14, 15, 16, 17)), pages = 1)


gam_d.2011.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           bb.sp +
                           s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2011 &
                                         !bb.sp %in% c("humi", "gers", "muci")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()

gam_d.2011.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           s(elev.mean, bb.sp, bs = "fs", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2011 &
                                         !bb.sp %in% c("humi", "gers", "muci")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2011.global) 
summary(gam_d.2011.global)
print(plot(gam_d.2011.global, allTerms = TRUE), pages = 1)
print(plot(gam_d.2011.global, select = c(1, 2, 5, 6, 7, 9, 11, 12, 13, 14, 15, 16, 17, 18)), pages = 1)


gam_d.2012.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           bb.sp +
                           s(elev.mean, by = bb.sp, bs = "tp", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2012 &
                                         !bb.sp %in% c("humi", "hypn", "muci")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()

gam_d.2012.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           s(elev.mean, bb.sp, bs = "fs", k = 5) +
                           s(bb.transects, k = 4),
                         data = filter(spmet, year == 2012 &
                                         !bb.sp %in% c("humi", "hypn", "muci")),
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()

gam_d.2012.global <- gam(d ~ 
                           s(bb.rich, k = 4) +
                           s(fl.rich, k = 4) +
                           s(log.fl.abund, k = 4) +
                           s(log.bb.abund, k= 4) +
                           s(elev.mean, bb.sp, bs = "fs", k = 5) +
                           s(bb.transects, k = 4),
                         data = spmet,
                         family = "gaussian",
                         method = "REML",
                         select = FALSE) %>% getViz()
          
check.gamViz(gam_d.2012.global) 
summary(gam_d.2012.global)
print(plot(gam_d.2012.global, select = c(1, 3, 4, 6, 10, 12, 15)), pages = 1)
plot(gam_d.2012.global, select = c(5))
plot(gam_d.2011.global, select = c(5))
plot(gam_d.2010.global, select = c(5))
```

### Conclusion ###
When niche overlap and C score are modeled only as functions of elevation and transect count, we can find interpretable, if weak, elevational patterns. When we include the other covariates, though, the influence of elevation is largely eclipsed by that of BB abundance/richness, and I am not confident that these relationships can be interpreted as anything more than sampling effects. This casts doubt on the legitimacy of the elevation patterns found when abundance and richness covariates are excluded; it's hard to make the case that they are not just sampling effects, too.

### Preliminary visualizations
#### Network metrics ~ elevation
```{r message=FALSE, warning=FALSE, echo = FALSE, include = FALSE}
ggplot(netmet, aes(elev.mean, connectance)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)

ggplot(netmet, aes(elev.mean, weighted.NODF)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

#### Group-level metrics ~ elevation
```{r message=FALSE, warning=FALSE, echo = FALSE, include = FALSE}
ggplot(netmet, aes(elev.mean, niche.overlap.HL)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)

ggplot(netmet, aes(elev.mean, C.score.HL)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)
```

#### Species-level d' ~ elevation
```{r  message=FALSE, warning=FALSE, echo = FALSE, include = FALSE}
# All together
ggplot(spmet, aes(elev.mean, d)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~year)

ggplot(spmet, aes(elev.mean, d)) +
  geom_point() +
  geom_smooth()

# Broken down by species
ggplot(spmet, aes(elev.mean, d, color = year)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  facet_wrap(~bb.sp)

ggplot(spmet, aes(log.bb.abund, d, color = year)) +
  geom_point() +
  #geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  facet_wrap(~bb.sp)

ggplot(spmet, aes(log.fl.abund, d, color = year)) +
  geom_point() +
  #geom_smooth(method = "lm", formula = y ~ poly(x, 3), se = FALSE) +
  facet_wrap(~bb.sp)

```

#### Species-level d' ~ bb.sp, year, and tongue length
```{r  message=FALSE, warning=FALSE, echo = FALSE, include = FALSE}
ggplot(spmet, aes(bb.sp, d)) +
  geom_boxplot()

ggplot(spmet, aes(bb.sp, d, fill = year)) +
  geom_boxplot()

ggplot(spmet, aes(year, d)) +
  geom_boxplot()

ggplot(spmet, aes(pbl.w, d)) +
  geom_point() +
  geom_smooth()
```
