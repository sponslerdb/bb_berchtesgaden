---
title: "Beta Diversity through Time and Space"
output: html_document
---

### Prepare environment
```{r message=FALSE, warning=FALSE}
library(lubridate)
library(sf)
library(gdm)
library(bipartite)
library(vegan)
library(mgcv)
library(mgcViz)
library(see)
library(tidyverse)
```

### Climate data
```{r echo=FALSE, message=FALSE, include=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year),
         yday = yday(date)) %>%
  dplyr::select(site, year, date, yday, gdd.cum) %>%
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) %>% # turn elav.class into an ordered factor
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load network and survey data
```{r}
net <- read_csv("../processed_data/network.csv")%>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  unite(site.year.day, site, year, dayofyear, sep = "_", remove = FALSE) %>%
  mutate(year = factor(year)) %>% # convert year to factor
  group_by(site, date) %>%
  arrange(site, date)

survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)
```


### betaboot function: This bootstraps the partitioning of interaction beta-diversity to account for differences in the number of sampling dates for each site in the same way the my other bootstrapping function ("bootnet" or something like that) bootstraps the calculation of network metrics. Note that due to some annoying behavior by webs2array(), I have to define an object within the for loop  of my function using the <<- global assignment operator. This is bad coding, but I can't figure out another way to get webs2array() to find the object it needs to find.
```{r message=FALSE}
betaboot <- function(x, n, iter) {
  
  out <- data.frame()
  
  index <- 0
  
  t_filter <- x %>%
    dplyr::select(site, date, year) %>%
    unique() %>%
    group_by(site, year) %>%
    mutate(transects = n()) %>%
    filter(transects >= n)
  
  for(i in 1:iter){
    
    index <- index + 1
    
    net.sub <- x %>%
      semi_join(t_filter) %>%
      ungroup() %>%
      dplyr::select(site, dayofyear) %>%
      unique() %>%
      group_by(site) %>%
      sample_n(n) %>%
      left_join(x)
    
    web <<- net.sub %>%
      group_by(site, bb.sp, plant.sp) %>%
      summarize(freq = n()) %>%
      dplyr::select(higher = bb.sp, lower = plant.sp, webID = site, freq) %>% # rename columns to match bipartite's expectations
      data.frame() %>% # convert to data frame
      frame2webs() # convert to to bipartite web

    array <- webs2array(web)
  
    beta <- betalinkr_multi(array, partition.st = TRUE, partition.rr = TRUE, binary = TRUE) %>%
      as_tibble() %>%
      mutate(iteration = rep(index, n()))

    out <- bind_rows(out, beta)
  } 

  out <- out %>%
    as_tibble() %>%
    dplyr::select(site1 = i, site2 = j, everything()) %>%
    gather(metric, value, -c(site1, site2, iteration)) %>%
    mutate(metric.class = case_when(
        metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
        metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
        metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
        metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
      ),
      iteration = factor(iteration))
}
```

### Tabulate webs
S	= beta_S, the dissimilarity in species composition
OS = beta_OS, the dissimilarity (component) explained by "rewiring" among shared species
WN = beta_WN, the dissimilarity between the two networks
ST = beta_ST, the dissimilarity (component) explained by difference in species community composition 
```{r message=FALSE}
net2010 <- filter(net, year == 2010)
net2011 <- filter(net, year == 2011)
net2012 <- filter(net, year == 2012)

beta_2010 <- betaboot(net2010, 5, 50) %>%
  group_by(site1, site2, metric, metric.class) %>%
  summarize(value = mean(value)) %>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         ),
         year = factor(rep("2010", n()))) 

beta_2011 <- betaboot(net2011, 5, 50) %>%
  group_by(site1, site2, metric, metric.class) %>%
  summarize(value = mean(value)) %>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         ),
         year = factor(rep("2011", n()))) 

beta_2012 <- betaboot(net2012, 9, 50) %>%
  group_by(site1, site2, metric, metric.class) %>%
  summarize(value = mean(value)) %>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, site2, metric, metric.class, value, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         ),
         year = factor(rep("2012", n()))) 

beta_agg <- bind_rows(beta_2010, beta_2011, beta_2012)

#write_csv(beta_agg, "./output/aggregated_beta_diversity.csv")
#beta_agg <- read_csv("./output/aggregated_beta_diversity.csv")
```

### Plot results. There's nothing a Mantel test can tell me that I don't already know from the combination of plotting and GDM analysis.
```{r}
### Elevation
ggplot(filter(beta, year == "2010" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.45) +
  geom_smooth(method = "lm", formula =  y ~ poly(x, 3)) +
  facet_wrap(~metric.class) +
  theme_abyss()
  
ggplot(filter(beta, year == "2011" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.45) +
  geom_smooth(method = "lm", formula =  y ~ poly(x, 3)) +
  facet_wrap(~metric.class) +
  theme_abyss()

ggplot(filter(beta, year == "2012" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.45) +
  geom_smooth(method = "lm", formula =  y ~ poly(x, 3)) +
  facet_wrap(~metric.class) +
  theme_abyss()

ggplot(filter(beta, 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.45) +
  geom_smooth(method = "lm", formula =  y ~ poly(x, 3)) +
  facet_wrap(~metric.class) +
  theme_gray()

### Management
ggplot(filter(beta, year == "2010" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(man.diff, value)) +
  geom_boxplot() +
  facet_wrap(~metric, scales = "free") +
  theme_gray()

ggplot(filter(beta, year == "2011" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(man.diff, value)) +
  geom_boxplot() +
  facet_wrap(~metric, scales = "free") +
  theme_gray()

ggplot(filter(beta, year == "2012" & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(man.diff, value)) +
  geom_boxplot() +
  facet_wrap(~metric, scales = "free") +
  theme_gray()
```

### Let's look at per-transect floral survey beta-diversity
```{r}
### 2012
survey_bioData.2012 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2012") %>%
  mutate(plant.sp = str_replace_all(plant.sp, " ", "_")) %>%
  group_by(site, yday, plant.sp) %>%
  summarize(cover = sum(flower.cover)) %>%
  spread(plant.sp, cover) %>%
  replace(is.na(.), 0) %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_")

survey_predData.2012 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2012") %>%
  dplyr::select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  dplyr::select(-site)

survey_sitepair.2012 <- formatsitepair(survey_bioData.2012, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = survey_predData.2012)

### Call gdm()
gdm_survey.2012 <- gdm(survey_sitepair.2012, geo = TRUE)
gdm.varImp(survey_sitepair.2012, geo = TRUE)

summary(gdm_survey.2012)
plot(gdm_survey.2012)
plotUncertainty(survey_sitepair.2012, sampleSites = 0.7, bsIters = 10, geo  = TRUE)

### 2011
survey_bioData.2011 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2011") %>%
  mutate(plant.sp = str_replace_all(plant.sp, " ", "_")) %>%
  group_by(site, yday, plant.sp) %>%
  summarize(cover = sum(flower.cover)) %>%
  spread(plant.sp, cover) %>%
  replace(is.na(.), 0) %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_")

predData.2011 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2011") %>%
  select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  select(-site)

survey_sitepair.2011 <- formatsitepair(survey_bioData.2011, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = predData.2011)

### Call gdm()
gdm_survey.2011 <- gdm(survey_sitepair.2011, geo = TRUE)
#gdm.varImp(survey_sitepair, geo = TRUE)

summary(gdm_survey.2011)
plot(gdm_survey.2011)
#plotUncertainty(survey_sitepair, sampleSites = 0.7, bsIters = 50, geo  = TRUE)

### 2010
survey_bioData.2010 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2010") %>%
  mutate(plant.sp = str_replace_all(plant.sp, " ", "_")) %>%
  group_by(site, yday, plant.sp) %>%
  summarize(cover = sum(flower.cover)) %>%
  spread(plant.sp, cover) %>%
  replace(is.na(.), 0) %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_")

predData.2010 <- survey %>%
  mutate(year = year(date),
         yday = yday(date)) %>%
  filter(flower.cover > 0 & year == "2010") %>%
  select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  select(-site)

survey_sitepair.2010 <- formatsitepair(survey_bioData.2010, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = predData.2010)

### Call gdm()
gdm_survey.2010 <- gdm(survey_sitepair.2010, geo = TRUE)
#gdm.varImp(survey_sitepair, geo = TRUE)

summary(gdm_survey.2010)
plot(gdm_survey.2010)
#plotUncertainty(survey_sitepair, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```

### And now Bombus diversity patterns
```{r}
### 2010
BB_bioData.2010 <- net %>%
  filter(year == 2010) %>%
  group_by(site, date, bb.sp) %>%
  summarize(count = n()) %>%
  group_by(site, date) %>%
  #mutate(prop = count/sum(count)) %>%
  #group_by(site, bb.sp) %>%
  # summarize(abund = sum(prop)) %>%
  spread(bb.sp, count) %>%
  replace(is.na(.), 0) %>%
  mutate(yday = yday(date)) %>%
  unite(site.day, site, yday, sep = "_", remove = "TRUE") %>%
  ungroup() %>%
  select(-date)

BB_predData.2010 <- net %>%
  filter(year == 2010) %>%
  mutate(yday = yday(date)) %>%
  dplyr::select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  dplyr::select(-site) 


bb_sitepair.2010 <- formatsitepair(BB_bioData.2010, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = BB_predData.2010)

### Call gdm()
gdm_bb.2010 <- gdm(bb_sitepair.2010, geo = TRUE)
gdm.varImp(bb_sitepair.2010, geo = TRUE)

summary(gdm_bb.2010)
plot(gdm_bb.2010)
plotUncertainty(bb_sitepair.2010, sampleSites = 0.7, bsIters = 50, geo  = TRUE)

### 2011
BB_bioData.2011 <- net %>%
  filter(year == 2011) %>%
  group_by(site, date, bb.sp) %>%
  summarize(count = n()) %>%
  group_by(site, date) %>%
  #mutate(prop = count/sum(count)) %>%
  #group_by(site, bb.sp) %>%
  # summarize(abund = sum(prop)) %>%
  spread(bb.sp, count) %>%
  replace(is.na(.), 0) %>%
  mutate(yday = yday(date)) %>%
  unite(site.day, site, yday, sep = "_", remove = "TRUE") %>%
  ungroup() %>%
  select(-date)

BB_predData.2011 <- net %>%
  filter(year == 2011) %>%
  mutate(yday = yday(date)) %>%
  dplyr::select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  dplyr::select(-site) 


bb_sitepair.2011 <- formatsitepair(BB_bioData.2011, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = BB_predData.2011)

### Call gdm()
gdm_bb.2011 <- gdm(bb_sitepair.2011, geo = TRUE)
gdm.varImp(bb_sitepair.2011, geo = TRUE)

summary(gdm_bb.2011)
plot(gdm_bb.2011)
plotUncertainty(bb_sitepair.2011, sampleSites = 0.7, bsIters = 50, geo  = TRUE)

### 2012
BB_bioData.2012 <- net %>%
  filter(year == 2012) %>%
  group_by(site, date, bb.sp) %>%
  summarize(count = n()) %>%
  group_by(site, date) %>%
  #mutate(prop = count/sum(count)) %>%
  #group_by(site, bb.sp) %>%
  # summarize(abund = sum(prop)) %>%
  spread(bb.sp, count) %>%
  replace(is.na(.), 0) %>%
  mutate(yday = yday(date)) %>%
  unite(site.day, site, yday, sep = "_", remove = "TRUE") %>%
  ungroup() %>%
  select(-date)

BB_predData.2012 <- net %>%
  filter(year == 2012) %>%
  mutate(yday = yday(date)) %>%
  dplyr::select(site, yday) %>%
  left_join(site_data) %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon, yday) %>%
  unique() %>%
  arrange(site, yday) %>%
  unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
  dplyr::select(-site) 


bb_sitepair.2012 <- formatsitepair(BB_bioData.2012, bioFormat = 1, siteColumn = "site.day", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = BB_predData.2012)

### Call gdm()
gdm_bb.2012 <- gdm(bb_sitepair.2012, geo = TRUE)
gdm.varImp(bb_sitepair.2012, geo = TRUE)

summary(gdm_bb.2012)
plot(gdm_bb.2012)
plotUncertainty(bb_sitepair.2012, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```

### Now let's look at interaction beta diversity. I don't think p-values would add anything to the interpretation I get from the plotted uncertainty, so it's okay that I can't get gdm.varImp() to work.
```{r}
### 2010
sitepair_2010 <- beta_2010 %>%
  ungroup() %>%
  filter(metric == "WN") %>%
  mutate(weights = rep(1, n())) %>%
  dplyr::select(distance = value, weights,
         s1.xCoord = lon1, s1.yCoord = lat1, 
         s2.xCoord = lon2, s2.yCoord = lat2, 
         s1.elev.mean = elev1, s2.elev.mean = elev2) %>%
  data.frame()

gdm_2010 <- gdm(sitepair_2010, geo = TRUE)
gdm.varImp(sitepair_2010, geo = TRUE)

summary(gdm_2010)
plot(gdm_2010)
plotUncertainty(sitepair_2010, sampleSites = 0.7, bsIters = 50, geo  = TRUE)

### 2011
sitepair_2011 <- beta_2011 %>%
  ungroup() %>%
  filter(metric == "WN") %>%
  mutate(weights = rep(1, n())) %>%
  dplyr::select(distance = value, weights,
         s1.xCoord = lon1, s1.yCoord = lat1, 
         s2.xCoord = lon2, s2.yCoord = lat2, 
         s1.elev.mean = elev1, s2.elev.mean = elev2) %>%
  data.frame()

gdm_2011 <- gdm(sitepair_2011, geo = TRUE)
gdm.varImp(sitepair_2011, geo = TRUE)

summary(gdm_2011)
plot(gdm_2011)
plotUncertainty(sitepair_2011, sampleSites = 0.7, bsIters = 50, geo  = TRUE)

### 2012
sitepair_2012 <- beta_2012 %>%
  ungroup() %>%
  filter(metric == "WN") %>%
  mutate(weights = rep(1, n())) %>%
  dplyr::select(distance = value, weights,
         s1.xCoord = lon1, s1.yCoord = lat1, 
         s2.xCoord = lon2, s2.yCoord = lat2, 
         s1.elev.mean = elev1, s2.elev.mean = elev2) %>%
  data.frame()

gdm_2012 <- gdm(sitepair_2012, geo = TRUE)
gdm.varImp(sitepair_2012, geo = TRUE)

summary(gdm_2012)
plot(gdm_2012)
plotUncertainty(sitepair_2012, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```

### Transect-level analysis
```{r}
beta_site.date.2010 <- betalinkr_multi(array_site.date.2010, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE) %>%
  as_tibble() %>%
  separate(i, into = c("site1", "year1", "yday1"), sep = "_") %>%
  separate(j, into = c("site2", "year2", "yday2"), sep = "_") %>%
  left_join(site_data, by = c("site1" = "site"))%>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(site1 = factor(site1),
         site2 = factor(site2),
         year1 = factor(year1),
         year2 = factor(year2),
         yday1 = as.numeric(yday1),
         yday2 = as.numeric(yday2),
         elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         yday.diff = abs(yday1 - yday2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, year1, yday1, site2, year2, yday2,
                           elev1, elev2, elev.diff, yday.diff, 
                           man1, man2, man.diff, mean.elev, 
                           lon1, lat1, lon2, lat2)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))

beta_site.date.2011 <- betalinkr_multi(array_site.date.2011, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE) %>%
  as_tibble() %>%
  separate(i, into = c("site1", "year1", "yday1"), sep = "_") %>%
  separate(j, into = c("site2", "year2", "yday2"), sep = "_") %>%
  left_join(site_data, by = c("site1" = "site"))%>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(site1 = factor(site1),
         site2 = factor(site2),
         year1 = factor(year1),
         year2 = factor(year2),
         yday1 = as.numeric(yday1),
         yday2 = as.numeric(yday2),
         elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         yday.diff = abs(yday1 - yday2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, year1, yday1, site2, year2, yday2,
                           elev1, elev2, elev.diff, yday.diff, 
                           man1, man2, man.diff, mean.elev, 
                           lon1, lat1, lon2, lat2)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))

beta_site.date.2012 <- betalinkr_multi(array_site.date.2012, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE) %>%
  as_tibble() %>%
  separate(i, into = c("site1", "year1", "yday1"), sep = "_") %>%
  separate(j, into = c("site2", "year2", "yday2"), sep = "_") %>%
  left_join(site_data, by = c("site1" = "site"))%>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(site1 = factor(site1),
         site2 = factor(site2),
         year1 = factor(year1),
         year2 = factor(year2),
         yday1 = as.numeric(yday1),
         yday2 = as.numeric(yday2),
         elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         yday.diff = abs(yday1 - yday2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, year1, yday1, site2, year2, yday2,
                           elev1, elev2, elev.diff, yday.diff, 
                           man1, man2, man.diff, mean.elev, 
                           lon1, lat1, lon2, lat2)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))

beta_site.date <- bind_rows(beta_site.date.2010, beta_site.date.2011, beta_site.date.2012)
beta_site.date_gdm.prep <- beta_site.date %>%
  filter(metric == "WN")

write_csv(beta_site.date, "../analyses/output/beta_site.date.csv")
beta_site.date <- read_csv("../analyses/output/beta_site.date.csv") %>%
  mutate(year1 = factor(year1),
         year2 = factor(year2),
         metric = factor(metric))
```

### Plot transect-level analysis
```{r}
### Elevation diff
ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  theme_abyss()

### Time diff
ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(yday.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  theme_abyss()

### Elevation diff within 1 wk time diff
ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition" &
                yday.diff <= 7), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_wrap(~metric.class) +
  theme_abyss()

ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition" &
                yday.diff <= 7), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  theme_abyss()

### Time diff within 250 m elev diff
ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition" &
                elev.diff <= 7), 
       aes(yday.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_wrap(~metric.class) +
  theme_light()

ggplot(filter(beta_site.date, year1 == year2,
                metric != "S" & 
                metric.class != "OS.partition" &
                elev.diff <= 7), 
       aes(yday.diff, value, color = metric)) +
  geom_point(alpha = 0.15, size = 0.5) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  theme_abyss()

### 2D ElevationDiff*TimeDiff
gam_betadiv <- bamV(value ~ te(elev.diff, yday.diff, 
                               bs = c("te", "te"),
                               k = c(10, 10)),
                    family = "quasibinomial",
                    data = filter(beta_site.date, year1 == year2 &
                                    metric == "WN"),
                    method = "REML")

gam_betadiv <- bam(value ~ 
                     s(year1, bs = "re") +
                     te(yday.diff, elev.diff, k = c(10, 10)),
                   data = filter(beta_site.date, year1 == year2 &
                                   metric == "WN.rich"),
                   family = "quasibinomial",
                   discrete = TRUE,
                   method = "fREML") %>% getViz()

check.gamViz(gam_betadiv)
plot(gam_betadiv)

ggplot(filter(beta_site.date, year1 == year2 & metric == "WN"),
       aes(value)) +
  geom_histogram()
```

