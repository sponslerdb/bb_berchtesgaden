---
title: "Beta Diversity through Time and Space"
output: html_document
---

### Prepare environment
```{r message=FALSE, warning=FALSE}
library(vegan)
library(lubridate)
library(gdm)
library(bipartite)
library(sf)
library(mgcv)
library(mgcViz)
library(tidyverse)
```

### Climate data
```{r, include=FALSE, echo=FALSE}
gdd <- read_csv("../processed_data/climate.csv") %>%
  mutate(year = factor(year),
         yday = yday(date)) %>%
  dplyr::select(site, year, date, yday, gdd.cum) %>%
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load site data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) %>% # turn elav.class into an ordered factor
  semi_join(read_csv("../processed_data/network.csv"), by = "site")
```

### Load network and survey data and generate site.year and site.month.year webs
```{r}
net <- read_csv("../processed_data/network.csv")%>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  unite(site.year.day, site, year, dayofyear, sep = "_", remove = FALSE) %>%
  mutate(year = factor(year)) %>% # convert year to factor
  group_by(site, date) %>%
  arrange(site, date)

survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only plants visited (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)

site.year_transects <- net %>%
  group_by(site, year) %>%
  summarize(transects = length(unique(date)))

site_transects <- net %>%
  group_by(site) %>%
  summarize(transects = length(unique(date)))

web_site.year <- net %>%
  group_by(site.year, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site.year, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() # convert to to bipartite web

web_site <- net %>%
  group_by(site, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>% 
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() # convert to to bipartite web

web_site.date.2010 <- net %>%
  filter(year == 2010) %>%
  group_by(site.year.day, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site.year.day, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() # convert to to bipartite web

web_site.date.2011 <- net %>%
  filter(year == 2011) %>%
  group_by(site.year.day, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site.year.day, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() # convert to to bipartite web

web_site.date.2012 <- net %>%
  filter(year == 2012) %>%
  group_by(site.year.day, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site.year.day, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs() # convert to to bipartite web

array_site <- webs2array(web_site)
array_site.year <- webs2array(web_site.year)
array_site.date.2010 <- webs2array(web_site.date.2010)
array_site.date.2011 <- webs2array(web_site.date.2011)
array_site.date.2012 <- webs2array(web_site.date.2012)
```

### Tabulate webs
S	= beta_S, the dissimilarity in species composition
OS = beta_OS, the dissimilarity (component) explained by "rewiring" among shared species
WN = beta_WN, the dissimilarity between the two networks
ST = beta_ST, the dissimilarity (component) explained by difference in species community composition 
```{r}
beta_site <- betalinkr_multi(array_site, partition.st = TRUE, partition.rr = TRUE) %>%
  as_tibble() %>%
  rename(site1 = i) %>%
  rename(site2 = j)%>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, site2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, site2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  left_join(site_transects, by = c("site1" = "site")) %>%
  dplyr::select(site1, site2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2, man1, man2, lon1, lat1, lon2, lat2, transects1 = transects) %>%
  left_join(site_transects, by = c("site2" = "site")) %>%
  dplyr::select(site1, site2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2, man1, man2, lon1, lat1, lon2, lat2, transects1, transects2 = transects) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         transects.diff = abs(transects1 - transects2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, site2, elev1, elev2, elev.diff, 
                           man1, man2, man.diff, mean.elev, lon1, 
                           lat1, lon2, lat2, transects1, transects2, transects.diff)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))

#write_csv(beta_site, "../analyses/output/beta_site.csv")

beta_site.year <- betalinkr_multi(array_site.year, partition.st = TRUE, partition.rr = TRUE, binary = TRUE) %>%
  as_tibble() %>%
  separate(i, into = c("site1", "year1"), sep = "_") %>%
  separate(j, into = c("site2", "year2"), sep = "_") %>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, year1, site2, year2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, year1, site2, year2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  left_join(site.year_transects, by = c("site1" = "site", "year1" = "year")) %>%
  dplyr::select(site1, site2, year1, year2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2, man1, man2, lon1, lat1, lon2, lat2, transects1 = transects) %>%
  left_join(site.year_transects, by = c("site2" = "site", "year2" = "year")) %>%
  dplyr::select(site1, site2, year1, year2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2, man1, man2, lon1, lat1, lon2, lat2, transects1, transects2 = transects) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         transects.diff = abs(transects1 - transects2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, year1, site2, year2, elev1, elev2, elev.diff, 
                           man1, man2, man.diff, mean.elev, lon1, lat1, lon2, lat2,
                           transects1, transects2, transects.diff)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))


### By individual transect

beta_site.date.2010 <- betalinkr_multi(array_site.date.2010, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE) %>%
  as_tibble() %>%
  separate(i, into = c("site1", "date1"), sep = "_") %>%
  separate(j, into = c("site2", "date2"), sep = "_") %>%
  left_join(site_data, by = c("site1" = "site"))%>%
  dplyr::select(site1, date1, site2, date2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1 = elev.mean, man1 = management, lon1 = lon, lat1 = lat) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, date1, site2, date2, S, OS, WN, ST, 
         ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
         elev1, elev2 = elev.mean, man1, man2 = management, lon1, lat1, lon2 = lon, lat2 = lat) %>%
  mutate(elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, date1, site2, date2, elev1, elev2, elev.diff, 
                           man1, man2, man.diff, mean.elev, lon1, lat1, lon2, lat2)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"
  ))

beta_site.date.2011 <- betalinkr_multi(array_site.date.2011, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE)

beta_site.date.2012 <- betalinkr_multi(array_site.date.2012, 
                                       partition.st = TRUE, 
                                       partition.rr = TRUE)
```

# Beta diversity by elevation difference
```{r}
# Interaction beta diversity by elevation difference (by year)
## This shows that the patterns are extremely consistent across years, which is not surprising, since they are driven overwhelmingly by floral turnover, and plants tend to be in the same place from year to year.
ggplot(filter(beta_site.year, year1 == year2 & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  facet_grid(metric.class ~ year1)

ggplot(filter(beta_site.year, year1 == year2 & 
                metric != "S" & 
                metric.class != "OS.partition"), 
       aes(transects.diff, value, color = metric)) +
  geom_point(alpha = 0.25) +
  geom_smooth() +
  facet_grid(metric.class ~ year1, scales = "free_x")

# Interaction beta diversity by elevation difference, this time pooling across years
ggplot(filter(beta_site, metric != "S" & 
                metric.class != "OS.partition"), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.05) +
  geom_smooth() +
  facet_wrap(~metric.class)

# How important is the difference in transects? Not as important as the difference in elevation.
ggplot(filter(beta_site, metric != "S" & 
                metric.class != "OS.partition"), 
       aes(transects.diff, value, color = metric)) +
  geom_point(alpha = 0.05) +
  geom_smooth() +
  facet_wrap(~metric.class)

ggplot(beta_site, 
       aes(elev.diff, transects.diff)) +
  geom_point(alpha = 0.05) +
  geom_smooth()

### Okay, we'll just do partial mantel tests to partial out the effect of transects.diff; and we'll only do that for the aggregate measures because it seems a bit silly to doi it for the partitions  
WN_diff <- beta_site %>%
  filter(metric == "WN") %>%
  dplyr::select(site1, site2, value) %>%
  spread(site2, value) %>%
  dist()

WN_diff <- beta_site %>%
  filter(metric == "WN") %>%
  dplyr::select(site1, site2, value) %>%
  spread(site2, value) %>%
  dist()

ST_diff <- beta_site %>%
  filter(metric == "ST") %>%
  dplyr::select(site1, site2, value) %>%
  spread(site2, value) %>%
  dist()

OS_diff <- beta_site %>%
  filter(metric == "OS") %>%
  dplyr::select(site1, site2, value) %>%
  spread(site2, value) %>%
  dist()

elev_diff <- beta_site %>%
  dplyr::select(site1, site2, elev.diff) %>%
  unique() %>%
  spread(site2, elev.diff) %>%
  dist()

transects_diff <- beta_site %>%
  dplyr::select(site1, site2, transects.diff) %>%
  unique() %>%
  spread(site2, transects.diff) %>%
  dist()

WN_mantel <- mantel.partial(elev_diff, WN_diff, transects_diff)
ST_mantel <- mantel.partial(elev_diff, ST_diff, transects_diff)
OS_mantel <- mantel.partial(elev_diff, OS_diff, transects_diff)
```

### Let's look at floral survey diversity patterns
```{r}
survey_transects <- survey %>%
  group_by(site) %>%
  summarize(transects = length(unique(date)))

survey_bioData <- survey %>%
  filter(flower.cover > 0) %>%
  mutate(plant.sp = str_replace_all(plant.sp, " ", "_")) %>%
  group_by(site, plant.sp) %>%
  summarize(cover = sum(flower.cover)) %>%
  spread(plant.sp, cover) %>%
  replace(is.na(.), 0)

predData <- site_data %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon) %>%
  unique()
%>%
  left_join(survey_transects)

survey_sitepair <- formatsitepair(survey_bioData, bioFormat = 1, siteColumn = "site", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = predData)

### Call gdm()
gdm_survey <- gdm(survey_sitepair, geo = TRUE)
gdm.varImp(survey_sitepair, geo = TRUE)

summary(gdm_survey)
plot(gdm_survey)
plotUncertainty(survey_sitepair, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```

### And now Bombus diversity patterns
```{r}
BB_bioData <- net %>%
  group_by(site, date, bb.sp) %>%
  summarize(count = n()) %>%
  group_by(site, date) %>%
  mutate(prop = count/sum(count)) %>%
  group_by(site, bb.sp) %>%
  summarize(abund = sum(prop)) %>%
  spread(bb.sp, abund) %>%
  replace(is.na(.), 0)

predData <- site_data %>%
  ungroup() %>%
  dplyr::select(site, elev.mean, lat, lon) %>%
  unique()

bb_sitepair <- formatsitepair(BB_bioData, bioFormat = 1, siteColumn = "site", dist = "jaccard",
                              XColumn = "lon", YColumn = "lat", predData = predData)

### Call gdm()
gdm_bb <- gdm(bb_sitepair, geo = TRUE)
gdm.varImp(bb_sitepair, geo = TRUE)

summary(gdm_bb)
plot(gdm_bb)
plotUncertainty(bb_sitepair, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```

### Now let's look at interaction beta diversity
```{r}
net_sitepair <- beta_site %>%
  filter(metric == "WN") %>%
  mutate(weights = rep(1, n())) %>%
  dplyr::select(distance = value, weights,
         s1.xCoord = lon1, s1.yCoord = lat1, 
         s2.xCoord = lon2, s2.yCoord = lat2, 
         s1.elev.mean = elev1, s2.elev.mean = elev2) %>%
  data.frame()

### Call gdm()
gdm_net <- gdm(net_sitepair, geo = TRUE)
gdm.varImp(net_sitepair, geo = TRUE)

summary(gdm_net)
plot(gdm_net)
plotUncertainty(net_sitepair, sampleSites = 0.7, bsIters = 50, geo  = TRUE)
```
