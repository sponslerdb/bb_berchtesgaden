---
title: "Beta Diversity through Time and Space"
output: html_document
---

### Prepare environment
```{r message=FALSE, warning=FALSE}
library(lubridate)
library(sf)
library(gdm)
library(bipartite)
library(vegan)
library(mgcv)
library(mgcViz)
library(see)
library(tidyverse)
```

### Load site data
```{r, include=FALSE, echo=FALSE}
# A function for converting a geometry column back to x and y columns
# https://github.com/r-spatial/sf/issues/231
sfc_as_cols <- function(x, names = c("x","y")) {
  stopifnot(inherits(x,"sf") && inherits(sf::st_geometry(x),"sfc_POINT"))
  ret <- sf::st_coordinates(x)
  ret <- tibble::as_tibble(ret)
  stopifnot(length(names) == ncol(ret))
  x <- x[ , !names(x) %in% names]
  ret <- setNames(ret,names)
  dplyr::bind_cols(x,ret)
}

site_data <- read_csv("../processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) %>% # turn elav.class into an ordered factor
  semi_join(read_csv("../processed_data/network.csv"), by = "site") %>% # drop sites that were not sampled
  st_as_sf(coords = c("lon", "lat")) %>%
  st_set_crs(4326) %>%
  st_transform(5684) %>%
  sfc_as_cols() %>%
  as_tibble() %>%
  dplyr::select(-geometry)
```

### Load network and survey data
```{r}
net <- read_csv("../processed_data/network.csv") %>%
  unite(site.year.day, site, year, dayofyear, sep = "_", remove = FALSE) %>% # create site.date field that can be split up again later
  mutate(year = factor(year)) # convert year to factor

survey <- read_csv("../processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only visited plant spp. (anytime, anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover)
```

### Tabulate webs
S	= beta_S, the dissimilarity in species composition
OS = beta_OS, the dissimilarity (component) explained by "rewiring" among shared species
WN = beta_WN, the dissimilarity between the two networks
ST = beta_ST, the dissimilarity (component) explained by difference in species community composition 
```{r message=FALSE}
# Function to convert networks to webs arrays
web_prep <- function(net, y) {
  out <- net %>%
    filter(year == y) %>%
    unite(site.date, c(site, date), sep = "_") %>%
  group_by(site.date, bb.sp, plant.sp) %>%
  summarize(freq = n()) %>%
  group_by(site.date) %>%
  mutate(bb.sp.count = length(unique(bb.sp)),
         plant.sp.count = length(unique(plant.sp))) %>%
  ungroup() %>%
  filter(bb.sp.count > 1 & plant.sp.count > 1) %>% # the betalinkr function fails if you feed it webs with only 1 species in either (or perhaps both) of the levels; this is probably for good reason.
  dplyr::select(higher = bb.sp, lower = plant.sp, webID = site.date, freq) %>% # rename columns to match bipartite's expectations
  data.frame() %>% # convert to data frame
  frame2webs(type.out = "array")
}

# Create webs
net2010 <- web_prep(net, 2010)
net2011 <- web_prep(net, 2011)
net2012 <- web_prep(net, 2012)

# Function with betalinkr settings and conversion to tibble()
betalinkr_set1 <- function(x) {
  betalinkr_multi(x, partition.st = TRUE, partition.rr = TRUE, # partition both species turnover and richness/replacement
                  binary = TRUE, # treating beta-diversity as binary is an appropriate complement to our abundance analysis
                  index = "jaccard") %>% # the Jaccard index is best, I think, for binary analysis
  as_tibble() # for convenience
}

# Calculate beta-diversity
beta_site.date.2010 <- betalinkr_set1(net2010)
beta_site.date.2011 <- betalinkr_set1(net2011) 
beta_site.date.2012 <- betalinkr_set1(net2012) 

# Collate results into a single tibble
beta_site.date <- bind_rows(beta_site.date.2010, beta_site.date.2011, beta_site.date.2012)

# Save to file to avoid redoing that long step
write_csv(beta_site.date, "./output/beta_site.date.csv")
beta_site.date <- read_csv("./output/beta_site.date.csv")

# Add site data
beta_mit_data <- beta_site.date %>%
  separate(i, into = c("site1", "date1"), sep = "_") %>%
  separate(j, into = c("site2", "date2"), sep = "_") %>%
  mutate(date1 = ymd(date1),
         date2 = ymd(date2),
         year1 = factor(year(date1)),
         year2 = factor(year(date2)),
         yday1 = yday(date1),
         yday2 = yday(date2)) %>%
  left_join(site_data, by = c("site1" = "site")) %>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1 = elev.mean, man1 = management, x1 = x, y1 = y) %>%
  left_join(site_data, by = c("site2" = "site")) %>%
  dplyr::select(site1, year1, yday1, site2, year2, yday2, S, OS, WN, ST, 
                ST.l, ST.h, ST.lh, WN.repl, OS.repl, WN.rich, OS.rich, 
                elev1, elev2 = elev.mean, man1, man2 = management, x1, y1, x2 = x, y2 = y) %>%
  mutate(site1 = factor(site1),
         site2 = factor(site2),
         year1 = factor(year1),
         year2 = factor(year2),
         yday1 = as.numeric(yday1),
         yday2 = as.numeric(yday2),
         elev.diff = abs(elev1 - elev2),
         mean.elev = (elev1 + elev2)/2,
         yday.diff = abs(yday1 - yday2),
         man.diff = case_when(
           man1 == man2 ~ FALSE,
           man1 != man2 ~ TRUE
         )) %>%
  gather(metric, value, -c(site1, year1, yday1, site2, year2, yday2,
                           elev1, elev2, elev.diff, yday.diff, 
                           man1, man2, man.diff, mean.elev, 
                           x1, y1, x2, y2)) %>%
  mutate(metric.class = case_when(
    metric %in% c("WN", "ST", "OS", "S") ~ "aggregate",
    metric %in% c("WN.repl", "WN.rich") ~ "WN.partition",
    metric %in% c("ST.h", "ST.l", "ST.lh") ~ "ST.partition",
    metric %in% c("OS.repl", "OS.rich") ~ "OS.partition"),
    metric = factor(metric, levels = c("WN", "ST", "OS", "ST.h", "ST.l", 
                                       "ST.lh", "WN.repl", "WN.rich", 
                                       "OS.repl", "OS.rich"))
    )
```

### Plot interaction beta-diversity against elevation difference and time difference
```{r}
# Set palette
p <- c("OS" = "darkorange1", "ST" = "green3", 
       "ST.h" = "firebrick1", "ST.l" = "darkorchid", 
       "ST.lh" = "deepskyblue", "WN" = "black")

# Elevation diff
ggplot(filter(beta_mit_data, year1 == year2 &
                site1 != site2 &
                metric != "S" & 
                !metric.class %in% c("OS.partition", "WN.partition")), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.25, pch = 16) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  scale_color_manual(values = p) +
  theme_abyss()

# Time diff
ggplot(filter(beta_mit_data, year1 == year2 &
                site1 != site2 &
                metric != "S" & 
                !metric.class %in% c("OS.partition", "WN.partition")), 
       aes(yday.diff, value, color = metric)) +
  geom_point(alpha = 0.25, pch = 16) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  scale_color_manual(values = p) +
  theme_abyss()

# Elevation diff within 1 wk time diff
ggplot(filter(beta_mit_data, year1 == year2 &
                site1 != site2 &
                metric != "S" & 
                !metric.class %in% c("OS.partition", "WN.partition") &
                yday.diff <= 7), 
       aes(elev.diff, value, color = metric)) +
  geom_point(alpha = 0.1, pch = 16, size = 1) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  scale_color_manual(values = p, name = "partition") +
  xlab("Elevation difference") +
  ylab("β-diversity")
ggsave("./output/beta_elev.png", height = 4.5, width = 6.5, units = "in")

# Time diff within 250 m elev diff
ggplot(filter(beta_mit_data, year1 == year2 &
                site1 != site2 &
                metric != "S" & 
                !metric.class %in% c("OS.partition", "WN.partition") &
                elev.diff <= 250), 
       aes(yday.diff, value, color = metric)) +
  geom_point(alpha = 0.1, pch = 16, size = 1) +
  geom_smooth() +
  facet_grid(metric.class ~ year1) +
  scale_color_manual(values = p, name = "partition") +
  xlab("Elevation difference") +
  ylab("β-diversity")
ggsave("./output/beta_time.png", height = 4.5, width = 6.5, units = "in")
```

### GDM: Interactions
```{r message=FALSE, warning=FALSE}
# Site_pair prep function
site_pair_prep_net <- function(dat, y) {
  beta_mit_data %>%
    ungroup() %>%
    filter(year1 == year2 & 
             year1 == y & 
             site1 != site2) %>% # I don't think we want to compare samples through within sites, introduces a new form of non-independence.
    filter(metric == "WN") %>% # we'll focus for now on WN, but this could be done for partitions, too
    mutate(weights = rep(1, n())) %>% # right now this analysis is unweighted; could weight by abundance, etc, if we wanted to
    dplyr::select(distance = value, weights,
                  s1.xCoord = x1, s1.yCoord = y1, 
                  s2.xCoord = x2, s2.yCoord = y2, 
                  s1.elev.mean = elev1, s1.yday = yday1,
                  s2.elev.mean = elev2, s2.yday = yday2) %>%
    data.frame()
}

# Prep site-pairs for GDM analysis
sitepair_2010.WN <- site_pair_prep_net(beta_mit_data, 2010)
sitepair_2011.WN <- site_pair_prep_net(beta_mit_data, 2011)
sitepair_2012.WN <- site_pair_prep_net(beta_mit_data, 2012)

# Run GDM analysis
gdm_WN.2010 <- gdm(sitepair_2010.WN, geo = TRUE)
gdm_WN.2011 <- gdm(sitepair_2011.WN, geo = TRUE)
gdm_WN.2012 <- gdm(sitepair_2012.WN, geo = TRUE)

summary(gdm_WN.2010)
summary(gdm_WN.2011)
summary(gdm_WN.2012)

# Permutation tests (slow)
gdm_WN.2010.imp <- gdm.varImp(sitepair_2010.WN, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "interaction_permGDM_2010")
gdm_WN.2011.imp <- gdm.varImp(sitepair_2011.WN, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "interaction_permGDM_2011")
gdm_WN.2012.imp <- gdm.varImp(sitepair_2012.WN, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "interaction_permGDM_2012")

# Plot
plot(gdm_WN.2010, include.rug = TRUE, 
     rug.sitepair = sitepair_2010.WN, 
     plot.layout = c(2,3))
plot(gdm_WN.2011, include.rug = TRUE, 
     rug.sitepair = sitepair_2011.WN, 
     plot.layout = c(2,3))
plot(gdm_WN.2012, include.rug = TRUE, 
     rug.sitepair = sitepair_2012.WN, 
     plot.layout = c(2,3))

# Plot with confidence intervals (slow; also, I'm not sure about the current settings)
plotUncertainty(sitepair_2010.WN, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(sitepair_2011.WN, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(sitepair_2012.WN, sampleSites = 0.7, bsIters = 10, geo  = TRUE)

# Plot nicely
## wrapper for extracting splines and prepping tibble for plotting
spline_prep <- function(x, y) {
  isplineExtract(x) %>%
    as.data.frame() %>%
    tibble() %>%
    mutate(x.Geographic = x.Geographic/1000) %>%
    pivot_longer(cols = c(x.Geographic, x.elev.mean, x.yday), 
                 names_to = "x.var", values_to = "predictor", 
                 names_prefix = "x.") %>%
    pivot_longer(cols = c(y.Geographic, y.elev.mean, y.yday), 
                 names_to = "y.var", values_to = "response", 
                 names_prefix = "y.") %>%
    filter(x.var == y.var) %>%
    mutate() %>%
    dplyr::select(-y.var) %>%
    mutate(year = factor(rep(y, n())))
}

## extract splines
interaction_splines2010 <- spline_prep(gdm_WN.2010, 2010)
interaction_splines2011 <- spline_prep(gdm_WN.2011, 2011)
interaction_splines2012 <- spline_prep(gdm_WN.2012, 2012)

## collate extracted splines  
interaction_splines <- bind_rows(interaction_splines2010, 
                                 interaction_splines2011, 
                                 interaction_splines2012) %>%
  mutate(x.var = case_when(
    x.var == "elev.mean" ~ "Elevation (m)",
    x.var == "Geographic" ~ "Geographic (km)",
    x.var == "yday" ~ "Day of Year"),
    x.var = factor(x.var, levels = c("Geographic (km)", "Elevation (m)", "Day of Year"))
    )

## plot
ggplot(interaction_splines, aes(predictor, response)) +
  geom_line() +
  facet_grid(year ~ x.var, scales = "free_x") +
  xlab(NULL) +
  ylab("f(x)") +
  theme_gray(12)
ggsave("./output/interaction_GDM.png")
```

### GDM: Floral survey
```{r}
# Create functions for prepping data
biodata_prep_survey <- function(surv, y) {
  surv %>%
    mutate(year = year(date),
           yday = yday(date)) %>%
    filter(flower.cover > 0 & year == y) %>%
    mutate(plant.sp = str_replace_all(plant.sp, " ", "_")) %>%
    group_by(site, yday, plant.sp) %>%
    summarize(cover = sum(flower.cover)) %>%
    mutate(cover = rep(1, n())) %>% # this makes the data binary, which I think is what I want here; otherwise, just comment out
    spread(plant.sp, cover) %>%
    replace(is.na(.), 0) %>%
    arrange(site, yday) %>%
    unite(site.day, site, yday, sep = "_")
}

predData_prep_survey <- function(surv, y) {
  surv %>%
    mutate(year = year(date),
           yday = yday(date)) %>%
    filter(flower.cover > 0 & year == y) %>%
    dplyr::select(site, yday) %>%
    left_join(site_data) %>%
    ungroup() %>%
    dplyr::select(site, elev.mean, y, x, yday) %>%
    unique() %>%
    arrange(site, yday) %>%
    unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
    dplyr::select(-site)
}

format_set <- function(bio, pred) {
  formatsitepair(bio, bioFormat = 1, siteColumn = "site.day", 
                 dist = "jaccard", XColumn = "x", YColumn = "y", 
                 predData = pred, abundance = FALSE) %>%
  filter(s1.elev.mean != s2.elev.mean) # this avoids comparing repeated measures of the same site (taking advantage of the fact that each site has a unique elevation in our dataset)
} 

# Prep input for GDM
survey_bioData.2010 <- biodata_prep_survey(survey, 2010)
survey_predData.2010 <- predData_prep_survey(survey, 2010)
survey_sitepair.2010 <- format_set(survey_bioData.2010, survey_predData.2010) 

survey_bioData.2011 <- biodata_prep_survey(survey, 2011)
survey_predData.2011 <- predData_prep_survey(survey, 2011)
survey_sitepair.2011 <- format_set(survey_bioData.2011, survey_predData.2011)

survey_bioData.2012 <- biodata_prep_survey(survey, 2012)
survey_predData.2012 <- predData_prep_survey(survey, 2012)
survey_sitepair.2012 <- format_set(survey_bioData.2012, survey_predData.2012)

# Call GDMs
gdm_survey.2010 <- gdm(survey_sitepair.2010, geo = TRUE)
gdm_survey.2011 <- gdm(survey_sitepair.2011, geo = TRUE)
gdm_survey.2012 <- gdm(survey_sitepair.2012, geo = TRUE)

summary(gdm_survey.2010)
summary(gdm_survey.2011)
summary(gdm_survey.2012)

# Permutations tests (slow)
gdm_survey.2010.imp <- gdm.varImp(survey_sitepair.2010, geo = TRUE, 
                              parallel = TRUE, cores = 3,
                              outFile = "survey_permGDM_2010")
gdm_survey.2011.imp <- gdm.varImp(survey_sitepair.2011, geo = TRUE, 
                              parallel = TRUE, cores = 3,
                              outFile = "survey_permGDM_2011")
gdm_survey.2012.imp <- gdm.varImp(survey_sitepair.2012, geo = TRUE, 
                              parallel = TRUE, cores = 3,
                              outFile = "survey_permGDM_2012")

# Plot
plot(gdm_survey.2010)
plot(gdm_survey.2011)
plot(gdm_survey.2012)

# Plot with confidence intervals (slow)
plotUncertainty(survey_sitepair.2010, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(survey_sitepair.2011, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(survey_sitepair.2012, sampleSites = 0.7, bsIters = 10, geo  = TRUE)

# Plot nicely
## extract splines
survey_splines2010 <- spline_prep(gdm_survey.2010, 2010)
survey_splines2011 <- spline_prep(gdm_survey.2011, 2011)
survey_splines2012 <- spline_prep(gdm_survey.2012, 2012)

## collate extracted splines  
survey_splines <- bind_rows(survey_splines2010,
                            survey_splines2011, 
                            survey_splines2012) %>%
  mutate(x.var = case_when(
    x.var == "elev.mean" ~ "Elevation (m)",
    x.var == "Geographic" ~ "Geographic (km)",
    x.var == "yday" ~ "Day of Year"),
    x.var = factor(x.var, levels = c("Geographic (km)", "Elevation (m)", "Day of Year"))
    )

## plot
ggplot(survey_splines, aes(predictor, response)) +
  geom_line() +
  facet_grid(year ~ x.var, scales = "free_x") +
  xlab(NULL) +
  ylab("f(x)") +
  theme_gray(12)
ggsave("./output/survey_GDM.png")
```

### GDM: BB observations; this won't work in it's present state because I cannot 
```{r}
# Create functions for prepping data
biodata_prep_BB <- function(net, y) {
  net %>%
    filter(year == y) %>%
    group_by(site, date, bb.sp) %>%
    summarize(count = n()) %>%
    mutate(count = rep(1, n())) %>% # this makes the data binary, which I think is what I want here; otherwise, just comment out
    spread(bb.sp, count) %>%
    replace(is.na(.), 0) %>%
    mutate(yday = yday(date)) %>%
    unite(site.day, site, yday, sep = "_", remove = "TRUE") %>%
    ungroup() %>%
    dplyr::select(-date)
}

predData_prep_BB <- function(net, y) {
  net %>%
    filter(year == y) %>%
    mutate(yday = yday(date)) %>%
    dplyr::select(site, yday) %>%
    left_join(site_data) %>%
    ungroup() %>%
    dplyr::select(site, elev.mean, y, x, yday) %>%
    unique() %>%
    arrange(site, yday) %>%
    unite(site.day, site, yday, sep = "_", remove = "FALSE") %>%
    dplyr::select(-site)
}

# Prep input for GDM
BB_bioData.2010 <- biodata_prep_BB(net, 2010)
BB_predData.2010 <- predData_prep_BB(net, 2010)
BB_sitepair.2010 <- format_set(BB_bioData.2010, BB_predData.2010)

BB_bioData.2011 <- biodata_prep_BB(net, 2011)
BB_predData.2011 <- predData_prep_BB(net, 2011)
BB_sitepair.2011 <- format_set(BB_bioData.2011, BB_predData.2011)

BB_bioData.2012 <- biodata_prep_BB(net, 2012)
BB_predData.2012 <- predData_prep_BB(net, 2012)
BB_sitepair.2012 <- format_set(BB_bioData.2012, BB_predData.2012)

# Call GDMs
gdm_BB.2010 <- gdm(BB_sitepair.2010, geo = TRUE)
gdm_BB.2011 <- gdm(BB_sitepair.2011, geo = TRUE)
gdm_BB.2012 <- gdm(BB_sitepair.2012, geo = TRUE)

summary(gdm_BB.2010)
summary(gdm_BB.2011)
summary(gdm_BB.2012)

# Permutations tests (slow)
gdm_BB.2010.imp <- gdm.varImp(BB_sitepair.2010, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "bb_permGDM_2010")
gdm_BB.2011.imp <- gdm.varImp(BB_sitepair.2011, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "bb_permGDM_2011")
gdm_BB.2012.imp <- gdm.varImp(BB_sitepair.2012, geo = TRUE, 
                              parallel = TRUE, cores = 4,
                              outFile = "bb_permGDM_2012")

# Plot
plot(gdm_BB.2010)
plot(gdm_BB.2011)
plot(gdm_BB.2012)

# Plot with confidence intervals (slow)
p <- plotUncertainty(BB_sitepair.2010, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(BB_sitepair.2011, sampleSites = 0.7, bsIters = 10, geo  = TRUE)
plotUncertainty(BB_sitepair.2012, sampleSites = 0.7, bsIters = 10, geo  = TRUE)

# Plot nicely
## extract splines
bb_splines2010 <- spline_prep(gdm_BB.2010, 2010)
bb_splines2011 <- spline_prep(gdm_BB.2011, 2011)
bb_splines2012 <- spline_prep(gdm_BB.2012, 2012)

## collate extracted splines  
bb_splines <- bind_rows(bb_splines2010,
                            bb_splines2011, 
                            bb_splines2012) %>%
  mutate(x.var = case_when(
    x.var == "elev.mean" ~ "Elevation (m)",
    x.var == "Geographic" ~ "Geographic (km)",
    x.var == "yday" ~ "Day of Year"),
    x.var = factor(x.var, levels = c("Geographic (km)", "Elevation (m)", "Day of Year"))
    )

## plot
ggplot(bb_splines, aes(predictor, response)) +
  geom_line() +
  facet_grid(year ~ x.var, scales = "free_x") +
  xlab(NULL) +
  ylab("f(x)") +
  theme_gray(12)
ggsave("./output/bb_GDM.png")
```


