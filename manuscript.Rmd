---
title: Bumble bee competition revisited under global climate change
author:
- Douglas B. Sponsler
- Fabrice Requier
- Katharina Kallnik
- Alice Cla√üen
- A. Fabienne Maihoff
- Ingolf Steffan-Dewenter
output:
  word_document:
    reference_docx: docx_template.docx
bibliography: refs.bib
---

```{r echo = FALSE, include = FALSE}
### Prepare environment
library(bipartite)
library(lme4)
library(lmerTest)
library(tidyverse)
library(lubridate)

### Load site data
site_data <- read_csv("./processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class = factor(elev.class, levels = c("oben", "mitte", "unten")),
         elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) # turn elav.class into an ordered factor

elev_classification <- site_data %>% 
  select(elev.mean, elev.class) %>% 
  unique() %>% 
  arrange(-elev.mean)

### Climate data
gdd <- read_csv("./processed_data/climate.csv") %>%
  mutate(year = factor(year)) %>%
  select(site, date, gdd.cum)

### Load network and survey data
bb_traits <- read_csv("./processed_data/bb_traits.csv") %>%
  select(subgenus, bb.sp, pbl.w, pbl.w.class)


net <- read_csv("./processed_data/network.csv") %>%
  unite(site.year, site, year, sep = "_", remove = FALSE) %>% # create site.year field that can later be split back up
  unite(site.date, site, date, sep = "_", remove = FALSE) %>%
  mutate(year = factor(year)) %>% # convert year to factor
  full_join(bb_traits, by = c("bb.sp.lat" = "bb.sp")) %>%
  left_join(site_data, by = "site") %>%
  left_join(gdd, by = c("site", "date")) %>%
  arrange(site, date)

survey <- read_csv("./processed_data/floral_survey.csv") %>%
  mutate(year = factor(year)) %>% # convert year to factor
  semi_join(net, by = c("site", "plant.sp")) %>% # Consider only plants visited at a given site-date
  left_join(gdd, by = c("site", "date")) %>%
  arrange(site, date)

### Per-transect Bombus density
bb_dens <- net %>%
  group_by(site, date, elev.class, elev.mean, year) %>%
  summarize(bb.dens = n()) 

### Per-transect floral density
fl_dens <- survey %>%
  group_by(site, date, year) %>%
  summarize(fl.dens = sum(flower.cover),
            log.fl.dens = log(sum(flower.cover)))

### Join BB density and floral cover
density <- bb_dens %>%
  full_join(fl_dens) %>% # Note that there is not perfect alignment in site-dates between the network observations and the floral surveying, so this join will cause some NAs that will need to be removed, causing some transects to drop out of the dataset
  na.omit() %>%
  ungroup %>%
  mutate(bb_per_fl = bb.dens/fl.dens,
         site = factor(site),
         yday = yday(date),
         week = week(date),
         month = month(date))

density_month.agg <- bb_dens %>%
  full_join(fl_dens) %>% # Note that there is not perfect alignment in site-dates between the network observations and the floral surveying, so this join will cause some NAs that will need to be removed, causing some transects to drop out of the dataset
  na.omit() %>%
  ungroup %>%
  mutate(site = factor(site),
         yday = yday(date),
         week = week(date),
         month = month(date)) %>%
  group_by(year, month, site, elev.mean, elev.class) %>%
  summarize(mean.bb.dens = mean(bb.dens),
            mean.fl.dens = mean(fl.dens)) %>%
  mutate(log.mean.fl.dens = log(mean.fl.dens),
         bb.per.fl = mean.bb.dens/mean.fl.dens)

###############################
######### Define functions
##############################

# Find breakpoints on GDD scale
breakpoints_gdd <- function(x, year, t1, t2) {
  
  data <- filter(x, year == !!year)
  
  # Logistic regression for first break point (founding to buildup)
  glm1.low <- glm(q.prop ~ gdd.cum,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "low"))
  
  glm1.mid <- glm(q.prop ~ gdd.cum,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "mid"))
    
  glm1.high <- glm(q.prop ~ gdd.cum,
                   family = quasibinomial,
                   data = filter(data, elev.class2 == "high"))
  
  # Logistic regression for second break point (buildup to reproductive)
  glm2.low <- glm(r.prop ~ gdd.cum,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "low"))
  
  glm2.mid <- glm(r.prop ~ gdd.cum,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "mid"))
    
  glm2.high <- glm(r.prop ~ gdd.cum,
                   family = quasibinomial,
                   data = filter(data, elev.class2 == "high"))
  
  ### Extract gdd corresponding to desired proportion; based on https://stackoverflow.com/questions/32040504/regression-logistic-in-r-finding-x-value-predictor-for-a-particular-y-value
  
  getX <- function(x, y) {
    (log(y/(1-y)) - coef(x)[1])/coef(x)[2]
    }

  break1.low <- getX(glm1.low, t1) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break1")  

  break1.mid <- getX(glm1.mid, t1) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "mid",
           breakID = "break1")
  
  break1.high <- getX(glm1.high, t1) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "high",
           breakID = "break1")
  
  break2.low <- getX(glm2.low, t2) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break2")  
  
  break2.mid <- getX(glm2.mid, t2) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "mid",
           breakID = "break2")
  
  break2.high <- getX(glm2.high, t2) %>%
    data.frame() %>%
    select(gdd = 1) %>%
    mutate(elev.class2 = "high",
           breakID = "break2")
  
  # Join into data frame, convert elev.class2 to ordered factor, spread
  breaks <- full_join(break1.low, break1.mid) %>%
    full_join(break1.high) %>%
    full_join(break2.low) %>%
    full_join(break2.mid) %>%
    full_join(break2.high) %>%
    mutate(elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) %>%
    spread(breakID, gdd)
  
  #
  out <- data %>%
    full_join(breaks) %>%
    gather(caste, count, -c(site, date, year, q.prop, r.prop,
                          gdd.cum, yday, elev.class, elev.class2, 
                          management, transect, elev.mean, 
                          lat, lon, break1, break2)) %>%
  group_by(site, date) %>%
  mutate(prop = count/sum(count))
}


# Find breakpoints on Julian scale
breakpoints_yday <- function(x, year, t1, t2) {
  
  data <- filter(x, year == !!year)
  
  # Logistic regression for first break point (founding to buildup)
  glm1.low <- glm(q.prop ~ yday,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "low"))
  
  glm1.mid <- glm(q.prop ~ yday,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "mid"))
    
  glm1.high <- glm(q.prop ~ yday,
                   family = quasibinomial,
                   data = filter(data, elev.class2 == "high"))
  
  # Logistic regression for second break point (buildup to reproductive)
  glm2.low <- glm(r.prop ~ yday,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "low"))
  
  glm2.mid <- glm(r.prop ~ yday,
                  family = quasibinomial,
                  data = filter(data, elev.class2 == "mid"))
    
  glm2.high <- glm(r.prop ~ yday,
                   family = quasibinomial,
                   data = filter(data, elev.class2 == "high"))
  
  ### Extract gdd corresponding to desired proportion; based on https://stackoverflow.com/questions/32040504/regression-logistic-in-r-finding-x-value-predictor-for-a-particular-y-value
  
  getX <- function(x, y) {
    (log(y/(1-y)) - coef(x)[1])/coef(x)[2]
    }

  break1.low <- getX(glm1.low, t1) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break1")  

  break1.mid <- getX(glm1.mid, t1) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "mid",
           breakID = "break1")
  
  break1.high <- getX(glm1.high, t1) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "high",
           breakID = "break1")
  
  break2.low <- getX(glm2.low, t2) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break2")  
  
  break2.mid <- getX(glm2.mid, t2) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "mid",
           breakID = "break2")
  
  break2.high <- getX(glm2.high, t2) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "high",
           breakID = "break2")
  
  # Join into data frame, convert elev.class2 to ordered factor, spread
  breaks <- full_join(break1.low, break1.mid) %>%
    full_join(break1.high) %>%
    full_join(break2.low) %>%
    full_join(break2.mid) %>%
    full_join(break2.high) %>%
    mutate(elev.class2 = factor(elev.class2, levels = c("high", "mid", "low"))) %>%
    spread(breakID, day)
  
  #
  out <- data %>%
    full_join(breaks) %>%
    gather(caste, count, -c(site, date, year, q.prop, r.prop,
                          gdd.cum, yday, elev.class, elev.class2, 
                          management, transect, elev.mean, 
                          lat, lon, break1, break2)) %>%
  group_by(site, date) %>%
  mutate(prop = count/sum(count))
}

# Find Juian breakpoints across all elevations
breakpoints_yday_all <- function(x, year, t1, t2) {
  
  data <- filter(x, year == !!year)
  
  # Logistic regression for first break point (founding to buildup)
  glm1 <- glm(q.prop ~ yday,
                  family = quasibinomial,
                  data = data)

  # Logistic regression for second break point (buildup to reproductive)
  glm2 <- glm(r.prop ~ yday,
                  family = quasibinomial,
                  data = data)
  
  ### Extract day corresponding to desired proportion; based on https://stackoverflow.com/questions/32040504/regression-logistic-in-r-finding-x-value-predictor-for-a-particular-y-value
  
  getX <- function(x, y) {
    (log(y/(1-y)) - coef(x)[1])/coef(x)[2]
    }

  break1 <- getX(glm1, t1) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break1") 
  
  break2 <- getX(glm2, t2) %>%
    data.frame() %>%
    select(day = 1) %>%
    mutate(elev.class2 = "low",
           breakID = "break2")  
  
  # Join into data frame, convert elev.class2 to ordered factor, spread
  breaks <- full_join(break1, break2) %>%
    spread(breakID, day)
  
  #
  out <- data %>%
    full_join(breaks) %>%
    gather(caste, count, -c(site, date, year, q.prop, r.prop,
                          gdd.cum, yday, elev.class, elev.class2, 
                          management, transect, elev.mean, 
                          lat, lon, break1, break2)) %>%
  group_by(site, date) %>%
  mutate(prop = count/sum(count))
}

# Binomial ggplot smoother
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "quasibinomial"), se = FALSE, ...)
}
```

**Introduction**

The nascent reality of climate change has already revealed the fragile contingency of ecological paradigms that rely on the implicit assumption of climatic stability [@Hannah2002-nv; @Walther2002-mq]. Thus, one of the central questions facing ecologists today is how climate change will affect the future fitness and distribution of species and, thereby, the composition and function of ecological communities. While it is intuitive that climate change should affect species and communities through environmental filtering, it is now recognized that climate change can also restructure biotic interactions [@Tylianakis2008-fi], such as competition and facilitation [@Ettinger2017-pk], altering the fitness landscape that governs community assembly and species coexistence [@Chesson2000-aw].  

Bumble bees (Hymenoptera: *Bombus* spp.), due to their well-studied natural history and amenability to field observation, have become a model system for the study of biotic interactions in ecological communities. In particular, the broad and overlapping distributions of bumble bee species, together with their gross similarity in morphology, behavior, and dietary niche, have attracted the attention of researchers interested in questions of interspecific competition and, more broadly, the ecological constraints of species coexistence [@Plowright1984-lc; @Goulson2008-zy]. In this regard, however, bumble bees have proven somewhat enigmatic [@Ranta1981-vx]. On the one hand, there is evidence that resource limitation, a necessary precondition for competition, can be a significant constraint on local bumble populations [@Heinrich1976-wc], even to the point of widespread colony failure due to starvation [@Bowers1985-df]. Moreover, the species of certain bumble bee communties have been shown to be over-dispersed in terms of tongue length (a matching trait corresponding to floral corolla depth) or phyologeny (understood to encompass unmeasured trait variation), providing evidence for competition as a community assembly process [e.g. @Inouye1977-kl; @Pellissier2013-pk]. Nevertheless, it is equally evident that sympatric bumble bee species do not *always* compete for floral resources to the point of competitive exclusion, since bumble bee communities with an apparent excess of species richness and deficit of trait (or phylogenetic) dispersion are commonly observed [@Goulson2008-zy]. 

To account for this inconsistency, @Ranta1981-vx proposed that bumble bees communities are governed by a spatiotemporally heterogeneous "mosaic" of competitive conditions, arising from the interaction of bumble bee species' traits and nest locations with spatiotemporal variation in floral resource abundance and composition, such that competitive inequalities between species are sufficiently variable (and fine-grained relative to the scale of observation) to allow more species to coexist than predicted by trait-based competition models. A complementary explanation, based on the core/satellite species hypothesis [@Hanski1982-hs], is that competitive forces are significant only among regionally abundant and widespread "core species", and the effects of competition are more pronounced in the structure of regional species pools than in that of local assemblages [@Hanski1982-xd]. 

As pointed out by @Williams1989-vr, however, the question of competition as a process of community assembly, relevant to evolutionary and biogeographic scales of inquiry, differs from that of competition as a behavioral phenomenon within a given community, irrespective of the forces responsible for its assembly.  

"This is not to deny that interspecific competition affects patterns of foraging by bumble bees, which has been demonstrated by the effect of competitor removal  (e.g. Inouye, 1978; Plowright, Pendrel & McLaren, 1978; Plowright & Rodd, 1980; Pleasants,  1981). It is  concluded only that interspecific competition does not appear to govern the composition of local  assemblages of bumble bee species in the manner predicted by  the  theory of species-packing." [@Williams1989-vr]

Bring up Hanksi's core/satellite hypothesis.
 

Steep elevation gradients can serve as space-for-time proxies in the study of climate effects, capturing a broad range of climate variation  while minimizing the confounding effects of geographic distance [e.g. @Hoiss2015-gv].

One of the most well-studied hypotheses linking climate and biotic interactions is the "stress gradient hypothesis", which posits a that the relative significance of competition and faciitation vary predictably along gradients of abiotic (e.g. climatic) stress, with low stress environments characterized by competition and high stress environments by facilitation [@Bertness1994-zx]. 


When phylogenetic/trait dispersion are used as indices of competition, the relevant question is whether competition played a role in community assembly. These indices do not answer the question of whether, right now, competition is happening. Trait-matching, niche overlap, specialization (e.g. d') based indices are better suited for the question of immediate competiion. It could be that competition was not important over the time scales relevant to community assembly, but now it has become a significant phenomenon due to some change in the system. Or, it is possible that competition is spatiotemporally transient, and its net effect is not sufficient to cause a trait or phylogenetic signal. 





Bumble bees (Hymenoptera: *Bombus* spp.) are classic model organisms for the study of resource competition in biological communities. Nevertheless, the role of resource competition in structuring bumble bee communities has proven difficult to generalize. Resource limitation, a precondition for competition, 

@Heinrich1976-wc found that a bumble bee community can deplete the daily standing nectar pool of a given locality by more than 90%, and starvation has been implicated in the demise of colonies in isolated subalpine meadows [@Bowers1985-df], in. Other studies have found local bumble bee communities to be over-dispersed in terms of tongue length [e.g. @Inouye1977-kl], a matching trait [sensu @Schleuning2020-vq] corresponding to floral corolla depth, and phylogeny [@Pellissier2013-pk], which can be interpreted as a catch-all for unmeasured trait variation. Nevertheless, it is equally evident that sympatric bumble bee species do not *always* compete for floral resources to the point of competitive exclusion, since bumble bee communities with an apparent excess of species richness and deficit of trait dispersion are commonly observed [@Goulson2008-zy]. 

To account for both the importance and variability of competitive processes in bumble bee communities, it is helpful to distinguish three processes that could obtain to varying degrees: no competition, interspecific competition, and intraspecific competition (**Table 1**). We will refer to these processes as hypotheses, since their realization in any given community is matter of inference. Below, we elaborate each and formulate corresponding empirical predictons.


+-------------------------------+----------------------------------------------------+
| Hypothesis                    | Prediction                                         |
+===============================+====================================================+
| H1: No competition            | 1. BB density !~ FL density                        |
|                               | 2. BB trait dispersion = null expectation          |
|                               | 3. BB-FL trait-matching > null expectation         |
+-------------------------------+----------------------------------------------------+
| H2: Interspecific competition | 1. BB density ~ FL density                         |
|                               | 2. BB trait dispersion > null expectation          |
|                               | 3. BB-FL trait-matching > null expectation         |
+-------------------------------+----------------------------------------------------+
| H3: Intraspecific competition | 1. BB density ~ FL density                         |
|                               | 2. BB diet breadth ~ BB conspecific-packing        |
|                               | 3. BB-FL trait-matching ~ 1/BB conspecific-packing |
+-------------------------------+----------------------------------------------------+ 

**Table 1:** Hypothesized competitive processes with empirical predictions. BB = bumble bee; FL = floral. \


*H1: No competition.*    The hypothesis that floral resource competition is not a significant process governing a bumble bee community functions as a "null hypothesis" when competition *per se* is the phenomenon in question, but it is not "null" in the sense of mere negation of mechanistic explanation. To the contrary, at least two plausible and ecologically meaningful mechanisms can be proposed that would account for a lack of competition in bumble bee communities [@Ranta1981-vx]. First, it is possible that a super-abundance of floral resources could saturate the foraging capacity of a local bumble bee population. Indeed, this may be a common (though transient) phenomenon associated with the bloom of mass flowering crops, such as red clover [@Ranta1981-vx] and oilseed rape [@Westphal2009-sb]. Alternatively, competition could be attenuated if abiotic stress, such as low temperature, suppresses bumble bee populations below competition-inducing densities. This pattern would be a prediction of the "stress-gradient hypothesis" [@Bertness1994-zx], and while it has not, to our knowledge, been documented for bumble bees specifically, a recent study of whole bee communities (of which bumble bees were a part) found evidence of dampened competition at high elevation sites along a montane-to-alpine gradient [@Hoiss2012-sn].

Under either mechanism, the most straightforward prediction is that bumble bee population density would be decoupled from resource density, since the latter would be non-limiting. For the same reason, the absence of competition would also predict that the trait dispersion of sympatric bumble bee species would not exceed that predicted by a random null model. Third, under a no-competition scenario, bumble bee species would suffer no displacement from their optimal floral resource species. Thus, holding other aspects of floral resource value constant (e.g. abundance, nectar volume/concentration), a lack of competition would predict that morphological trait-matching between bumble bee species and their chosen host flowers would exceed that predicted by a random null model.


*H2: Interspecific competition.*    Resource partitioning by bumble bees is mediated by variation in matching traits, the most well-studied of these being tongue length. Bumble bee tongue lengths vary between species, and the efficiency with which a bumble bee can collect nectar from a given flower depends largely on the closeness of match between the tongue length of the bee and the corolla depth of the flower [@Inouye1980-mv; @Ranta1980-ok]. Thus, under conditions of interspecific competition, a species' "defensible" niche space (i.e. the space in which it is a superior competitor) should center on the floral trait space that corresponds to its tongue length, and the number of species that can be "packed" into a given locality should be limited by some minimal differentiation of tongue length [@Inouye1977-kl; @Pyke1982-gn] within the range of variation supported by the trait space of available flora. 

Since resource limitation is a necessary condition for resource competition, a key prediction distiguishing interspecific competition from a lack of competition is that bumble bee density should vary in proportion to floral resource density. A bumble bee community under interspecific competition should also exhibit higher tongue length dispersion and stronger trait matching relative to the predictions of a random null model [@Inouye1977-kl]. 


*H3: Intraspecific competition.*    As noted by @Ranta1981-vx, theory predicts that intraspecific competition can promote species coexistence through the relief of interspecific competition [@MacArthur1984-qz], and could thus, as an alternative to the "no competition" hypothesis, account for cases in which the observed diversity of sympatric bumble bee species exceeds that predicted by trait-based niche models. Under the pressure of intraspecific competition, individuals face the depletion of preferred resources and may respond by foraging more opportunistically within the constraints of their fundamental niche space []. Alternatively, a population may relieve intraspecific competition by subdividing, on the basis of intraspecific trait heterogeneity, into differently specialized "guilds" [@Araujo2008-bp]. In either case, the population-level effect would be an increase in the species' realized niche breadth [though see @Parent2014-hx]. 

Thus, the predictions of intraspecific competition can be formulated as follows. First, as in interspecific competition, resources must be limiting, so bumble bee density should vary in proportion to floral density. In the case of intraspecific competition, though, we can refine this prediction to say that the density of a given bumble bee species should vary in proportion to the density of the portion of the floral resource community belonging to its dietary niche, since the effects of intraspecific competition are realized on a per-species basis. Second, the dietary breadth of a given species should vary in proportion to the density of conspecifics per density of floral resources (we will refer to this as a "conspecific-packing" index). Conversely, a broadening of diet should entail a relaxation of trait-matching, so the strength of trait-matching should vary inversely with conspecific-packing.


*Seasonal-Elevational metahypothesis.*    That any of the processes hypothesized above should obtain universally is both empirically and theoretically doubtful [@Ranta1981-vx]. More plausibly, which of these processes prevails -- and which species are favored by the prevailing process -- vary in both space and time, and this heterogenity of process could explain the structural idiosyncrasies of observed bumble bee communities [@Ranta1981-vx]. Rather than viewing this heterogeneity as an obstacle to inferring some universal rule of bumble bee community assembly, our aim in the present study is to investigate the heterogeneity itself as an ecological phenomenon, characterizing the variation in competitive processes (or lack thereof) in bumble bee communities through time and space. 

Our study is set in the Berchtesgadener Alps of southwestern Germany, where a steep elevation gradient permits the study of wide environmental variability while minimizing the confounding effects of geographical distance [e.g. @Hoiss2015-gv]. In this context, we formulate a "metahypothesis" concerning the variation of hypothesized competition processes through elevation and time (**Figure 1**). Consistent with the stress-gradient hypothesis [@Bertness1994-zx] and with previous empirical work in our study system [@Hoiss2012-sn], we hypothesize an inverse relationship between competition and elevation. Along a temporal axis, we hypothesize that the strength of competition is structured by the seasonal life history pattern of bumble bee colonies [@Goulson2010-lo]. During the solitary phase, when the bumble bee community consists only of foundress queens, competition should be low. Both inter- and intraspecific competition should intensify as colonies increase in size during the social phase. After the switch point, when colonies begin producing gynes and males instead of workers, intraspecific comeptition should decrease due to the strong morphological differences between queens, males, and workers within each species, but interspecific competition might intensify due to the effective "over-packing" of trait space wih the introduction of multiple morphological castes per species. 

In addition to clarifying the basic ecology of bumble bee community assembly, parsing competitive processes in this way has an applied significance for the conservation of bumble bees in the changing environments of the Anthropocene. Under the forcing of environmental change, such as climate warming or land use conversion, bumble bee communities might not be affected only in terms of range shifts, but also by a restructuring of competitive interactions, the nature and consequences of which may be difficult to predict.


```{r echo = FALSE, figu}
Time <- c(0,1,2,3)
Elevation <- c(0,1,2,3)
tab <- cbind(Time, Elevation) %>%
  as_tibble()

ggplot(tab, aes(Time, Elevation)) +
  geom_vline(xintercept = c(1,2), color = "white") +
  geom_hline(yintercept = c(1,2), color = "white") +
  scale_x_continuous(expand = c(0,0),
                     breaks = c(0.5, 1.5, 2.5), 
                     labels = c("founding", "build-up", "reproductive"),
                     limits = c(0,3)) +
  scale_y_continuous(expand = c(0,0),
                     breaks = c(0.5, 1.5, 2.5), 
                     labels = c("low", "mid", "high"),
                     limits = c(0,3)) +
  #geom_text() +
  annotate("text", x = 0.5, y = 2.5, label = "H1") +
  annotate("text", x = 1.5, y = 2.5, label = "H1") +
  annotate("text", x = 2.5, y = 2.5, label = "H1") +
  annotate("text", x = 0.5, y = 1.5, label = "H1") +
  annotate("text", x = 0.5, y = 0.5, label = "H1") +
  annotate("text", x = 1.5, y = 1.5, label = "H2 | H3") +
  annotate("text", x = 2.5, y = 1.5, label = "H2 < H3") +
  annotate("text", x = 1.5, y = 0.5, label = "H2 | H3") +
  annotate("text", x = 2.5, y = 0.5, label = "H2 < H3") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

**Figure 1:** Hypothesized variation in prevailing competitive processes through time and elevation. \

**Methods**\

<!-- - Look for divergent population trajectories of species as evidence of competition with temporal lag on effects -->
<!-- - Where does network analysis fit in? A legit question -- no need to jump right to fancy network metrics if simpler approaches work. But so far, none of my empirical predictions involve network metrics.  -->


*Field sampling*

*Degree day modeling.*


*Inferring reosurce limitation*

**Results**\

*Colony phase*
```{r}
### Get caste counts
castes <- read_csv("./processed_data/network.csv") %>%
  group_by(site, date, year, caste) %>%
  summarize(caste.count = n()) %>%
  spread(caste, caste.count) %>%
  replace(is.na(.), 0) %>%
  mutate(queen = oldqueen + queen,
         reproductive = male + youngqueen,
         q.prop = queen/(queen+worker+reproductive),
         r.prop = reproductive/(queen+worker+reproductive)) %>%
  select(-oldqueen, -youngqueen, -male) %>%
  left_join(gdd, by = c("site", "date")) %>%
  left_join(site_data, by = c("site")) %>%
  arrange(gdd.cum) %>%
  mutate(yday = yday(date))

breaks_2012_gdd <- breakpoints_gdd(castes, 2012, t1 = 0.5, t2 = 0.1)
breaks_2011_gdd <- breakpoints_gdd(castes, 2011, t1 = 0.5, t2 = 0.1)
breaks_2010_gdd <- breakpoints_gdd(castes, 2010, t1 = 0.5, t2 = 0.1)

breaks_2012_yday <- breakpoints_yday(castes, 2012, t1 = 0.5, t2 = 0.1)
breaks_2011_yday <- breakpoints_yday(castes, 2011, t1 = 0.5, t2 = 0.1)
breaks_2010_yday <- breakpoints_yday(castes, 2010, t1 = 0.5, t2 = 0.1)

breaks_2012_yday_all <- breakpoints_yday_all(castes, 2012, t1 = 0.5, t2 = 0.1)
breaks_2011_yday_all <- breakpoints_yday_all(castes, 2011, t1 = 0.5, t2 = 0.1)
breaks_2010_yday_all <- breakpoints_yday_all(castes, 2010, t1 = 0.5, t2 = 0.1)

# Plot
facet_names <- c(`low` = "Low (641-1000 m)",
                 `mid` = "Mid (1000-1499 m)",
                 `high` = "High (1500-2032 m)")

ggplot(breaks_2012_gdd, aes(gdd.cum, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2012_gdd.pdf")

ggplot(breaks_2012_yday, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Julian day") +
  ylab("Proportional abundance")

ggsave("./output/phases2012_yday.pdf")


ggplot(breaks_2011_gdd, aes(gdd.cum, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2011_gdd.pdf")

ggplot(breaks_2011_yday, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2011_yday.pdf")

ggplot(breaks_2010_gdd, aes(gdd.cum, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2010_gdd.pdf")

ggplot(breaks_2010_yday, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  facet_wrap(~elev.class2, ncol = 1, labeller = as_labeller(facet_names)) +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2010_yday.pdf")

ggplot(breaks_2012_yday_all, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2012_yday_all.pdf")

ggplot(breaks_2011_yday_all, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2011_yday_all.pdf")

ggplot(breaks_2010_yday_all, aes(yday, prop, color = caste)) +
  geom_point() +
  binomial_smooth(formula = y ~ splines::ns(x, 2)) +
  geom_vline(aes(xintercept = break1), linetype = "dashed") +
  geom_vline(aes(xintercept = break2), linetype = "dashed") +
  xlab("Cumulative growing degree days") +
  ylab("Proportional abundance")

ggsave("./output/phases2010_yday_all.pdf")
```

*Resource limitation*.   Per-transect bumble bee abundance is positively correlated with per-transect floral cover (log-transformed). To the extent, therefore, that our metrics of bumble bee and floral density reflect true site-scale abundance and not just co-aggregation, this pattern suggests that bumble bee
density is resource limited, particularly at sites with very low floral density. Importantly, this approach does not distinguish between inter- and intraspecies (or even intra-colony) competition [@Ranta1981-vx].

Note, moreover, that this relationship varies seasonally. For now, we will use Julian month as a stand-in for GDD, which we'll use once we have analyzed our weather station data. Early in the year, the relationship between BB density and floral density is weak; this makes sense because colonies are just getting established during the first couple of months, and BB density is more limited by the autocorrelation component of colony size (bigger colonies can raise more brood) than by floral resource availability. In mid- to late-season, however, BB density becomes strongly dependent on floral resource density. Interestingly, in September, the relationship is strongest and floral density is also lowest.

```{r eval=FALSE, echo=FALSE}
ggplot(density_month.agg, aes(log.mean.fl.dens, mean.bb.dens, color = year)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_wrap(~month) +
  ylab("Mean BB density") +
  xlab("log(Mean floral density)")
```


**Discussion**\




<!-- *Study sites.*  -->

<!-- *Field sampling.*  -->

<!-- *Data analysis.*  -->
<!-- \ -->


<!-- **Results** -->


<!-- So, we have at least circumstantial evidence that bumble bee density is limited by floral density (again, the key assumption is that our -->
<!-- metrics of bumble bee and floral density reflect true site-scale abundance). What we might as next is whether the degree of dependence of bumble bee density upon floral density vary with elevation. It's hard to draw conclusions about the lowest elevation class, but it seems pretty clear that the slope of bumble bee density on floral density is steep at the highest elevation class than at the middle elevation class; moreover, the relationship is tighter (lower variance) at high elevation. It appears that, contrary to the predictions of the Ranta hypothesis, bumble bees are more dependent on floral resource availability at higher elevations. -->

```{r eval=FALSE, echo=FALSE}
ggplot(density_month.agg, aes(log.mean.fl.dens, mean.bb.dens)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_grid(elev.class ~ month) +
  ylab("Mean BB density") +
  xlab("log(Mean floral density)")
```

<!-- But let's look at this another way. By dividing bumble bee density by floral density, we can derive an index that represents "bees per unit of floral abundance" (which we willlog-transform for this analysis to correct for skewed distribution). We'll call this our "bee-packing" index, and we'll understand it as an estimate of predicted competition intensity. When we plot this against elevation, parsed by year, we see that "bee-packing" seems to increase at high elevation for 2011, and possibly also in 2010. But the relationship seems to disappear in 2012. This is worth thinking about. 2012 was a year of very low floral density. Perhaps this increased resource limitation across the whole elevation gradient, erasing the effect of elevation. -->
```{r eval=FALSE, echo = FALSE}
ggplot(density_month.agg, aes(elev.mean, log(bb.per.fl))) +
  geom_point() +
  geom_smooth(se = TRUE) +
  facet_wrap(~year) +
  ylab("log(bee-packing)") +
  xlab("Elevation") 
```

<!-- Some pretty neat patterns emerge when we break our data down by month. For most months, bee-packing increases with elevation, though sometimes the relationship is fairly flat. In Septmeber, however, bee-packing decreases with elevation, presumably due to the elevational staggering of phenology; by that point in the year, only the colder sites still have appreciable floral density. -->
```{r eval=FALSE, echo=FALSE}
ggplot(density_month.agg, aes(elev.mean, log(bb.per.fl))) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  facet_grid(year~month, scales = "free") +
  ylab("log(bee-packing)") +
  xlab("Elevation") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

<!-- Another way to probe the question of competition is to examine network structure, though we will have to sacrifice our temporal resolution to do so. An advantage of this analysis is that we will no longer rely on the estimate of floral density using our survey data, so we can shed the somewhat vulnerable assumption that the correlation between bumble bee density and floral density is not due merely to co-aggregation. To do this, we will focus on the group-level metrics of niche overlap and C-score. Niche overlap would be expected to vary inversely with competition, while C-score -- a measure of ... -- would be expected to vary directly with competition. For this analysis to be sound, though, we need to rarefy our networks. Otherwise, niche overlap and C-score could be driven by uneven sampling effort (less intensively sampled sites will appear to have lower niche overlap and higher C-score). -->
```{r eval=FALSE, echo = FALSE}
### Inspect the evenness (or lack thereof) of sampling intensity
net_balance <- net %>%
  group_by(year, elev.mean, elev.class) %>%
  summarize(observations = n(),
            transects = length(unique(date)))

ggplot(net_balance, aes(elev.mean, transects)) +
  geom_point() +
  facet_wrap(~year, scales = "free")
```

<!-- A tedious manual rarefaction -->
```{r eval=FALSE, echo = FALSE}
### Determine the minimum transect count per site*year to set rarefaction sampling
transects <- net %>%
  select(site, year,date) %>%
  unique()

transects_per_siteyear <- transects %>%
  group_by(site, year) %>%
  summarize(transects = n())

min_transects_per_year <- transects_per_siteyear %>%
  group_by(year) %>%
  summarize(min_transects = min(transects))


### Create rare_net function
rare_net <- function(net, n, iter) {
  
  out <- data.frame()
  
  for(i in 1:iter) {
    temp <- net %>%
      select(site, date) %>%
      unique() %>%
      group_by(site) %>%
      sample_n(n) %>%
      left_join(net) %>%
      group_by(site, bb.sp, plant.sp) %>% # group by site, date, bee species, plant species
      summarize(freq = n()) %>% # calculate interaction frequency per species pair within each site
      dplyr::select(higher = bb.sp, lower = plant.sp, webID = site, freq) %>% # rename columns to match bipartite's expectations
      data.frame() %>% # convert to data frame
      frame2webs() %>% # convert to to bipartite web
      map(grouplevel, weighted = TRUE) %>% # We probably care mainly about the BB level of the network
      data.frame() %>%
      t() %>%
      data.frame() %>%
      rownames_to_column() %>%
      dplyr::select(site = rowname, everything()) %>%
      as_tibble() %>%
      mutate(iteration = rep(i, n())) %>%
      left_join(site_data)
    
    out <- bind_rows(out, temp)
  } 
  return(as_tibble(out))
}


### Create yearly subsets to feed to rare_net
net_2012 <- filter(net, year == "2012")
net_2011 <- filter(net, year == "2011")
net_2010 <- filter(net, year == "2010")

#### Create rarified networks and tabulate grouplevel metrics
groupmet_rare_2012 <- rare_net(net_2012, n = 9, iter = 10)
groupmet_rare_2011 <- rare_net(net_2011, n = 4, iter = 10)
groupmet_rare_2010 <- rare_net(net_2010, n = 3, iter = 10)


### Plot
ggplot(groupmet_rare_2012, aes(elev.mean, niche.overlap.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)

ggplot(groupmet_rare_2011, aes(elev.mean, niche.overlap.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)

ggplot(groupmet_rare_2010, aes(elev.mean, niche.overlap.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)


ggplot(groupmet_rare_2012, aes(elev.mean, C.score.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)

ggplot(groupmet_rare_2011, aes(elev.mean, C.score.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)

ggplot(groupmet_rare_2010, aes(elev.mean, C.score.HL)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~iteration)
```


<!-- **Discussion** -->

<!-- -  Ingolf said that he does not think that competition from syrphids at high elevation would be significant, but competition from honey bees at low elevation could be -->

<!-- Bumble bee communities are structured by a spatiotemporal mosaic of competitive -->
<!--   processes -->

<!-- The two processes of environmental filtering and biotic interactions may be difficult to disentangle [@Kraft2015-gh].  -->


<!-- The nascent reality of climate change, and the grave expectation of its progression in the coming decades, have revealed the fragile contingency of conservation paradigms that rely on the implicit assumption of climatic stability [@Hannah2002-nv]. -->

<!-- Under conditions of resource limitation, intraspecific competition may be a stronger constraint on bumble bee density (though not on diversity) than interspecific competition, since conspecific are limited in their ability to partition further their potential niche space. -->

<!-- "Altitudinal niche-breadth hypothesis" [@Rasmann2014-zb]: Analogous to the latitudinal niche-breadth hypothesis, organisms at high elevations tend to have broader niches due to higher environmental variability, and possibly other reasons. Interestingly, @Rasmann2014-zb do not invoke the concept of competition release as a reason for increased niche breadth at higher elevations. -->

<!-- It is important to clarify what we are and are not sampling. We are not sampling bumble bee communities; we are sampling spatial (and temporal) subsets of the floral resource landscape. So, the questions we are able to answer concern not the composition of the community as such, however one chooses to delimit it, but rather the composition of foragers within an arbitrarily delimited (but standardized) segment of the resource landscape (i.e. the sampling plot). -->

<!-- Importantly, though, competition need not be universal, or even frequent, to be a powerful driver of community assembly [@MacArthur1984-qz]. -->

<!-- Moreover, trait matching under interspecific competition might also exceed that predicted under no competition, since interspecific competition would limit a species' ability to "adaptively mismatch" to exploit a rich but poorly matched resource, since the resource would likely be monopolized by a better-matched (and therefore more competitive) species. -->

<!-- Am I right in thinking that it is impossible to have interspecific competition without also having intraspecific competition? These processes would have opposite effects on niche breadth. By itself, interspecific competition would favor the maximal contraction of niche breadth until no overlap remained. But intraspecific competition would have the opposite effect, forcing conspecifics to broaden their niches to minimize competition with one another. Presumably, observed niche breadth and niche overlap represent a dynamic equilibrium of these opposing forces. -->


**References**

