---
title: "Abundance/diversity GAM"
output: html_document
---

# 1. Prep work
## 1.1 Prepare environment
```{r setup, include=FALSE, echo=FALSE}
library(mgcv)
library(mgcViz)
library(tidymv)
library(vegan)
library(ggvegan)
library(ggrepel)
library(tidyverse)
library(lubridate)
```

## 1.2 Load site and trait data
```{r, include=FALSE, echo=FALSE}
site_data <- read_csv("../data/processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean)) %>% # drop these variables
  mutate(elev.class2 = factor(elev.class2, levels = c("low", "mid", "high")),
         site = factor(site),
         tree_line = factor(tree_line)) # turn elev.class into an ordered factor and site into a regular factor

# BB traits
bb_traits <- read_csv("../data/processed_data/bb_traits.csv") 

# FL traits
## family-level taxonomy
fl_tax <- read_csv("../data/processed_data/floral_tax.csv") 

## Kugler morphotypes (accessed through Bioflor)
fl_ktype <- read_csv("../data/processed_data/floral_k_type.csv") 

## Flower colors (accessed through BioFlor)
fl_color <- read_csv("../data/processed_data/floral_color.csv")

## diameter and corolla depth data from Gita Benadi
fl_morph <- read_csv("../data/processed_data/flower_morphology_GitaBenadi.csv") %>% 
  dplyr::select(SampleID, plant.family = Family, plant.sp = Species, 
                Unit, Flowers_per_unit, diam = Diameter, LN) %>%
  group_by(plant.sp) %>%
  summarize(diam = mean(diam), LN = mean(LN))

## verbal description of Kugler morphotypes
fl_ktype_key <- read_delim("../data/processed_data/kugler_key.tsv", delim = "\t", col_names = FALSE) %>%
  dplyr::select(k.type = 1, description = 2)

## join all floral trait tables
fl_traits <- fl_tax %>%
  full_join(fl_ktype) %>%
  full_join(fl_color) %>%
  full_join(fl_morph) %>%
  dplyr::select(plant.sp, plant.genus, plant.family, k.type, k.type.s, k.type.ss, color, diam, LN)
```

## 1.3 Load network and survey data
```{r message=FALSE}
### BB-FL visitation data
net <- read_csv("../data/processed_data/network.csv") %>%
  filter(caste != "male",
         !bb.sp %in% c("humi", "hypn")) %>% # too rare
  dplyr::select(site, date, bb.sp, plant.sp) # drop unused columns

### Floral survey data
survey <- read_csv("../data/processed_data/floral_survey.csv") %>%
  semi_join(net, by = "plant.sp") %>% # Consider only visited plant species (anytime anywhere, not specifically for a given site*date)
  dplyr::select(site, date, plant.sp, flower.cover) %>%
  group_by(plant.sp) %>%
  mutate(present = case_when(
    max(flower.cover) > 0 ~ TRUE,
    max(flower.cover) == 0 ~ FALSE
  )) %>%
  filter(present == TRUE) # Ignore plants that never had any flower cover

vis_sp <- net %>%
  left_join(fl_tax) %>%
  select(plant.sp, plant.genus, plant.family) %>%
  unique()

surv_sp <- survey %>%
  left_join(fl_tax) %>%
  select(plant.sp, plant.genus, plant.family) %>%
  unique()

missing <- anti_join(vis_sp, surv_sp)
```

## 1.4 Calculate FL and BB abundance / diversity
```{r echo=FALSE, include=TRUE, message=FALSE}
# Per-transect BB abundance
## full dataset
bb_abund_sp <- net %>%
  dplyr::select(site, date, bb.sp) %>%
  group_by(site, date, bb.sp) %>% # 
  summarize(bb.abund = n()) %>% # get per transect bb abundance
  ungroup() %>%
  complete(site, date, bb.sp, fill = list(bb.abund = 0)) %>% # complete implicit absences
  semi_join(net, by = c("site", "date")) %>% # drop site-dates that did not exist in the data set
  left_join(site_data) %>% # add site data
  mutate(year = factor(year(date)),
         yday = yday(date),
         bb.sp = factor(bb.sp),
         management = factor(management),
         site = factor(site),
         transect = factor(transect)) %>%
  left_join(bb_traits) %>%
  mutate(tongue = factor(pbl.w.class2))

### Per-transect floral abund by species
fl_abund_sp <- survey %>%
  group_by(site, date, plant.sp) %>% # group by plant.sp*transect
  summarize(fl.abund = sum(flower.cover)) %>% # get plant.sp*transect total flower cover; this step really shouldn't be required, but in a few cases, there is more than one abundance entry for the same species on a given transect; not sure how that happened, but it's in the original data that Fabrice sent me; alternatively, I could drop the dups or average them. We'll see what Kalli and Fabrice have to say.
  group_by(site, date) %>%
  mutate(prop.fl.abund = fl.abund/sum(fl.abund)) %>% # get the proportional flower cover for each species.
  ungroup() %>%
  #full_join(dplyr::select(net, site, date, plant.sp), by = c("site", "date", "plant.sp")) %>% # add the handful of species occurring in the visitation network but missing from the survey data
  complete(site, date, plant.sp, fill = list(fl.abund = 0, prop.fl.abund = 0)) %>%
  semi_join(survey, by = c("site", "date")) %>%  # only include site-dates that actually occurred
  unique() %>%
  mutate(year = factor(year(date))) %>%
  left_join(fl_traits)
```

## 1.5 Calculate binary "preference" for each plant genus by each bumble bee species; score species 0 or 1 based on whether they were visited
```{r message=FALSE}
weights <- fl_abund_sp %>%
  select(plant.sp, plant.genus) %>%
  unique() %>%
  left_join(select(net, bb.sp, plant.sp)) %>%
  select(plant.genus, bb.sp) %>%
  distinct() %>%
  mutate(visited = rep(1, n())) %>%
  pivot_wider(values_from = visited, names_from = bb.sp, values_fill = 0) %>%
  pivot_longer(cols = 2:15, values_to = "visited", names_to = "bb.sp")
  
weighted_fl_abund <- fl_abund_sp %>%
  group_by(site, date, plant.genus) %>%
  summarize(flower.cover = sum(fl.abund)) %>%
  left_join(weights) %>%
  mutate(weighted.flower.cover = flower.cover*visited) %>%
  group_by(site, date, bb.sp) %>%
  summarize(total.weighted.flower.cover = sum(weighted.flower.cover)) %>%
  left_join(site_data) %>%
  select(site, date, elev.mean, bb.sp, total.weighted.flower.cover) %>%
  mutate(yday = yday(date),
         bb.sp = factor(bb.sp),
         site = factor(site),
         year = factor(year(date)))
```

# 2. Analyses

## 2.1 BB elevation distribution
```{r}
bb_range <- net %>%
  left_join(site_data) %>%
  group_by(site, date, elev.mean, tree_line, bb.sp) %>%
  summarize(abund = n()) %>%
  group_by(site, elev.mean, tree_line, bb.sp) %>%
  summarize(abund = max(abund)) %>%
  filter(abund > 0) %>%
  group_by(bb.sp) %>%
  mutate(elev.floor = min(elev.mean),
         elev.ceiling = max(elev.mean),
         elev.range = elev.ceiling - elev.floor,
         elev.med = elev.floor + ((elev.ceiling - elev.floor)/2))

ggplot(bb_range, aes(reorder(bb.sp, elev.med), elev.mean)) +
  geom_line(size = 2, alpha = 0.25) +
  geom_point(aes(size = abund, color = tree_line), alpha = 0.5) +
  theme_light(14) +
  scale_size_continuous(name = "Peak abundance",
                        breaks = c(1, 10, 20, 40, 80)) +
  scale_color_discrete(name = "Tree line") +
  xlab("Bumble bee species") +
  ylab("Elevation (m)") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("../output/bb_range_ms1.pdf")
ggsave("../output/bb_range_ms1.png")

# What happens if I plot max abundance by elevation?

bb_range2 <- net %>%
  left_join(site_data) %>%
  group_by(site, date, elev.mean, tree_line, bb.sp) %>%
  summarize(abund = n()) %>%
  group_by(site, elev.mean, tree_line, bb.sp) %>%
  summarize(abund = max(abund)) 

ggplot(filter(bb_range2, bb.sp != "humi"), aes(elev.mean, abund)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 6)) +
  facet_wrap(~bb.sp, scales = "free_y", ncol = 4) +
  geom_vline(xintercept = 1500, color = "red", linetype = "dashed")
```

## 2.2. Aggregate analysis of max BB abundance and mean FL abundance  ~ elevation

### 2.2.1 Calculate max and mean abundances within site and year
```{r}
# Get mean total weighted floral abundance by BB sp
weighted_fl_abund_mean <- weighted_fl_abund %>%
  group_by(site, bb.sp, year) %>%
  summarize(mean.fl.abund = mean(total.weighted.flower.cover),
            max.fl.abund = max(total.weighted.flower.cover)) %>%
  left_join(site_data)

# Get max BB abundance by sp
bb_abund_sp_max <- bb_abund_sp %>%
  group_by(site, elev.mean, year, bb.sp) %>%
  summarize(max.bb.abund = max(bb.abund),
            mean.bb.abund = mean(bb.abund))

# Join
abund_sum <- full_join(weighted_fl_abund_mean, bb_abund_sp_max) %>%  
  unite(sp.year, c(bb.sp, year), remove = FALSE) %>%
  mutate(site = factor(site),
         bb.sp = factor(bb.sp),
         sp.year = factor(sp.year)) 
```

### 2.2.2 Preliminary visualizations
```{r}
## mean floral abundance
ggplot(abund_sum, aes(elev.mean, mean.fl.abund, color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8), se = FALSE) +
  facet_wrap(~bb.sp, scales = "free_y") +
  geom_vline(xintercept = 1500)

## log(mean floral abundance)
ggplot(abund_sum, aes(elev.mean, log(mean.fl.abund), color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8), se = FALSE) +
  facet_wrap(~bb.sp) +
  geom_vline(xintercept = 1500)

## Max floral abundance)
ggplot(abund_sum, aes(elev.mean, max.fl.abund, color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8), se = FALSE) +
  facet_wrap(~bb.sp) +
  geom_vline(xintercept = 1500)

## Max BB abundance
ggplot(abund_sum, aes(elev.mean, max.bb.abund, color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8),  se = FALSE) +
  facet_wrap(~bb.sp, scales = "free_y") +
  geom_vline(xintercept = 1500)

## Max  abundance ~ mean BB abundance, to see how interchangeable they are.
## They are almost perfectly correlated, and I think max abund is more informative
ggplot(abund_sum, aes(mean.bb.abund, max.bb.abund, color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8),  se = FALSE) +
  facet_wrap(~bb.sp, scales = "free_y") 

## Are max FL and mean FL similarly interchangeable? Yes.
ggplot(abund_sum, aes(mean.fl.abund, max.fl.abund, color = year)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8),  se = FALSE) +
  facet_wrap(~bb.sp, scales = "free_y") 

## Max BB abundance ~ mean FL abundance
ggplot(abund_sum, aes(log(mean.fl.abund), max.bb.abund)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8),  se = FALSE) +
  facet_wrap(~bb.sp, scales = "free_y")
```

### 2.2.3 Abundance models
#### 2.2.3.1 Bumble bees
```{r}
gam_max_bb_abund_00 <- gam(max.bb.abund ~ 
                             year +
                             s(bb.sp, bs = "re") +
                             s(elev.mean, by = bb.sp, k = 8),
                           method = "REML",
                           family = "nb",
                           select = TRUE,
                           data = abund_sum) %>% getViz()

check.gamViz(gam_max_bb_abund_00)
summary(gam_max_bb_abund_00)
print(plot(gam_max_bb_abund_00, allTerms = TRUE), pages = 1)

gam_max_bb_abund_00_pred <- predict.gam(gam_max_bb_abund_00, type = "terms", se.fit = TRUE) %>%
  as.data.frame() %>%
  as_tibble() %>%
  select(sm.year = 1, sm.bb.sp = 2, gers = 3, hort = 4, jone = 5, lapi = 6, mend  = 7,
         mont = 8, muci = 9, pasc = 10, prat = 11, psit = 12, pyre = 13, soro = 14,
         telu = 15, wurf = 16,
         se.year = 17, se.bb.sp = 18, gers.se = 19, hort.se = 20, jone.se = 21, lapi.se = 22, mend.se  = 23,
         mont.se = 24, muci.se = 25, pasc.se = 26, prat.se = 27, psit.se = 28, pyre.se = 29, soro.se = 30,
         telu.se = 31, wurf.se = 32) %>%
  mutate(fit = sm.year + sm.bb.sp + gers + hort + jone + lapi + 
           mend + mont + muci + pasc + prat + psit + pyre + 
           soro + telu + wurf) %>%
  mutate(se = se.year + se.bb.sp + gers.se + hort.se + jone.se + lapi.se + mend.se + mont.se + 
           muci.se + pasc.se + prat.se + psit.se + pyre.se + soro.se + telu.se + wurf.se) %>%
  select(fit, se) %>%
  mutate(fit.plus = fit + se,
         fit.min = fit - se,
         fit.trans = exp(fit),
         fit.plus.trans = exp(fit.plus),
         fit.min.trans = exp(fit.min)) %>%
  bind_cols(abund_sum)
  
ggplot(gam_max_bb_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
  geom_ribbon(aes(elev.mean, fit.trans, 
                  ymax = fit.plus.trans, ymin = fit.min.trans,
                  fill = year), alpha = 0.2, inherit.aes = FALSE) +
  geom_line() +
  facet_wrap(~bb.sp, scales = "free_y") +
  geom_vline(xintercept = 1500, linetype = "dashed") +
  theme_light()
```

#### 2.2.3.2 Floral resources
```{r}
# There are lots of ways this could be specified. From looking at the data and the models, it seems like BB species-level variation in floral resources is very low, and there is a strong global effect of elevation. I think the global model has the strongest message, namely the collapse of overall floral resource availability above the tree line. I can all report the species-level predictions, though.
gam_max_fl_abund_00 <- gam(log(mean.fl.abund) ~ 
                             s(elev.mean, year, bs = "fs", k = 8) +
                             s(elev.mean, bb.sp, bs = "fs", k = 8),
                           method = "REML",
                           family = "gaussian",
                           select = TRUE,
                           data = abund_sum) %>% getViz()

check.gamViz(gam_max_fl_abund_00)
summary(gam_max_fl_abund_00)
concurvity(gam_max_fl_abund_00)
print(plot(gam_max_fl_abund_00, allTerms = TRUE), pages = 1)
plot(gam_max_fl_abund_00)

gam_max_fl_abund_00_pred <- predict.gam(gam_max_fl_abund_00, type = "terms", se.fit = TRUE) %>%
  as.data.frame() %>%
  as_tibble() %>%
  select(sm.year = 1, sm.bb.sp = 2,
         se.year = 3, se.bb.sp = 4) %>%
  mutate(fit = sm.year) %>%
  mutate(se = se.year) %>%
  select(fit, se) %>%
  mutate(fit.plus = fit + se,
         fit.min = fit - se,
         fit.trans = exp(fit),
         fit.plus.trans = exp(fit.plus),
         fit.min.trans = exp(fit.min)) %>%
  bind_cols(na.omit(abund_sum)) %>% # the na.omit() drops the rows where floral surveying data were missing
  select(fit.trans, fit.plus.trans, fit.min.trans, se, elev.mean, year) %>%
  distinct()

ggplot(gam_max_fl_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
  geom_ribbon(aes(elev.mean, fit.trans, 
                  ymax = fit.plus.trans, ymin = fit.min.trans,
                  fill = year), alpha = 0.2, inherit.aes = FALSE) +
  geom_line() +
  #geom_point(aes(elev.mean, mean.fl.abund, color = year), inherit.aes = FALSE, alpha = 0.25) +
  geom_vline(xintercept = 1500, linetype = "dashed") +
  theme_light()

# Alternatively, since it seems like species basically has just an intercept effect
gam_max_fl_abund_01 <- gam(log(mean.fl.abund) ~ 
                             s(bb.sp, bs = "re") +
                             s(elev.mean, year, bs = "fs", k = 8),
                           method = "REML",
                           family = "gaussian",
                           select = TRUE,
                           data = abund_sum) %>% getViz()

check.gamViz(gam_max_fl_abund_01)
summary(gam_max_fl_abund_01)
concurvity(gam_max_fl_abund_01)
print(plot(gam_max_fl_abund_01, allTerms = TRUE), pages = 1)
plot(gam_max_fl_abund_01)

gam_max_fl_abund_01_pred <- predict.gam(gam_max_fl_abund_00, type = "terms", se.fit = TRUE) %>%
  as.data.frame() %>%
  as_tibble() %>%
  select(sm.year = 1, sm.bb.sp = 2,
         se.year = 3, se.bb.sp = 4) %>%
  mutate(fit = sm.year) %>%
  mutate(se = se.year) %>%
  select(fit, se) %>%
  mutate(fit.plus = fit + se,
         fit.min = fit - se,
         fit.trans = exp(fit),
         fit.plus.trans = exp(fit.plus),
         fit.min.trans = exp(fit.min)) %>%
  bind_cols(na.omit(abund_sum)) %>% # the na.omit() drops the rows where floral surveying data were missing
  select(fit.trans, fit.plus.trans, fit.min.trans, se, elev.mean, year) %>%
  distinct()

ggplot(gam_max_fl_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
  geom_ribbon(aes(elev.mean, fit.trans, 
                  ymax = fit.plus.trans, ymin = fit.min.trans,
                  fill = year), alpha = 0.2, inherit.aes = FALSE) +
  geom_line() +
  #geom_point(aes(elev.mean, mean.fl.abund, color = year), inherit.aes = FALSE, alpha = 0.25) +
  geom_vline(xintercept = 1500, linetype = "dashed") +
  theme_light()
```

## 2.3 Elevation x time analysis

### 2.3.1 Floral abundance
```{r message=FALSE, warning=FALSE}
# First, let's model overall floral abundance without parsing it out by which species were visited by which bumble bee species
fl_abund_pool <- fl_abund_sp %>%
  group_by(site, date, year) %>%
  summarize(fl.abund = sum(fl.abund)) %>%
  mutate(site = factor(site),
         yday = yday(date)) %>%
  left_join(site_data)

ggplot(fl_abund_pool, aes(fl.abund)) +
  geom_histogram()
  
fl_abund.qp <- bam(fl.abund ~ 
                      s(site, bs = "re") +
                      s(year, bs = "re") +
                      te(yday, elev.mean,
                         bs = c("gp", "tp"),
                         k = c(8, 8)),
                    data = fl_abund_pool,
                    family = "quasipoisson",
                    discrete = TRUE,
                    select = TRUE,
                    method = "fREML") %>% getViz()

check.gamViz(fl_abund.qp)
summary(fl_abund.qp)
plot(fl_abund.qp)


# Now, by bumble bee species
weighted_fl_abund.qp <- bam(total.weighted.flower.cover ~ 
                              s(bb.sp, bs = "re") +
                              s(site, bs = "re") +
                              s(year, bs = "re") +
                              te(yday, elev.mean,
                                 by = bb.sp,
                                 bs = c("gp", "tp"),
                                 k = c(5, 5)),
                            data = filter(weighted_fl_abund, bb.sp != "humi"),
                            family = "quasipoisson",
                            discrete = TRUE,
                            select = TRUE,
                            method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abund.qp)
sum_fl.qp <- summary(weighted_fl_abund.qp)
print(plot(weighted_fl_abund.qp, allTerms = TRUE), pages = 4)
check2D(weighted_fl_abund.qp, x1 = "yday", x2 = "elev.mean")

gers_fl_abund <- plot(sm(weighted_fl_abund.qp, 4))
hort_fl_abund <- plot(sm(weighted_fl_abund.qp, 5))
hypn_fl_abund <- plot(sm(weighted_fl_abund.qp, 6))
jone_fl_abund <- plot(sm(weighted_fl_abund.qp, 7))
lapi_fl_abund <- plot(sm(weighted_fl_abund.qp, 8))
mend_fl_abund <- plot(sm(weighted_fl_abund.qp, 9))
mont_fl_abund <- plot(sm(weighted_fl_abund.qp, 10))
muci_fl_abund <- plot(sm(weighted_fl_abund.qp, 11))
pasc_fl_abund <- plot(sm(weighted_fl_abund.qp, 12))
prat_fl_abund <- plot(sm(weighted_fl_abund.qp, 13))
psit_fl_abund <- plot(sm(weighted_fl_abund.qp, 14))
pyre_fl_abund <- plot(sm(weighted_fl_abund.qp, 15))
soro_fl_abund <- plot(sm(weighted_fl_abund.qp, 16))
telu_fl_abund <- plot(sm(weighted_fl_abund.qp, 17))
wurf_fl_abund <- plot(sm(weighted_fl_abund.qp, 18))

pdf("../output/gam_FL.pdf")
grid_plot_fl_abun <- gridPrint(gers_fl_abund + 
                                  l_fitRaster() + 
                                  l_fitContour() + 
                                  labs(title = "gers", x = NULL, y = NULL) +
                                  guides(fill=FALSE),
                               hort_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hort", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               hypn_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hypn", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               jone_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "jone", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               lapi_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "lapi", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mend_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mend", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mont_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mont", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               muci_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "muci", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pasc_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pasc", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               prat_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "prat", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               psit_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "psit", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pyre_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pyre", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               soro_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "soro", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               telu_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "telu", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               wurf_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "wurf", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               ncol = 4)
dev.off()
```

### 2.3.2 Bumble bee abundance
```{r message=FALSE}
# Zero-inflation may be an issue; a simple Poisson model is badly overdispersed
ggplot(bb_abund_sp, aes(bb.abund)) +
  geom_histogram() +
  facet_wrap(~bb.sp)

# Quasipoisson (winner)
bb_abund.qp <- bam(bb.abund ~ 
                     s(bb.sp.ord, bs = "re") + # center species
                     s(year, bs = "re") + # random intercept for year
                     s(site, bs = "re") + # random intercept to avoid pseudoreplicating elevation
                     te(yday, elev.mean, # tensor product smooth of elevation and time
                        by = bb.sp.ord, # by bb.sp
                        bs= c("gp", "tp"), # gaussian procees for time, thinplate spline for elevation
                        k=c(5, 5), 
                        m=2),
                   data = filter(bb_abund_sp, bb.sp != "humi"), # humi is just too rare
                   discrete = TRUE,
                   family = "quasipoisson",
                   select = TRUE,
                   method = "fREML") %>% getViz(nsim = 500)

check.gamViz(bb_abund.qp)
sum.qp <- summary(bb_abund.qp)
print(plot(bb_abund.qp, allTerms = TRUE), pages = 4)
check2D(bb_abund.qp, x1 = "yday", x2 = "elev.mean")

telu_abund <- plot(sm(bb_abund.qp, 4))
pasc_abund <- plot(sm(bb_abund.qp, 5))
prat_abund <- plot(sm(bb_abund.qp, 6))
soro_abund <- plot(sm(bb_abund.qp, 7))
wurf_abund <- plot(sm(bb_abund.qp, 8))
hort_abund <- plot(sm(bb_abund.qp, 9))
jone_abund <- plot(sm(bb_abund.qp, 10))
psit_abund <- plot(sm(bb_abund.qp, 11))
pyre_abund <- plot(sm(bb_abund.qp, 12))
mend_abund <- plot(sm(bb_abund.qp, 13))
mont_abund <- plot(sm(bb_abund.qp, 14))
gers_abund <- plot(sm(bb_abund.qp, 15))
muci_abund <- plot(sm(bb_abund.qp, 16))
hypn_abund <- plot(sm(bb_abund.qp, 17))
lapi_abund <- plot(sm(bb_abund.qp, 18))

pdf("../output/gam_BB.pdf")
grid_plot_fl_abun <- gridPrint(gers_abund + 
                                  l_fitRaster() + 
                                  l_fitContour() + 
                                  labs(title = "gers", x = NULL, y = NULL) +
                                  guides(fill=FALSE),
                               hort_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hort", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               hypn_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hypn", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               jone_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "jone", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               lapi_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "lapi", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mend_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mend", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mont_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mont", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               muci_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "muci", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pasc_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pasc", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               prat_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "prat", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               psit_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "psit", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pyre_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pyre", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               soro_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "soro", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               telu_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "telu", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               wurf_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "wurf", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               ncol = 4)
dev.off()
```


