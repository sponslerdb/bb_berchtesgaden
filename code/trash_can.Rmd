---
title: "trash can"
output: html_document
---

# Old stuff

### Abundance models
I'm choosing to use site as a random intercept effect in these models because I think that is the correct way to specify a model involving repeated observations (in this case, bumble bee species) within site. The effect of this decision is that the elevation smoother is less influenced by individual sites and converges more strongly toward the mean. This creates less exciting curves, but I think it is a more principled way to model the data and less prone to overfitting. I can have my cake and eat it too, though, by plotting the actual data over the GAM fit so that the strong patterns of certain sites are visible. Then I can talk about the conditional elevation effect and the importance of certain peaks that are likely to be idiosyncrasies of my system (i.e. it would be overfitting to call them elevation effects).

#### Bumble bees
```{r}
# Call model
gam_max_bb_abund_00 <- gam(max.bb.abund ~ 
                             s(bb.sp, bs = "re") +
                             s(bb.sp.year, bs = "re") + # fixed intercept for bb.sp:year
                             s(site, bs = "re") + # random intercept for site
                             s(elev.mean, by = bb.sp, k = 8), # smoother for elev by BB sp.
                           method = "REML",
                           family = "tw", # Tweedie distribution performs well
                           select = TRUE,
                           data = abund_sum) %>% getViz()

gam_max_bb_abund_00_ilink <- family(gam_max_bb_abund_00)$linkinv # get inverse link function

check.gamViz(gam_max_bb_abund_00) # evaluate model
gam_max_bb_abund_00_sum <- summary(gam_max_bb_abund_00) # summarize model
print(plot(gam_max_bb_abund_00, allTerms = TRUE), pages = 1) # preliminary visualization

# Plot smooths and year effect on the link scale
## Individual plots
gers_abund <- plot(sm(gam_max_bb_abund_00, 4)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "gers")
hort_abund <- plot(sm(gam_max_bb_abund_00, 5)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "hort")
jone_abund <- plot(sm(gam_max_bb_abund_00, 6)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "jone")
mend_abund <- plot(sm(gam_max_bb_abund_00, 7)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "mend")
mont_abund <- plot(sm(gam_max_bb_abund_00, 8)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "mont")
muci_abund <- plot(sm(gam_max_bb_abund_00, 9)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "muci")
pasc_abund <- plot(sm(gam_max_bb_abund_00, 10)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "pasc")
prat_abund <- plot(sm(gam_max_bb_abund_00, 11)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "prat")
psit_abund <- plot(sm(gam_max_bb_abund_00, 12)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "psit")
pyre_abund <- plot(sm(gam_max_bb_abund_00, 13)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "pyre")
soro_abund <- plot(sm(gam_max_bb_abund_00, 14)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "soro")
telu_abund <- plot(sm(gam_max_bb_abund_00, 15)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "telu")
wurf_abund <- plot(sm(gam_max_bb_abund_00, 16)) + l_fitLine() + l_ciLine() + 
  labs(x = "Elevation (m.s.l.)", y = "Peak abundance", title = "wurf")

## Arrange on grid plot
grid_bb_abund <- gridPrint(gers_abund, hort_abund, jone_abund, 
                           mend_abund, mont_abund, muci_abund, 
                           pasc_abund, prat_abund, psit_abund, 
                           pyre_abund, soro_abund, telu_abund, 
                           wurf_abund, year_effect)

pdf("../output/gam_max_bb_abund_grid.pdf")
plot(grid_bb_abund)
dev.off()

# Plot model predictions on response scale and add data as points
## Extract and prepare predictions
gam_max_bb_abund_00_pred <- predict.gam(gam_max_bb_abund_00, # get model predictions
                                        type = "terms") %>% 
  as.data.frame() %>% # convert to data frame
  as_tibble() %>% # convert to tibble
  select(sm.bb.sp = 1, sm.bb.sp.year = 2, sm.site = 3, gers = 4, # rename
         hort = 5, jone = 6, mend = 7, mont = 8, 
         muci = 9, pasc = 10, prat = 11, psit = 12, 
         pyre = 13, soro = 14, telu = 15, wurf = 16) %>%
  mutate(fit = # get cumulative fit and se, ignoring site effect 
           sm.bb.sp + sm.bb.sp.year + gers + 
           hort + jone + mend + mont + 
           muci + pasc + prat + psit + 
           pyre + soro + telu + wurf 
           ) %>%
  select(fit) %>%
  mutate(fit.trans = gam_max_bb_abund_00_ilink(fit)) %>%
  bind_cols(abund_sum)
  
## Plot
ggplot(gam_max_bb_abund_00_pred, aes(elev.mean, fit.trans, linetype = year)) +
  geom_line(size = 0.5, alpha = 0.5) +
  geom_point(aes(elev.mean, max.bb.abund, color = tree_line), inherit.aes = FALSE, alpha = 0.5) +
  facet_wrap(~bb.sp, scales = "free_y") +
  theme_light() +
  labs(x = "Elevation (m.s.l.)", 
       y = bquote("Peak abundance"),
       color = "Tree line",
       shape = "Year",
       linetype = "Year")

# ggplot(gam_max_bb_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
#   geom_rect(aes(xmin = 1620, # add rectangles to indicate above/below tree line
#                 xmax = 2050,
#                 ymin = -Inf,
#                 ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_rect(aes(xmin = 1530,
#                 xmax = 1570,
#                 ymin = -Inf,
#                 ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_line(size = 1.5, alpha = 0.5) +
#   geom_point(aes(elev.mean, max.bb.abund, color = year), inherit.aes = FALSE, alpha = 0.5) +
#   facet_wrap(~bb.sp, scales = "free_y") +
#   theme_light() +
#   labs(x = "Elevation (m.s.l.)", 
#        y = bquote("Peak abundance"),
#        color = "Year",
#        fill = "Year")

ggsave("../output/gam_max_bb_abund.pdf", width = 6.5, height = 4.5)
ggsave("../output/gam_max_bb_abund.png", width = 6.5, height = 4.5)

############### Let's see what happens without the site random effect

gam_max_bb_abund_01 <- gam(max.bb.abund ~ 
                             s(bb.sp, bs = "re") +
                             s(bb.sp.year, bs = "re") + # fixed intercept for bb.sp:year
                             s(elev.mean, by = bb.sp, k = 8), # smoother for elev by BB sp.
                           method = "REML",
                           family = "tw", # Tweedie distribution performs well
                           select = TRUE,
                           data = abund_sum) %>% getViz()

gam_max_bb_abund_01_ilink <- family(gam_max_bb_abund_01)$linkinv # get inverse link function

check.gamViz(gam_max_bb_abund_01) # evaluate model
gam_max_bb_abund_01_sum <- summary(gam_max_bb_abund_01) # summarize model
print(plot(gam_max_bb_abund_01, allTerms = TRUE), pages = 1) # preliminary visualization

gam_max_bb_abund_01_pred <- predict.gam(gam_max_bb_abund_01, # get model predictions
                                        type = "terms") %>% 
  as.data.frame() %>% # convert to data frame
  as_tibble() %>% # convert to tibble
  select(sm.bb.sp = 1, sm.bb.sp.year = 2, gers = 3, # rename
         hort = 4, jone = 5, mend = 6, mont = 7, 
         muci = 8, pasc = 9, prat = 10, psit = 11, 
         pyre = 12, soro = 13, telu = 14, wurf = 15) %>%
  mutate(fit = # get cumulative fit
           sm.bb.sp + sm.bb.sp.year + gers + 
           hort + jone + mend + mont + 
           muci + pasc + prat + psit + 
           pyre + soro + telu + wurf 
           ) %>%
  select(fit) %>%
  mutate(fit.trans = gam_max_bb_abund_01_ilink(fit)) %>%
  bind_cols(abund_sum)

ggplot(gam_max_bb_abund_01_pred, aes(elev.mean, fit.trans, linetype = year)) +
  geom_line(size = 0.5, alpha = 0.5) +
  geom_point(aes(elev.mean, max.bb.abund, color = tree_line), inherit.aes = FALSE, alpha = 0.5) +
  facet_wrap(~bb.sp, scales = "free_y") +
  theme_light() +
  labs(x = "Elevation (m.s.l.)", 
       y = bquote("Peak abundance"),
       color = "Tree line",
       shape = "Year",
       linetype = "Year")
```

#### Floral resources
```{r}
gam_mean_fl_abund_00 <- gam(mean.fl.abund ~ 
                             s(site, bs = "re") + # random intercept for site
                             s(elev.mean, year, bs = "fs", k = 8) +
                             s(elev.mean, bb.sp, bs = "fs", k = 8),
                           method = "REML",
                           family = "tw",
                           select = TRUE,
                           data = abund_sum) %>% getViz()

gam_mean_fl_abund_00_ilink <- family(gam_mean_fl_abund_00)$linkinv # get inverse link function

check.gamViz(gam_mean_fl_abund_00) # evaluate model
gam_mean_fl_abund_00_sum <- summary(gam_mean_fl_abund_00) # summarize model
print(plot(gam_mean_fl_abund_00, allTerms = TRUE), pages = 1) # preliminary visualization

# Plot on the link scale
elev_effect <- plot(sm(gam_mean_fl_abund_00, 2)) + 
  l_fitLine(alpha = 0.6, size = 1) + 
  labs(x = "Elevation (m.s.l.)", y = "NULL", color = "Year") +
  ylim(c(-2.1, 1))

bb.sp_effect <- plot(sm(gam_mean_fl_abund_00, 3)) +
  l_fitLine(alpha = 0.6, size = 1) + 
  labs(x = "Elevation (m.s.l.)", y = "NULL", color = "Species") +
  ylim(c(-2.1, 1))

grid_fl_abund <- gridPrint(elev_effect, bb.sp_effect, ncol = 2)

pdf("../output/gam_mean_fl_abund_grid.pdf", width = 7, height = 3.5)
plot(grid_fl_abund)
dev.off()

png("../output/gam_mean_fl_abund_grid.png", res = 300, units = "in", width = 7, height = 3.5)
plot(grid_fl_abund)
dev.off()

# Plot model predictions on response scale and add data as points
## Extract and prepare predictions
gam_mean_fl_abund_00_pred <- predict.gam(gam_mean_fl_abund_00, 
                                         type = "terms", 
                                         se.fit = TRUE) %>% # get model predictions and se
  as.data.frame() %>% # convert to data frame
  as_tibble() %>% # convert to tibble
  select(sm.site = 1, sm.year = 2, sm.bb.sp = 3, # rename
         se.site = 4, se.year = 5, se.bb.sp = 6) %>%
  mutate(fit = sm.year, # get fit and se ignoring site and species
         se = se.year) %>% 
  select(fit, se) %>%
  mutate(fit.plus = fit + se, # upper CI bound
         fit.min = fit - se, # lower CI bound
         fit.trans = gam_mean_fl_abund_00_ilink(fit), # apply inverse link function
         fit.plus.trans = gam_mean_fl_abund_00_ilink(fit.plus),
         fit.min.trans = gam_mean_fl_abund_00_ilink(fit.min)) %>%
  bind_cols(na.omit(abund_sum)) %>% # the na.omit() drops the rows where floral surveying data were missing
  select(fit.trans, fit.plus.trans, fit.min.trans, 
         se, elev.mean, year, mean.fl.abund, tree_line) %>%
  distinct()

# Plot
## Full data
full <- ggplot(gam_mean_fl_abund_00_pred, aes(elev.mean, fit.trans, linetype = year)) +
  geom_point(aes(elev.mean, mean.fl.abund, color = tree_line), inherit.aes = FALSE, alpha = 0.25) +
  geom_line(size = 1, alpha = 0.5) +
  theme_light() +
  labs(x = "Elevation (m.s.l.)", 
       y = bquote("Mean flower cover" ~ (m^2)),
       color = "Tree line",
       linetype = "Year") +
  theme(legend.position = "none")

# full <- ggplot(gam_mean_fl_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
#   geom_rect(aes(xmin = 1620, # add rectangles to indicate above/below tree line
#                 xmax = 2050,
#                 ymin = -Inf,
#                 ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_rect(aes(xmin = 1530,
#               xmax = 1570,
#               ymin = -Inf,
#               ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_line(size = 1.5, alpha = 0.5) +
#   geom_point(aes(elev.mean, mean.fl.abund, color = year), inherit.aes = FALSE, alpha = 0.5) +
#   theme_light() +
#   labs(x = "Elevation (m.s.l.)", 
#        y = bquote("Mean flower cover" ~ (m^2)),
#        color = "Year",
#        #shape = "Tree line",
#        fill = "Year") +
#   theme(legend.position = "none")

## Subset to better show elevation smooths
sub <- ggplot(gam_mean_fl_abund_00_pred, aes(elev.mean, fit.trans, linetype = year)) +
  geom_point(aes(elev.mean, mean.fl.abund, color = tree_line), inherit.aes = FALSE, alpha = 0.25) +
  geom_line(size = 1, alpha = 0.5) +
  theme_light() +
  labs(x = "Elevation (m.s.l.)", 
       y = NULL,
       color = "Tree line",
       linetype = "Year") +
  ylim(c(0, 10))

# sub <- ggplot(gam_mean_fl_abund_00_pred, aes(elev.mean, fit.trans, color = year)) +
#   geom_rect(aes(xmin = 1620, # add rectangles to indicate above/below tree line
#                 xmax = 2050,
#                 ymin = -Inf,
#                 ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_rect(aes(xmin = 1530,
#               xmax = 1570,
#               ymin = -Inf,
#               ymax = Inf), fill = 'gray80', alpha = 0.01, color = NA) +
#   geom_line(size = 1.5, alpha = 0.5) +
#   geom_point(aes(elev.mean, mean.fl.abund, color = year), inherit.aes = FALSE, alpha = 0.5) +
#   theme_light() +
#   labs(x = "Elevation (m.s.l.)", 
#        y = NULL,
#        color = "Year",
#        #shape = "Tree line",
#        fill = "Year") +
#   ylim(c(0, 10))

# Combine full and sub
fl_patchplot <- full | sub + plot_layout(guides = 'collect')

ggsave(plot = fl_patchplot, "../output/gam_mean_fl_abund_patchplot.pdf", width = 7, height = 4)
ggsave(plot = fl_patchplot, "../output/gam_mean_fl_abund_patchplot.png", width = 7, height = 4)


# A naive plot of floral abundance above vs. below the tree line
ggplot(abund_sum, aes(year, log(mean.fl.abund), color = tree_line)) +
  geom_boxplot() +
  theme_light() +
  labs(x = "Year", 
       y = bquote("Mean flower cover" ~ (m^2) ~ "(log-scale)"),
       color = "Tree line")


############### Let's see what happens without the site random effect
gam_mean_fl_abund_02 <- gam(mean.fl.abund ~
                              s(elev.mean, bb.sp, bs = "fs", k = 8) +
                              s(elev.mean, year, bs = "fs", k = 8),
                           method = "REML",
                           family = "tw",
                           select = TRUE,
                           data = abund_sum) %>% getViz()

check.gamViz(gam_mean_fl_abund_02) # evaluate model
gam_mean_fl_abund_02_sum <- summary(gam_mean_fl_abund_02) # summarize model
print(plot(gam_mean_fl_abund_02, allTerms = TRUE), pages = 1) # preliminary visualization
```

## Elevation x time analysis

### Floral abundance
```{r message=FALSE, warning=FALSE}
# First, let's model overall floral abundance without parsing it out by which species were visited by which bumble bee species
fl_abund_pool <- fl_abund_sp %>%
  group_by(site, date, year) %>%
  summarize(fl.abund = sum(fl.abund)) %>%
  mutate(site = factor(site),
         yday = yday(date)) %>%
  left_join(site_data)

ggplot(fl_abund_pool, aes(fl.abund)) +
  geom_histogram()
  
fl_abund.qp <- bam(fl.abund ~ 
                      s(site, bs = "re") +
                      s(year, bs = "re") +
                      te(yday, elev.mean,
                         bs = c("gp", "tp"),
                         k = c(8, 8)),
                    data = fl_abund_pool,
                    family = "quasipoisson",
                    discrete = TRUE,
                    select = TRUE,
                    method = "fREML") %>% getViz()

check.gamViz(fl_abund.qp)
summary(fl_abund.qp)
plot(fl_abund.qp)


# Now, by bumble bee species
weighted_fl_abund.qp <- bam(total.weighted.flower.cover ~ 
                              s(bb.sp, bs = "re") +
                              s(site, bs = "re") +
                              s(year, bs = "re") +
                              te(yday, elev.mean,
                                 by = bb.sp,
                                 bs = c("gp", "tp"),
                                 k = c(5, 5)),
                            data = filter(weighted_fl_abund, bb.sp != "humi"),
                            family = "quasipoisson",
                            discrete = TRUE,
                            select = TRUE,
                            method = "fREML") %>% getViz(nsim = 500)

check.gamViz(weighted_fl_abund.qp)
sum_fl.qp <- summary(weighted_fl_abund.qp)
print(plot(weighted_fl_abund.qp, allTerms = TRUE), pages = 4)
check2D(weighted_fl_abund.qp, x1 = "yday", x2 = "elev.mean")

gers_fl_abund <- plot(sm(weighted_fl_abund.qp, 4))
hort_fl_abund <- plot(sm(weighted_fl_abund.qp, 5))
hypn_fl_abund <- plot(sm(weighted_fl_abund.qp, 6))
jone_fl_abund <- plot(sm(weighted_fl_abund.qp, 7))
lapi_fl_abund <- plot(sm(weighted_fl_abund.qp, 8))
mend_fl_abund <- plot(sm(weighted_fl_abund.qp, 9))
mont_fl_abund <- plot(sm(weighted_fl_abund.qp, 10))
muci_fl_abund <- plot(sm(weighted_fl_abund.qp, 11))
pasc_fl_abund <- plot(sm(weighted_fl_abund.qp, 12))
prat_fl_abund <- plot(sm(weighted_fl_abund.qp, 13))
psit_fl_abund <- plot(sm(weighted_fl_abund.qp, 14))
pyre_fl_abund <- plot(sm(weighted_fl_abund.qp, 15))
soro_fl_abund <- plot(sm(weighted_fl_abund.qp, 16))
telu_fl_abund <- plot(sm(weighted_fl_abund.qp, 17))
wurf_fl_abund <- plot(sm(weighted_fl_abund.qp, 18))

pdf("../output/gam_FL.pdf")
grid_plot_fl_abun <- gridPrint(gers_fl_abund + 
                                  l_fitRaster() + 
                                  l_fitContour() + 
                                  labs(title = "gers", x = NULL, y = NULL) +
                                  guides(fill=FALSE),
                               hort_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hort", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               hypn_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hypn", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               jone_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "jone", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               lapi_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "lapi", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mend_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mend", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mont_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mont", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               muci_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "muci", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pasc_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pasc", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               prat_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "prat", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               psit_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "psit", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pyre_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pyre", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               soro_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "soro", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               telu_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "telu", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               wurf_fl_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "wurf", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               ncol = 4)
dev.off()
```

### Bumble bee abundance
```{r message=FALSE}
# Zero-inflation may be an issue; a simple Poisson model is badly overdispersed
ggplot(bb_abund_sp, aes(bb.abund)) +
  geom_histogram() +
  facet_wrap(~bb.sp)

# Quasipoisson (winner)
bb_abund.qp <- bam(bb.abund ~ 
                     s(bb.sp.ord, bs = "re") + # center species
                     s(year, bs = "re") + # random intercept for year
                     s(site, bs = "re") + # random intercept to avoid pseudoreplicating elevation
                     te(yday, elev.mean, # tensor product smooth of elevation and time
                        by = bb.sp.ord, # by bb.sp
                        bs= c("gp", "tp"), # gaussian procees for time, thinplate spline for elevation
                        k=c(5, 5), 
                        m=2),
                   data = filter(bb_abund_sp, bb.sp != "humi"), # humi is just too rare
                   discrete = TRUE,
                   family = "quasipoisson",
                   select = TRUE,
                   method = "fREML") %>% getViz(nsim = 500)

check.gamViz(bb_abund.qp)
sum.qp <- summary(bb_abund.qp)
print(plot(bb_abund.qp, allTerms = TRUE), pages = 4)
check2D(bb_abund.qp, x1 = "yday", x2 = "elev.mean")

telu_abund <- plot(sm(bb_abund.qp, 4))
pasc_abund <- plot(sm(bb_abund.qp, 5))
prat_abund <- plot(sm(bb_abund.qp, 6))
soro_abund <- plot(sm(bb_abund.qp, 7))
wurf_abund <- plot(sm(bb_abund.qp, 8))
hort_abund <- plot(sm(bb_abund.qp, 9))
jone_abund <- plot(sm(bb_abund.qp, 10))
psit_abund <- plot(sm(bb_abund.qp, 11))
pyre_abund <- plot(sm(bb_abund.qp, 12))
mend_abund <- plot(sm(bb_abund.qp, 13))
mont_abund <- plot(sm(bb_abund.qp, 14))
gers_abund <- plot(sm(bb_abund.qp, 15))
muci_abund <- plot(sm(bb_abund.qp, 16))
hypn_abund <- plot(sm(bb_abund.qp, 17))
lapi_abund <- plot(sm(bb_abund.qp, 18))

pdf("../output/gam_BB.pdf")
grid_plot_fl_abun <- gridPrint(gers_abund + 
                                  l_fitRaster() + 
                                  l_fitContour() + 
                                  labs(title = "gers", x = NULL, y = NULL) +
                                  guides(fill=FALSE),
                               hort_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hort", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               hypn_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "hypn", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               jone_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "jone", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               lapi_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "lapi", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mend_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mend", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               mont_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "mont", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               muci_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "muci", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pasc_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pasc", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               prat_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "prat", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               psit_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "psit", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               pyre_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "pyre", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               soro_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "soro", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               telu_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "telu", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               wurf_abund + 
                                 l_fitRaster() + 
                                 l_fitContour() + 
                                 labs(title = "wurf", x = NULL, y = NULL) +
                                 guides(fill=FALSE),
                               ncol = 4)
dev.off()
```



-------------------------------------
# Old


## 3.6 Genus-level niche overlap ~ tongue.pair + elevation
### 3.6.1 Model
```{r}
niche_gam10 <- gam(mean.niche.overlap ~
                     tongue.pair +
                     s(elev.mean, by = tongue.pair, k = 8, m = 2),
                   method = "REML",
                   family = betar(eps = 0.001),
                   select = TRUE,
                   data = niche_overlap_tongues) %>% getViz()

check.gamViz(niche_gam10)
summary(niche_gam10)
print(plot(niche_gam10, allTerms = TRUE), pages = 1)
```

### 3.6.2 Visualize
```{r}
# Get predictions using tidymv
niche_gam10_pred <- get_gam_predictions(niche_gam10, elev.mean) %>%
  as_tibble() %>%
  mutate(mean.niche.overlap_trans = inv_logit_scaled(mean.niche.overlap),
         CI_upper_trans = inv_logit_scaled(CI_upper),
         CI_lower_trans = inv_logit_scaled(CI_lower))

# Plot smooths
ggplot(niche_gam10_pred, aes(elev.mean, mean.niche.overlap_trans, color = tongue.pair)) +
  geom_ribbon(aes(elev.mean, mean.niche.overlap_trans,
                  ymax = CI_upper_trans, ymin = CI_lower_trans,
                  fill = tongue.pair),
              alpha = 0.3, inherit.aes = FALSE) +
  geom_line() +
  ylab("Niche overlap") +
  xlab("Elevation") +
  theme_light()

ggsave(file = "../output/niche_gam10_plot1.pdf", width = 5, height = 4)
ggsave(file = "../output/niche_gam10_plot1.png", width = 5, height = 4)
```


### 3.5.1 Model
```{r}
brm_niche00 <- brm(niche.overlap ~ 1 +
                     level + # fixed effect of level 
                     (1 | site) + # varying intercept for site
                     (1 | sp.pair), # varying intercept for sp.pair
                   family = "zero_one_inflated_beta", # for prop data with 0s and 1s
                   file = "../output/brm_niche_00", # local
                   #file = "./brm_niche_00", # HPC
                   iter = 2000,
                   chains = 4,
                   data = niche_pool)

pp_check(brm_niche00)
bayes_R2(brm_niche00)

get_variables(brm_niche00)
conditional_effects(brm_niche00)
mcmc_plot(brm_niche00, pars = c("^r_sp.pair\\[mend*"))
mcmc_plot(brm_niche00, pars = c("^r_site*"))
```

### 3.5.2 Vizualize
```{r}
brm_niche00_plotframe1 <- brm_niche00 %>%
  spread_draws(b_Intercept, b_levelgenus, b_levelmorphotype) %>%
  mutate(b_levelgenus = b_Intercept + b_levelgenus,
         b_levelmorphotype = b_Intercept + b_levelmorphotype) %>%
  pivot_longer(-c(.chain, .iteration, .draw), names_to = "level", values_to = "value") %>%
  group_by(level) %>%
  point_interval(value, .width = c(0.95, 0.66)) %>% # calculate credible intervals
  mutate(value_trans = inv_logit_scaled(value), # exponentiating the estimates gets us back to the response scale (negbinomial uses log link function)
         .lower_trans = inv_logit_scaled(.lower),
         .upper_trans = inv_logit_scaled(.upper)) %>%
  mutate(level = case_when(
    level == "b_Intercept" ~ "family",
    level == "b_levelmorphotype" ~ "morphotype",
    level == "b_levelgenus" ~ "genus"
  )) %>%
  mutate(level = factor(level, levels = c("genus", "family", "morphotype")))

ggplot(brm_niche00_plotframe1, aes(value_trans, level, 
                                 xmin = .lower_trans, xmax = .upper_trans)) +
  geom_pointinterval() +
  theme_light(12) +
  labs(x = "Niche overlap", y= "Level") +
  guides(fill = FALSE) +
  scale_x_continuous(breaks = seq(0.25, 0.5, by = 0.05))

ggsave(file = "../output/brm_niche00_plot1.pdf", width = 4.5, height = 4)
ggsave(file = "../output/brm_niche00_plot1.png", width = 4.5, height = 4)
```

## 3.6 Genus niche overlap ~ tongue
### 3.6.1 Model
```{r}
brm_niche10 <- brm(niche.overlap ~ 1 +
                     (1 | site) + # varying intercept for site
                     (1 | tongue.pair) +
                     (1 | sp.pair), # varying intercept for sp.pair
                   family = "zero_one_inflated_beta", # for prop data with 0s and 1s
                   file = "../output/brm_niche_10", # local
                   #file = "./brm_niche_10", # HPC
                   iter = 2000,
                   chains = 4,
                   data = filter(niche_pool, level == "genus"))

pp_check(brm_niche10)
bayes_R2(brm_niche10)

get_variables(brm_niche10)
mcmc_plot(brm_niche10, pars = c("^r_tongue*"))
mcmc_plot(brm_niche10, pars = c("^r_site*"))
```

### 3.6.2 Vizualize
```{r}
brm_niche10_plotframe1 <- brm_niche10 %>%
  spread_draws(b_Intercept, r_tongue.pair[condition, term]) %>%
  mutate(condition_mean = b_Intercept + r_tongue.pair) %>%
  group_by(condition) %>% # group by tongue:morpotype pair
  point_interval(condition_mean, .width = c(0.95, 0.66)) %>% # calculate credible intervals
  mutate(condition_mean_trans = inv_logit_scaled(condition_mean), # exponentiating the estimates gets us back to the response scale (negbinomial uses log link function)
         .lower_trans = inv_logit_scaled(.lower),
         .upper_trans = inv_logit_scaled(.upper)) %>%
  mutate(condition = factor(condition, levels = c("short:short", "med:med", "long:long",
                                          "short:med", "short:long", "med:long")))

ggplot(brm_niche10_plotframe1, aes(condition_mean_trans, condition, 
                                 xmin = .lower_trans, xmax = .upper_trans)) +
  geom_pointinterval() +
  theme_light(12) +
  labs(x = "Niche overlap", y= "Tongue pair") +
  guides(fill = FALSE)

ggsave(file = "../output/brm_niche10_plot1.pdf", width = 4.5, height = 4)
ggsave(file = "../output/brm_niche10_plot1.png", width = 4.5, height = 4)
```

## 3.7 Genus niche overlap ~ sp.pair
### 3.7.1 Model
```{r eval=FALSE, include=FALSE}
brm_niche20 <- brm(niche.overlap ~ 1 +
                     (1 | site) + # varying intercept for site
                     (1 | sp.pair), # varying intercept for sp.pair
                   family = "zero_one_inflated_beta", # for prop data with 0s and 1s
                   file = "../output/brm_niche_20", # local
                   #file = "./brm_niche_20", # HPC
                   iter = 2000,
                   chains = 4,
                   data = filter(niche_overlap, level == "genus"))

pp_check(brm_niche20)
bayes_R2(brm_niche20)

get_variables(brm_niche20)
conditional_effects(brm_niche20)
mcmc_plot(brm_niche20, pars = c("^r_sp.pair"))
mcmc_plot(brm_niche20, pars = c("^r_site*"))
```

### 3.7.2 Visualize
```{r eval=FALSE, include=FALSE}
brm_niche20_plotframe1 <- brm_niche20 %>%
  spread_draws(b_Intercept, r_sp.pair[condition, term]) %>%
  mutate(condition_mean = b_Intercept + r_sp.pair) %>%
  group_by(condition) %>% # group by tongue:morpotype pair
  point_interval(condition_mean, .width = c(0.95, 0.66)) %>% # calculate credible intervals
  mutate(condition_mean_trans = inv_logit_scaled(condition_mean), # exponentiating the estimates gets us back to the response scale (negbinomial uses log link function)
         .lower_trans = inv_logit_scaled(.lower),
         .upper_trans = inv_logit_scaled(.upper)) %>%
  mutate(condition = factor(condition)) %>%
  left_join(niche_pool, by = c("condition" = "sp.pair")) %>%
  select(condition, condition_mean_trans, .lower_trans, .upper_trans, tongue.pair) %>%
  distinct() %>%
  mutate(tongue.pair = factor(tongue.pair, levels = c("short:short", "med:med", "long:long",
                                                      "short:med", "short:long", "med:long")))

ggplot(brm_niche20_plotframe1, aes(condition_mean_trans, condition, 
                                 xmin = .lower_trans, xmax = .upper_trans)) +
  geom_pointinterval() +
  theme_light(11) +
  labs(x = "Niche overlap", y= "Tongue pair") +
  guides(fill = FALSE) +
 # facet_wrap(~tongue.pair, ncol = 1, scales = "free_y") +
  facet_wrap(~tongue.pair, scales = "free_y")

ggsave(file = "../output/brm_niche20_plot1.pdf", width = 4.5, height = 4)
ggsave(file = "../output/brm_niche20_plot1.png", width = 7, height = 10)
```

## 3.8 Niche overlap ~ elevation
### 3.8.1 Models
```{r}
ggplot(niche_overlap_sppair, aes(elev.mean, mean.niche.overlap, color = sp.pair)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  facet_wrap(~sp.pair) +
  ylim(c(0,1))

ggplot(filter(niche_overlap_sppair, 
              sp1 %in% c("pasc", "prat", "soro", "telu", "wurf") & 
                sp2 %in% c("pasc", "prat", "soro", "telu", "wurf")), 
       aes(elev.mean, mean.niche.overlap, color = sp.pair)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  facet_wrap(~sp.pair) +
  ylim(c(0,1))

ggplot(filter(niche_overlap_sppair, 
              sp1 %in% c("pasc", "prat", "soro", "telu", "wurf",
                         "mont", "muci", "pyre", "mend", "gers") & 
                sp2 %in% c("pasc", "prat", "soro", "telu", "wurf",
                           "mont", "muci", "pyre", "mend", "gers")), 
       aes(elev.mean, mean.niche.overlap, color = sp.pair)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  facet_wrap(~sp.pair) +
  ylim(c(0,1))

ggplot(filter(niche_overlap_sppair,
              sp1 %in% c("pasc", "prat", "soro", "telu", "wurf") | 
                sp2 %in% c("pasc", "prat", "soro", "telu", "wurf")), 
       aes(elev.mean, mean.niche.overlap, color = sp.pair)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), se = FALSE) +
  facet_wrap(~sp.pair) +
  ylim(c(0,1))

# Pairwise
gen_gam_niche.I <- bam(mean.niche.overlap ~
                            s(sp.pair, bs = "re") +
                            s(site, bs = "re") + # since I have measures repeated over species pairs within each elevation level
                            s(elev.mean, by = sp.pair, k = 8, m = 2),
                          method = "fREML",
                          family = betar(eps = 0.001),
                          discrete = TRUE,
                          select = TRUE,
                          data = filter(niche_overlap_sppair, level == "genus" &
                                          sp1 %in% c("pasc", "prat", "soro", "telu", "wurf", # dominant species
                                                        "mont", "muci", "pyre", "mend") & # high elevation specialists
                                          sp2 %in% c("pasc", "prat", "soro", "telu", "wurf",
                                                        "mont", "muci", "pyre", "mend"))) %>% getViz() 

check.gamViz(gen_gam_niche.I)
summary(gen_gam_niche.I)
plot(sm(gen_gam_niche.I, 1))
plot(sm(gen_gam_niche.I, 11))
plot(sm(gen_gam_niche.I, 28))
plot(sm(gen_gam_niche.I, 33))
plot(sm(gen_gam_niche.I, 37))

# Community mean
ggplot(niche_pool_sitemean, aes(elev.mean, mean.niche.overlap, color = level)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 8))

```