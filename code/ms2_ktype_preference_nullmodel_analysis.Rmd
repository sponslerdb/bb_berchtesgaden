---
title: "visitation_bias"
author: "Doug Sponsler"
date: "12/14/2020"
output: html_document
---
# Preparations
## Packages 
```{r, warning=FALSE, include=FALSE, echo = FALSE}
library(econullnetr)
library(patchwork)
library(mgcv)
library(mgcViz)
library(tidymv)
library(tidyverse)
library(lubridate)
library(broom)
library(vegan)
library(ggvegan)
library(ggrepel)
```

## Load data
```{r message=FALSE, warning=FALSE, include=FALSE, echo = FALSE}
prop_visits_ktype <- read_csv("../data/processed_data/prop_visits_ktype.csv") %>%
  mutate(ktype = factor(ktype), # recode variables
         tongue = factor(tongue),
         visits = as.integer(visits))
 
prop_visits_ktype_pooled <- read_csv("../data/processed_data/prop_visits_ktype_pool.csv") %>%
  mutate(ktype = factor(ktype), # recode variables
         visits = as.integer(visits))

bb_traits <- read_csv("../data/processed_data/bb_traits.csv") %>%
  select(bb.sp, pbl.w, tongue = pbl.w.class2)

site_data <- read_csv("../data/processed_data/site_data.csv") %>%
  dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean, elev.class, elev.class2)) %>% 
  mutate(site = factor(site),
         tree_line = factor(tree_line))

# For setting up the HPC
# prop_visits_ktype <- read_csv("./prop_visits_ktype.csv") %>%
#   mutate(ktype = factor(ktype), # recode variables
#          tongue = factor(tongue),
#          visits = as.integer(visits))
# 
# prop_visits_ktype_pooled <- read_csv("./prop_visits_ktype_pool.csv") %>%
#   mutate(ktype = factor(ktype), # recode variables
#          visits = as.integer(visits))
# 
# bb_traits <- read_csv("./bb_traits.csv") %>%
#   select(bb.sp, pbl.w, tongue = pbl.w.class2)
# 
# site_data <- read_csv("./site_data.csv") %>%
#   dplyr::select(-c(slope.calc, slope.est, elev.min, elev.max, temp.mean, elev.class, elev.class2)) %>%
#   mutate(site = factor(site),
#          tree_line = factor(tree_line))
```

# Get number of presences by date and site-date for each species

In null model 1, the calculation of total Observed vs. Null-predicted visitation involves the summing of observed and null-predicted visitation across the sampling unit of site-date. This causes the absolute values of total preference (totalObserved - totalNull) to vary with the number of site-dates that were summed, which inflates the absolute value of preference in abundant species relative to rare species. By dividing each species' preferences by the nuber of site-dates in which it was observed, we can standardize preference as per-site-date totalObserved - totalNull, which gets all species on a comparable scale and enables comparisons of preference across ktype or in response to tongue length to be meaningful. 

Similarly, in null model 2, the calculation of preference involves summing across the sampling unit of date within site, and we cna standardize preference by dividing by the number of dates each species was observed at each site.
```{r}
# Site-date presences for null model 1
site_date_presences <- prop_visits_ktype %>%
  unite(sitedate, site, date) %>%
  group_by(bb.sp) %>%
  summarize(presences = length(unique(sitedate)))

# Date presences for null model 2
date_presences <- prop_visits_ktype %>%
  group_by(site, bb.sp) %>%
  summarize(presences = length(unique(date))) 
```

# 1. Null model 1: bb.sp x ktype, fully pooled
```{r}
# The "consumers" table input to generate_null_net()
con <- prop_visits_ktype %>%
  unite(id, c(site, date)) %>%
  select(id, bb.sp, ktype, prop.visits) %>%
  pivot_wider(values_from = prop.visits, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9"))

# The "resources" table input to generate_null_net()
res <- prop_visits_ktype %>%
  unite(id, c(site, date)) %>%
  select(id, ktype, perc.flower.cover) %>%
  distinct() %>%
  pivot_wider(values_from = perc.flower.cover, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9")) 

# Generate null model
null1 <- generate_null_net(consumers = con[, 2:9],
                           resources = res[, 2:8],
                           sims = 1000, # raised from default of 100 (takes a while to run)
                           data.type = "quantities", # since we are using proportional visitation
                           c.samples = con[, 1], # parsed by sample
                           r.samples = res[, 1])

#saveRDS(null1, file = "./null1.rds")
null1 <- readRDS("../output/null1.rds")

# Tabulate output and generate tests
null_tab1 <- test_interactions(null1, signif.level = 0.99) %>% # make it a bit more conservative to account for multiple comparisons
  as_tibble() %>%
  select(bb.sp = Consumer, ktype = Resource, everything()) %>%
  group_by(bb.sp) %>%
  mutate(preference = Observed - Null, # a working definition of preference
         preference.upper99 = Observed - Upper.99.CL, 
         preference.lower99 = Observed - Lower.99.CL) %>%
  left_join(bb_traits) %>%
  ungroup() %>%
  left_join(site_date_presences) %>%
  mutate(preference.std = preference/presences, # standardize preference
         observed.std = Observed/presences, # standardize visitation
         lower99.std = Lower.99.CL/presences, # standardize confidence intervals
         upper99.std = Upper.99.CL/presences) %>% 
  mutate(bb.sp = fct_reorder(factor(bb.sp), pbl.w))
```
## 1.1 Standardized observed vs. null predictions
```{r}
# Species-wise
ggplot(null_tab1, aes(observed.std, ktype)) +
  geom_segment(aes(y = ktype, yend = ktype, 
                   x = lower99.std, xend = upper99.std), 
               color = "gray40", inherit.aes = FALSE) +
  geom_point(aes(color = Test)) +
  facet_wrap(~bb.sp) +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  labs(x = "Standardized visits", y = "Floral morphotype", color = "Test (p < 0.01)") +
  theme_light()

ggsave("../output/null_model_spwise_preference.pdf", height = 6, width = 7)
ggsave("../output/null_model_spwise_preference.png", height = 6, width = 7)

## Morphotype-wise
ggplot(null_tab1, aes(observed.std, bb.sp)) +
  geom_segment(aes(y = bb.sp, yend = bb.sp, 
                   x = lower99.std, xend = upper99.std), 
               color = "gray40", inherit.aes = FALSE) +
  geom_point(aes(color = Test)) +
  facet_wrap(~ktype, ncol = 4) +
  scale_y_discrete(limits = rev) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  labs(x = "Standardized visits", y = "Bumble bee species", color = "Test (p < 0.01)") +
  theme_light()

ggsave("../output/null_model_ktypewise_preference.pdf", height = 5, width = 7)
ggsave("../output/null_model_ktypewise_preference.png", height = 5, width = 7)
```

## 1.2 Standardized preference by morphotype
```{r}
ggplot(null_tab1, aes(ktype, preference.std)) +
  #geom_violin(fill = "gray70", color = "white", draw_quantiles = c(0.25, 0.5, 0.75)) +
  geom_boxplot(fill = NA, color = "black", outlier.shape = 4, size = 0.35) +
  geom_jitter(aes(color = Test), width = 0.3, alpha = 0.6) +
  theme_light(14) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  labs(x = "Floral morphotype", 
       y = "Standardized preference")

ggsave("../output/null_model_ktype_preference.pdf", height = 6, width = 7)
ggsave("../output/null_model_ktype_preference.png", height = 6, width = 7)
```

## 1.3 Standardized preference by morphotype ~ tongue length
### 1.3.1 Preliminary visualization
```{r}
# Standardized preference ~ morphotype * tongue length
ggplot(null_tab1, aes(pbl.w, preference.std)) +
  geom_point(aes(color = Test)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4)) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  facet_wrap(~ktype) +
  labs(x = "Tongue length (mm)", y = "Standardized preference", 
       color = "Test (p < 0.01)") +
  theme_light()
```

### 1.3.2 Model
```{r}
gam1 <- gam(preference.std ~ 
              ktype + 
              s(pbl.w, by = ktype, k = 5), 
            data = null_tab1) %>% getViz()

summary(gam1)
check.gamViz(gam1)
plot.gamViz(gam1, allTerms = TRUE)

# Extract predictions
gam1_pred <- predict_gam(gam1) %>%
  mutate(fit.plus.se = fit + (2*se.fit),
         fit.minus.se = fit - (2*se.fit)) 

# Plot
ggplot(gam1_pred, aes(pbl.w, fit)) +
  geom_line() + # fit line
  geom_ribbon(aes(ymin = fit.minus.se, ymax = fit.plus.se), # Uncertainty
              fill = "black", alpha = 0.2) +
  geom_point(data = null_tab1, # Original data
             aes(pbl.w, preference.std, color = Test), 
             inherit.aes = FALSE) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  facet_wrap(~ktype) +
  labs(x = "Tongue length (mm)", y = "Standardized preference", 
       color = "Test (p < 0.01)") +
  theme_light()

ggsave("../output/null_model_ktypeXtonguelength_preference.pdf", height = 6, width = 7)
ggsave("../output/null_model_ktypeXtonguelength_preference.png", height = 6, width = 7)
```


## 1.4 Aggregate similarity of preferences and visitation across species

### 1.4.1 Calculate similarities
```{r}
# Standardized preference matrix
null1_prefs <- null_tab1 %>%
  select(bb.sp, ktype, preference.std) %>%
  pivot_wider(names_from = ktype, values_from = preference.std) %>%
  column_to_rownames("bb.sp")

# Standardized total visitation matrix
null1_visits <- null_tab1 %>%
  select(bb.sp, ktype, observed.std) %>%
  pivot_wider(names_from = ktype, values_from = observed.std) %>%
  column_to_rownames("bb.sp")

# Preference similarity
null1_prefs_diff <- vegdist(prefs, method = "euclidean") %>% # most metrics don't work when matrix includes negative numbers
  broom::tidy() %>%
  select(bb.sp1 = 1, bb.sp2 = 2, distance) %>%
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>%
  select(bb.sp1, bb.sp2, distance, pbl.w1 = pbl.w) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>%
  select(bb.sp1, bb.sp2, distance, pbl.w1, pbl.w2 = pbl.w) %>%
  mutate(tongue.diff = abs(pbl.w1 - pbl.w2),
         preference.similarity = 1 - distance) %>%
  select(-distance)

# Visitation similarity
null1_visits_diff <- vegdist(null1_visits, method = "horn") %>%
  broom::tidy() %>%
  select(bb.sp1 = 1, bb.sp2 = 2, distance) %>%
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>%
  select(bb.sp1, bb.sp2, distance, pbl.w1 = pbl.w) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>%
  select(bb.sp1, bb.sp2, distance, pbl.w1, pbl.w2 = pbl.w) %>%
  mutate(tongue.diff = abs(pbl.w1 - pbl.w2),
         diet.similarity = 1 - distance) %>%
  select(-distance)

null1_visits_prefs <- full_join(null1_prefs_diff, null1_visits_diff)
```

### 1.4.2 How well does preference similarity predict (ktype-level) visitation similarity?
Two interesting questions:
1. Doe the relationship deviate from 1:1?
2. How wide is the spread and is the relationship heteroskedastic? The wider the spread, the more visitation is affected by relative abundance. The tighter the spread, the more visitation is determined by selection bias independent of relative abundance.
```{r}

ggplot(null1_visits_prefs, aes(preference.similarity, diet.similarity)) +
  geom_point() +
  geom_smooth() +
  geom_abline(slope = 1, color = "black", linetype = "dashed") +
  theme_light()
```

### 1.4.3 How well does tongue length difference predict preference similarity?
```{r}
ggplot(null1_visits_prefs, aes(tongue.diff, preference.similarity)) +
  geom_point() +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4))
```

### 1.4.4 Ordinate preferences
```{r}
# Call PCA
pca_pref <- rda(prefs)

# Extract tongue length data
tongues <- bb_traits %>%
  semi_join(null_tab1) %>%
  arrange(bb.sp)

# Ordisurf on tongue length
ordisurf_pref <- ordisurf(pca_pref, tongues$pbl.w) 
summary(ordisurf_pref)

# Get variance explained
pcoa_pref_pc1 <- round(pca_pref$CA$eig[[1]] / sum(pca_pref$CA$eig)*100)
pcoa_pref_pc2 <- round(pca_pref$CA$eig[[2]] / sum(pca_pref$CA$eig)*100)

# Fortify whole model
pca_pref.fort <- fortify(pca_pref, axes = 1:2) 

# Fortify plants
pca_pref.fort1 <- fortify(pca_pref, axes = 1:2) %>%
  filter(Score == "species") %>%
  rename(ktype = Label) 

# Fortify bees
pca_pref.fort2 <- fortify(pca_pref, axes = 1:2) %>%
  filter(Score == "sites") %>%
  rename(bb.sp = Label) %>%
  left_join(bb_traits)


# Plot ordisurf

## Plotting function based on https://oliviarata.wordpress.com/2014/07/17/ordinations-in-ggplot2-v2-ordisurf/
surfplot <- function(x, y, min_score = 0) {
  
  grid <- x$grid # extracts the ordisurf object
  grid_exp <- expand.grid(x = grid$x, y = grid$y) # get x and ys
  grid_exp$z <- as.vector(grid$z) # unravel the matrix for the z scores
  
  contours <- data.frame(na.omit(grid_exp)) %>% # gets rid of the nas
    as_tibble() %>%
    rename(PC1 = x, PC2 = y)
  
  scores <- y %>% 
    filter((abs(PC1) > min_score | abs(PC2) > min_score) | Score == "BB.sp") %>%
    mutate(max.score = max(PC1, PC2))
  
  ggplot(scores, aes(PC1, PC2, pch = Score)) +
    geom_contour(data = contours, 
                 aes(PC1, PC2, z = z, color = stat(level)),
                 size = 2, alpha = 0.35, inherit.aes = FALSE) +
    #geom_point(size = 2) +
    geom_text_repel(aes(PC1, PC2, label = Label), key_glyph = "rect") +
    theme_light() +
    scale_color_viridis_c(name = "Tongue length") +
    xlab(paste("PC1 ", "(", pcoa_pref_pc1, "%", ")", sep = "")) +
    ylab(paste("PC2 ", "(", pcoa_pref_pc2, "%", ")", sep = "")) +
    coord_fixed() # Gavin Simpson says this is **really** important
}

## Plot
surfplot(ordisurf_pref, pca_pref.fort)
```


# 2. Null model 2: bb.sp x ktype, by site
```{r}
# Nest and join consumer and resource data frames
con_nest <- prop_visits_ktype %>%
  select(site, date, bb.sp, ktype, prop.visits) %>%
  pivot_wider(values_from = prop.visits, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9")) %>%
  group_by(site) %>%
  nest() %>%
  rename(bees = data)

res_nest <- prop_visits_ktype %>%
  select(site, date, ktype, perc.flower.cover) %>%
  distinct() %>%
  pivot_wider(values_from = perc.flower.cover, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9")) %>%
  group_by(site) %>%
  nest() %>%
  rename(plants = data)

conres <- full_join(con_nest, res_nest)

# Create a big beautiful table of data and models (run on HPC!)
null2 <- conres %>%

  # Generate null models
  mutate(null.model = map2(bees, plants, function(x, y)
    generate_null_net(consumers = x[, 2:9],
                      resources = y[, 2:8],
                      sims = 1000, # raised from default of 100
                      data.type = "quantities",
                      c.samples = x[, 1],
                      r.samples = y[, 1])))

# write_rds(null2, "../output/nullmodel_ktype_sitewise.rds")
# write_rds(null2, "./null2.rds") # hpc
null2 <- readRDS("../output/null2.rds")

# Tabulate results (with test)
null_tab2 <- null2 %>%
  mutate(null.model.tab = map(null.model, function(x)
    test_interactions(x, signif.level = 0.99) %>%
      as_tibble() %>%
      mutate(preference = Observed - Null,
             preference.upper99 = Observed - Upper.99.CL,
             preference.lower99 = Observed - Lower.99.CL) %>%
      select(bb.sp = Consumer, ktype = Resource, everything()))) %>%

  # Unnest and add site data and bumble bee trait data
  unnest(null.model.tab) %>%
  select(site, bb.sp, ktype, Observed, Null, Lower.99.CL, Upper.99.CL, Test, 
         SES, preference, preference.upper99, preference.lower99) %>%
  left_join(site_data) %>%
  left_join(bb_traits) %>%
  group_by(site, bb.sp) %>%
  mutate(total.observed = sum(Observed)) %>%
  filter(total.observed > 0) %>% # for each species, drop sites where the species did not occur
  unite(bb.ktype, c(bb.sp, ktype), remove = FALSE) %>%
  mutate(ktype = factor(ktype),
         bb.sp = factor(bb.sp),
         bb.ktype = factor(bb.ktype)) %>%
  left_join(date_presences) %>%
  mutate(preference.std = preference/presences, # standardize preference
         observed.std = Observed/presences, # standardize visitation
         lower99.std = Lower.99.CL/presences, # standardize confidence intervals
         upper.99.std = Upper.99.CL/presences) %>% 
  mutate(bb.sp = factor(bb.sp, levels = c("jone", "pyre", "soro", "psit", # order by ascending tongue length
                                          "telu", "lapi", "prat", "mont",
                                          "wurf", "muci", "pasc", "hypn",
                                          "mend", "hort", "gers")))
```

## 2.1 Lability of preference: Do BB species preferences for morphotypes vary with elevation?
### 2.1.1 Preliminary visualization
```{r}
ggplot(null_tab2, aes(elev.mean, preference.std)) +
  geom_point(aes(color = Test)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), color = "black") +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  facet_grid(bb.sp ~ ktype, scales = "free") +
  theme_light()

ggplot(null_tab2, aes(elev.mean, preference.std)) +
  geom_point(aes(color = Test)) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 4), color = "black") +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  facet_grid(ktype ~ bb.sp) +
  theme_light()
```
### 2.1.2 Model
```{r}
gam2 <- bam(preference.std ~
              s(bb.ktype, bs = "re") +
              s(elev.mean, by = bb.ktype, k = 4),
            method = "fREML",
            discrete = TRUE,
            select = TRUE,
            data = null_tab2) %>% getViz()

print(plot.gamViz(gam2, allTerms = TRUE), pages = 6)
check.gamViz(gam2)
summary(gam2)

# Extract significant smooths
gam2_sig_smooths <- tidy(gam2) %>%
  filter(p.value < 0.05 & term != "s(bb.ktype)") %>%
  mutate(bb.ktype = str_extract(term, ".{6}$")) %>%
  select(bb.ktype)
  
# Extract predictions
gam2_pred <- predict_gam(gam_bb.ktype) %>%
  mutate(fit.plus.se = fit + (2*se.fit),
         fit.minus.se = fit - (2*se.fit)) %>%
  semi_join(gam2_sig_smooths) %>%
  separate(bb.ktype, c("bb.sp", "ktype"))

# Grab relevant subset of original data
null_tab2_sub <- null_tab2 %>%
  semi_join(gam2_sig_smooths)

# Plot
ggplot(gam2_pred, aes(elev.mean, fit)) +
  geom_line() + # fit line
  geom_point(data = null_tab2_sub, # Original data
             aes(elev.mean, preference.std, color = Test),
             inherit.aes = FALSE) +
  geom_ribbon(aes(ymin = fit.minus.se, ymax = fit.plus.se), # Uncertainty
              fill = "black", alpha = 0.2) +
  scale_color_manual(values = c("gray40", "#F8766D", "#00B6EB")) +
  facet_grid(bb.sp ~ ktype, scales = "free") +
  labs(x = "Elevation (m.s.l.)", y = "Standardized preference",
       color = "Test (p < 0.01)") +
  theme_light()
```

## 2.2 Diet similarity vs. preference similarity
```{r}
# Bring in niche overlap data generate in a different script
diet_sim_sitewise <- read_csv("../output/niche_overlap.csv") %>%
  select(site, bb.sp1, bb.sp2, diet.similarity = niche.overlap, level) 

# Function for generating a tidy preference-difference data frame
pref_proc <- function(x) {
  x %>%
    pivot_wider(names_from = ktype, values_from = preference.std) %>%
    column_to_rownames("bb.sp") %>%
    vegdist(method = "euclidean") %>%
    broom::tidy() %>%
    select(bb.sp1 = 1, bb.sp2 = 2, distance)
}

# Preference similarity  
pref_sim_sitewise <- null_tab2 %>%
  select(site, bb.sp, ktype, preference.std) %>%
  group_by(site) %>%
  nest() %>%
  mutate(pdif = map(data, pref_proc)) %>%
  unnest(pdif) %>%
  left_join(bb_traits, by = c("bb.sp1" = "bb.sp")) %>%
  select(site, bb.sp1, bb.sp2, distance, pbl.w1 = pbl.w) %>%
  left_join(bb_traits, by = c("bb.sp2" = "bb.sp")) %>%
  select(site, bb.sp1, bb.sp2, distance, pbl.w1, pbl.w2 = pbl.w) %>%
  mutate(tongue.diff = abs(pbl.w1 - pbl.w2)) %>%
  ungroup() %>%
  mutate(distance.std = distance/max(distance), # standardize relative to most distant pair
         pref.similarity = 1-distance.std, # make positive (0,1)
         pref.similarity2 = distance*(-1)) # alternatively

# Join diet and preference similarity
diet_pref_sitewise <- full_join(pref_sim_sitewise, diet_sim_sitewise) %>%
  left_join(site_data) %>%
  unite(sp.pair, c(bb.sp1, bb.sp2), remove = FALSE) %>%
  mutate(sp.pair = factor(sp.pair)) %>%
  filter(!is.na(pref.similarity)) # the data set that was used to generate the niche overlap data includes slightly more data than the one used to generate the preference data due to a filtering step during the alignment of visitation data to floral. Only 10 rows are missing, so the difference is trivial. We can just drop the resulting NAs. 

# How well does preference similarity predict diet similarity (and the levels of morphotype, family, and genus)? 
ggplot(diet_pref_sitewise, aes(pref.similarity, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))

ggplot(diet_pref_sitewise, aes(pref.similarity, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  facet_wrap(~site)


# How well does tongue length difference predict preference similarity?
ggplot(diet_preference, aes(tongue.diff, pref.similarity)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))

ggplot(diet_preference, aes(tongue.diff, pref.similarity)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  facet_wrap(~site)

# How well does tongue length difference predict diet similarity?
ggplot(diet_preference, aes(tongue.diff, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))

ggplot(diet_preference, aes(tongue.diff, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial")) +
  facet_wrap(~site)

# Preference similarity by elevation
ggplot(diet_pref_sitewise, aes(elev.mean, pref.similarity)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))

ggplot(diet_pref_sitewise, aes(elev.mean, pref.similarity)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5))

# Diet similarity by elevation
ggplot(diet_pref_sitewise, aes(elev.mean, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"))

ggplot(diet_pref_sitewise, aes(elev.mean, diet.similarity, color = level)) +
  geom_point(alpha = 0.25) +
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5))

# Model
gam3 <- bam(pref.similarity ~ 
              s(sp.pair, bs = "re") +
              s(elev.mean, k = 8),
            family = betar(eps = 0.01),
            method = "fREML",
            discrete = TRUE,
            select = TRUE,
            data = diet_pref_sitewise) %>% getViz()

check.gamViz(gam3)
summary(gam3)
plot.gamViz(gam3)

gam4 <- bam(pref.similarity ~ 
              #s(sp.pair, bs = "re") +
              s(elev.mean,sp.pair, k = 5, bs = "fs"),
            family = betar(eps = 0.01),
            method = "fREML",
            discrete = TRUE,
            select = TRUE,
            data = diet_pref_sitewise) %>% getViz()

check.gamViz(gam4)
summary(gam4)
plot.gamViz(gam4)
```

# 3. Null model 3: bb.sp x ktype, by site-date
```{r}
# Nest and join consumer and resource data frames

# For HPC
library(tidyverse)
library(econullnetr)
prop+visits_ktype <- read_csv("./prop_visits_ktype.csv")

con_nest2 <- prop_visits_ktype %>%
  select(site, date, bb.sp, ktype, prop.visits) %>%
  pivot_wider(values_from = prop.visits, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9")) %>%
  group_by(site, date) %>%
  nest() %>%
  rename(bees = data)

res_nest2 <- prop_visits_ktype %>%
  select(site, date, ktype, perc.flower.cover) %>%
  distinct() %>%
  pivot_wider(values_from = perc.flower.cover, names_from = ktype, values_fill = 0) %>%
  select(-c("0", "10", "9")) %>%
  group_by(site, date) %>%
  nest() %>%
  rename(plants = data)

conres2 <- full_join(con_nest2, res_nest2)

# Create a big beautiful table of data and models (run on HPC!)
# This will probably take 8 hours to run
null3 <- conres2 %>%

  # Generate null models
  mutate(null.model = map2(bees, plants, function(x, y)
    generate_null_net(consumers = x[, 1:8],
                      resources = y[, 1:7],
                      sims = 1000, # raised from default of 100
                      data.type = "quantities",
                      prog.count = TRUE)))
write_rds(null3, "./null3.rds") # hpc
null3 <- readRDS("../output/null3.rds")

# Tabulate results (with test)
null_tab3 <- null3 %>%
  mutate(null.model.tab = map(null.model, function(x)
    test_interactions(x, signif.level = 0.99) %>%
      as_tibble() %>%
      mutate(preference = Observed - Null,
             preference.upper99 = Observed - Upper.99.CL,
             preference.lower99 = Observed - Lower.99.CL) %>%
      select(bb.sp = Consumer, ktype = Resource, everything()))) %>%

  # Unnest and add site data and bumble bee trait data
  unnest(null.model.tab) %>%
  select(site, date, bb.sp, ktype, Observed, Null, Lower.99.CL, Upper.99.CL, Test, 
         SES, preference, preference.upper99, preference.lower99) %>%
  left_join(site_data) %>%
  left_join(bb_traits) %>%
  group_by(site, date, bb.sp) %>%
  mutate(total.observed = sum(Observed)) %>%
  filter(total.observed > 0) %>% # for each species, drop sites where the species did not occur
  filter(Observed != 0 | Null != 0) %>% # when both equal zero, it's probably because the ktype had zero abundance; in any case, it's meaningless to retain these, and they just cause zero-inflation
  ungroup() %>%
  unite(bb.ktype, c(bb.sp, ktype), remove = FALSE) %>%
  mutate(ktype = factor(ktype),
         site = factor(site),
         yday = yday(date),
         year = factor(year(date)),
         bb.ktype = factor(bb.ktype),
         bb.sp = factor(bb.sp, levels = c("jone", "pyre", "soro", "psit", # order by ascending tongue length
                                          "telu", "lapi", "prat", "mont",
                                          "wurf", "muci", "pasc", "hypn",
                                          "mend", "hort", "gers")))

gam3 <- bam(preference ~
              bb.ktype +
              s(site, by = bb.ktype, bs = "re") +
              s(year, by = bb.ktype, bs = "re") +
              te(yday, elev.mean, by = bb.ktype),
            family = "gaussian",
            method = "fREML",
            discrete = TRUE,
            data = filter(null_tab3, 
                          bb.sp %in% c("pasc", "prat", "telu", 
                                       "wurf", "soro", "hort") &
                            ktype %in% c("3", "5", "6", "7"))) %>% 
              getViz()

check.gamViz(gam3)
gam3_sum <- summary(gam3)
plot.gamViz(gam3, allTerms = TRUE)

hort_3 <- plot(sm(gam3, 49)) + 
  labs(y = NULL, x = NULL) + 
  theme(legend.position = "top") + 
  theme_void(20)
  
hort_5 <- plot(sm(gam3, 50)) + labs(y = NULL, x = NULL) + theme_void(20)
hort_6 <- plot(sm(gam3, 51)) + labs(y = NULL, x = NULL) + theme_void(20)
hort_7 <- plot(sm(gam3, 52)) + labs(y = NULL, x = NULL) + theme_void(20)

pasc_3 <- plot(sm(gam3, 53)) + labs(y = NULL, x = NULL) + theme_void(20)
pasc_5 <- plot(sm(gam3, 54)) + labs(y = NULL, x = NULL) + theme_void(20)
pasc_6 <- plot(sm(gam3, 55)) + labs(y = NULL, x = NULL) + theme_void(20)
pasc_7 <- plot(sm(gam3, 56)) + labs(y = NULL, x = NULL) + theme_void(20)

prat_3 <- plot(sm(gam3, 57)) + labs(y = NULL, x = NULL) + theme_void(20)
prat_5 <- plot(sm(gam3, 58)) + labs(y = NULL, x = NULL) + theme_void(20)
prat_6 <- plot(sm(gam3, 59)) + labs(y = NULL, x = NULL) + theme_void(20)
prat_7 <- plot(sm(gam3, 60)) + labs(y = NULL, x = NULL) + theme_void(20)

soro_3 <- plot(sm(gam3, 61)) + labs(y = NULL, x = NULL) + theme_void(20)
soro_5 <- plot(sm(gam3, 62)) + labs(y = NULL, x = NULL) + theme_void(20)
soro_6 <- plot(sm(gam3, 63)) + labs(y = NULL, x = NULL) + theme_void(20)
soro_7 <- plot(sm(gam3, 64)) + labs(y = NULL, x = NULL) + theme_void(20)

telu_3 <- plot(sm(gam3, 65)) + labs(y = NULL, x = NULL) + theme_void(20)
telu_5 <- plot(sm(gam3, 66)) + labs(y = NULL, x = NULL) + theme_void(20)
telu_6 <- plot(sm(gam3, 67)) + labs(y = NULL, x = NULL) + theme_void(20)
telu_7 <- plot(sm(gam3, 68)) + labs(y = NULL, x = NULL) + theme_void(20)

wurf_3 <- plot(sm(gam3, 69)) + labs(y = NULL, x = NULL) + theme_void(20)
wurf_5 <- plot(sm(gam3, 70)) + labs(y = NULL, x = NULL) + theme_void(20)
wurf_6 <- plot(sm(gam3, 71)) + labs(y = NULL, x = NULL) + theme_void(20)
wurf_7 <- plot(sm(gam3, 72)) + labs(y = NULL, x = NULL) + theme_void(20)


pdf("../output/gam3_figures/hort_3.pdf") 
hort_3 
dev.off()

pdf("../output/gam3_figures/hort_5.pdf") 
hort_5 
dev.off()

pdf("../output/gam3_figures/hort_6.pdf") 
hort_6 
dev.off()

pdf("../output/gam3_figures/hort_7.pdf") 
hort_7 
dev.off()


pdf("../output/gam3_figures/pasc_3.pdf") 
pasc_3 
dev.off()

pdf("../output/gam3_figures/pasc_5.pdf") 
pasc_5 
dev.off()

pdf("../output/gam3_figures/pasc_6.pdf") 
pasc_6 
dev.off()

pdf("../output/gam3_figures/pasc_7.pdf") 
pasc_7 
dev.off()


pdf("../output/gam3_figures/prat_3.pdf") 
prat_3 
dev.off()

pdf("../output/gam3_figures/prat_5.pdf") 
prat_5 
dev.off()

pdf("../output/gam3_figures/prat_6.pdf") 
prat_6 
dev.off()

pdf("../output/gam3_figures/prat_7.pdf") 
prat_7 
dev.off()


pdf("../output/gam3_figures/soro_3.pdf") 
soro_3 
dev.off()

pdf("../output/gam3_figures/soro_5.pdf") 
soro_5 
dev.off()

pdf("../output/gam3_figures/soro_6.pdf") 
soro_6 
dev.off()

pdf("../output/gam3_figures/soro_7.pdf") 
soro_7 
dev.off()


pdf("../output/gam3_figures/telu_3.pdf") 
telu_3 
dev.off()

pdf("../output/gam3_figures/telu_5.pdf") 
telu_5 
dev.off()

pdf("../output/gam3_figures/telu_6.pdf") 
telu_6 
dev.off()

pdf("../output/gam3_figures/telu_7.pdf") 
telu_7 
dev.off()


pdf("../output/gam3_figures/wurf_3.pdf") 
wurf_3 
dev.off()

pdf("../output/gam3_figures/wurf_5.pdf") 
wurf_5 
dev.off()

pdf("../output/gam3_figures/wurf_6.pdf") 
wurf_6 
dev.off()

pdf("../output/gam3_figures/wurf_7.pdf") 
wurf_7 
dev.off()
```